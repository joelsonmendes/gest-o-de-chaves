<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Chaves ‚Äî SENAIHUB</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* =======================================
            ESTILOS BASE (DARK MODE)
            ======================================= */
        body {
            background: #121212;
            color: #fff;
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }
        
        /* Estilos para a tela de login */
        #loginScreen .form-control {
            background: #222 !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }

        #loginScreen .form-control:focus {
            border-color: #fd790d !important;
            box-shadow: 0 0 0 0.2rem rgba(253, 121, 13, 0.25) !important;
        }

        #loginScreen .alert {
            background: #dc3545;
            color: white;
            border: none;
        }

        #loginScreen .text-info {
            color: #17a2b8 !important;
            text-decoration: none;
        }

        #loginScreen .text-info:hover {
            color: #138496 !important;
            text-decoration: underline;
        }
        
        .content-wrapper {
            margin-left: 250px; /* Margem padr√£o para desktop */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .content {
            padding: 16px;
            flex-grow: 1;
        }
        .card {
            background: #1e1e1e;
            border: 1px solid #333;
            color: #fff;
        }
        input, select, textarea {
            background: #222 !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        input::placeholder {
            color: #aaa !important;
        }
        .btn-custom {
            background: #fd790d;
            border: none;
            color: #fff;
        }
        .btn-custom:hover {
            background: #48f005;
            color: #fff;
        }
        .qr-box canvas {
            display: block;
            margin: 15px auto 0;
            width: 200px !important;
            height: 200px !important;
        }
        .table > :not(caption) > * > * {
            background-color: #1e1e1e;
            color: #fff;
            padding: 0.6rem 0.6rem; /* <-- Diminui o espa√ßamento interno das c√©lulas */
        }

        /* =======================================
            SIDEBAR (BARRA LATERAL)
            ======================================= */
        .sidebar {
            height: 100vh;
            background: #1f1f1f;
            padding-top: 20px;
            position: fixed;
            width: 250px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar .logo-container {
            padding: 0 15px 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        .sidebar .logo-container img {
            /* Usando o nome do arquivo da sua imagem retangular (192x192) */
            max-width: 100%;
            height: auto;
            max-height: 60px;
        }
        .sidebar a {
            color: #999898;
            padding: 15px 20px;
            display: block;
            transition: 0.2s;
            font-size: 17px;
            text-decoration: none;
        }
        .sidebar a:hover, .activeMenu {
            background: #333;
            color: #fff !important;
        }
        
        /* √Årea do usu√°rio no sidebar */
        .user-area {
            margin-top: auto;
            border-top: 1px solid #333;
            padding: 15px 20px;
            background: #1a1a1a;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #fd790d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        /* =======================================
            TELA DE LOGIN
            ======================================= */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #121212 0%, #1a1a1a 100%);
        }
        
        .login-card {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo img {
            max-width: 150px;
            height: auto;
        }
        
        .login-title {
            text-align: center;
            color: #fff;
            margin-bottom: 5px;
            font-weight: 300;
        }
        
        .login-subtitle {
            text-align: center;
            color: #999;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        .login-error {
            background: #dc3545;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .login-divider {
            text-align: center;
            margin: 20px 0;
            color: #666;
            position: relative;
        }
        
        .login-divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #333;
        }
        
        .login-divider span {
            background: #1e1e1e;
            padding: 0 15px;
            position: relative;
        }

        /* =======================================
            FOOTER (RODAP√â)
            ======================================= */
        .footer {
            background: #1f1f1f;
            color: #ccc;
            text-align: center;
            padding: 15px 20px;
            font-size: 0.9em;
            border-top: 1px solid #333;
            margin-top: auto;
        }

        /* =======================================
            RESPONSIVIDADE (SMARTPHONE/TABLET)
            ======================================= */
        @media (max-width: 768px) {
            /* SIDEBAR: Vira um cabe√ßalho horizontal e rol√°vel */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative; 
                padding-top: 10px;
                flex-direction: row; 
                overflow-x: auto; 
                white-space: nowrap; 
                border-bottom: 1px solid #333;
            }

            /* Links do menu em linha */
            .sidebar a {
                display: inline-block;
                padding: 10px 15px;
                font-size: 15px;
            }

            /* Logo ocupa a largura total acima dos links */
            .sidebar .logo-container {
                display: block;
                text-align: center;
                width: 100%;
                border-bottom: none;
                margin-bottom: 5px;
            }

            /* CONTE√öDO: Remove a margem fixa */
            .content-wrapper {
                margin-left: 0;
                padding-top: 10px;
            }
            
            /* Ajustes para a √°rea do usu√°rio em mobile */
            .user-area {
                display: none; /* Oculta em mobile para economizar espa√ßo */
            }
        }

        /* =======================================
            ESTILOS ADICIONAIS
            ======================================= */
        .scanner-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .scanner-active {
            background: #1a331a;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        .scanner-paused {
            background: #332b1a;
            color: #FF9800;
            border: 1px solid #FF9800;
        }
        .status-disponivel {
            color: #4CAF50;
        }
        .status-retirada {
            color: #f44336;
        }
        .offline-indicator {
            background: #ff4444;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .online-indicator {
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .sync-status {
            background: #ff9800;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .pending-sync {
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .qr-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        .report-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .report-card:hover {
            transform: translateY(-5px);
            border-color: #fd790d;
        }
        .voice-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }
        .voice-active {
            background: #1a331a;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        .voice-inactive {
            background: #332b1a;
            color: #FF9800;
            border: 1px solid #FF9800;
        }
    </style>
</head>

<body>

<!-- =======================================
    TELA DE LOGIN
    ======================================= -->
<div id="loginScreen" class="login-container">
    <div class="login-card">
        <div class="login-logo">
            <img src="logo.png" alt="SENAIHUB Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjYwIiB2aWV3Qm94PSIwIDAgMTUwIDYwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iNjAiIGZpbGw9IiNGRjc5MEQiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSI+U0VOQUlIVUI8L3RleHQ+PC9zdmc+';">
        </div>
        
        <h2 class="login-title">Gest√£o de Chaves SENAIHUB</h2>
        <p class="login-subtitle">Fa√ßa login para acessar o sistema</p>
        
        <div id="loginError" class="login-error"></div>
        <div id="loginMessage" class="login-error" style="background: #ff9800; display: none;"></div>
        
        <!-- Formul√°rio de Login -->
        <form id="loginForm" onsubmit="login(event)">
            <div class="mb-3">
                <label for="loginEmail" class="form-label text-white">Email</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="seu@email.com" required>
            </div>
            
            <div class="mb-3">
                <label for="loginPassword" class="form-label text-white">Senha</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Sua senha" required>
                <div class="form-text text-muted">
                    <a href="#" onclick="showPasswordReset()" class="text-info" style="font-size: 0.9em;">Esqueceu a senha?</a>
                </div>
            </div>
            
            <button type="submit" class="btn btn-custom w-100 mb-3" id="btnLogin">
                <i class="fa fa-sign-in-alt"></i> Entrar
            </button>
            
            <div class="login-divider">
                <span>ou</span>
            </div>
            
            <div class="text-center">
                <a href="#" onclick="showRegister()" class="text-info">Criar nova conta</a>
            </div>
        </form>
        
        <!-- Formul√°rio de Registro -->
        <form id="registerForm" onsubmit="register(event)" style="display: none;">
            <div class="mb-3">
                <label for="registerName" class="form-label text-white">Nome completo</label>
                <input type="text" id="registerName" class="form-control" placeholder="Seu nome" required>
            </div>
            
            <div class="mb-3">
                <label for="registerEmail" class="form-label text-white">Email</label>
                <input type="email" id="registerEmail" class="form-control" placeholder="seu@email.com" required>
            </div>
            
            <div class="mb-3">
                <label for="registerPassword" class="form-label text-white">Senha (m√≠nimo 6 caracteres)</label>
                <input type="password" id="registerPassword" class="form-control" placeholder="Sua senha" minlength="6" required>
            </div>
            
            <div class="mb-3">
                <label for="registerConfirmPassword" class="form-label text-white">Confirmar senha</label>
                <input type="password" id="registerConfirmPassword" class="form-control" placeholder="Confirme a senha" required>
            </div>
            
            <button type="submit" class="btn btn-success w-100 mb-3" id="btnRegister">
                <i class="fa fa-user-plus"></i> Criar conta
            </button>
            
            <div class="text-center">
                <a href="#" onclick="showLogin()" class="text-info">Voltar para login</a>
            </div>
        </form>
        
        <!-- Formul√°rio de Recupera√ß√£o de Senha -->
        <form id="resetPasswordForm" onsubmit="resetPassword(event)" style="display: none;">
            <div class="mb-3">
                <label for="resetEmail" class="form-label text-white">Email</label>
                <input type="email" id="resetEmail" class="form-control" placeholder="seu@email.com" required>
                <div class="form-text text-muted">
                    Enviaremos um link para redefinir sua senha.
                </div>
            </div>
            
            <button type="submit" class="btn btn-warning w-100 mb-3" id="btnResetPassword">
                <i class="fa fa-envelope"></i> Enviar link de recupera√ß√£o
            </button>
            
            <div class="text-center">
                <a href="#" onclick="showLogin()" class="text-info">Voltar para login</a>
            </div>
        </form>
    </div>
</div>

<!-- =======================================
    CONTE√öDO PRINCIPAL (AP√ìS LOGIN)
    ======================================= -->
<div id="appContent" style="display: none; flex-direction: column; min-height: 100vh;">

<div class="sidebar">
    <div class="logo-container">
       <img src="logo.png" alt="SENAIHUB Logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjYwIiB2aWV3Qm94PSIwIDAgMTUwIDYwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxNTAiIGhlaWdodD0iNjAiIGZpbGw9IiNGRjc5MEQiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSI+U0VOQUlIVUI8L3RleHQ+PC9zdmc+';">
    </div>
    <a href="#" onclick="showPage('home', event)" class="activeMenu"><i class="fa fa-home"></i> Home</a>
    <a href="#" onclick="showPage('chaves', event)"><i class="fa fa-key"></i> Chaves</a>
    <a href="#" onclick="showPage('colaboradores', event)"><i class="fa fa-users"></i> Colaboradores</a>
    <a href="#" onclick="showPage('qr-codes', event)"><i class="fa fa-qrcode"></i> Todos QR Codes</a>
    <a href="#" onclick="showPage('historico', event)"><i class="fa fa-clock-rotate-left"></i> Hist√≥rico</a>
    <a href="#" onclick="showPage('qr', event)"><i class="fa fa-camera"></i> Retirar por QR Code</a>
    <a href="#" onclick="showPage('relatorios', event)"><i class="fa fa-chart-bar"></i> Relat√≥rios</a>
    <a href="#" onclick="showPage('offline', event)"><i class="fa fa-cloud"></i> Dados Offline</a>
    
    <!-- √Årea do Usu√°rio -->
    <div class="user-area">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">
                U
            </div>
            <div>
                <div class="text-white small" id="userName">Usu√°rio</div>
                <div class="text-muted x-small" id="userEmailDisplay">email@exemplo.com</div>
            </div>
        </div>
        <a href="#" onclick="logout()" class="text-danger" style="display: block; text-align: center;">
            <i class="fa fa-sign-out-alt"></i> Sair
        </a>
    </div>
</div>

<div class="content-wrapper"> 
    <div class="content">

        <!-- Indicadores de Status de Conex√£o -->
        <div id="onlineIndicator" class="online-indicator">
            <i class="fa fa-wifi"></i> Conectado - Dados sincronizados
        </div>
        <div id="offlineIndicator" class="offline-indicator">
            <i class="fa fa-wifi-slash"></i> Modo Offline - Dados ser√£o sincronizados quando a conex√£o voltar
        </div>
        <div id="syncStatus" class="sync-status">
            <i class="fa fa-refresh fa-spin"></i> Sincronizando dados pendentes...
        </div>

        <section id="home">
            <h1 class="mb-4">üîë Sistema de Gest√£o de Chaves</h1>
            <p class="text-muted">Bem-vindo, <span id="welcomeUser">Usu√°rio</span>!</p>
            <hr/>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-key text-info"></i> Chaves</h3>
                        <p class="mb-0">Total Registradas: <span id="totalChaves" class="fw-bold">0</span></p>
                        <p class="mb-0">Dispon√≠veis: <span id="chavesDisponiveis" class="fw-bold">0</span></p>
                        <p class="mb-0">Retiradas: <span id="chavesRetiradas" class="fw-bold">0</span></p>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-users text-warning"></i> Colaboradores</h3>
                        <p>Total: <span id="totalCol" class="fw-bold">0</span></p>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-clock-rotate-left text-success"></i> Hist√≥rico</h3>
                        <p>Total: <span id="totalHist" class="fw-bold">0</span></p>
                        <p class="mb-0">Pendentes: <span id="pendentesSync" class="fw-bold text-warning">0</span></p>
                    </div>
                </div>
            </div>
        </section>

        <section id="chaves" style="display:none;">
            <h2><i class="fa fa-key text-info"></i> Gest√£o de Chaves</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Cadastrar Chave</h4>
                <input id="nomeChave" placeholder="Nome da chave (Ex: Sala 101)" class="form-control mt-2">
                <button class="btn btn-custom mt-2" onclick="cadastrarChave()">
                    <i class="fa fa-plus"></i> Cadastrar e Gerar QR Code
                </button>

                <div id="qrCodeArea" class="qr-box text-center mt-3"></div>
            </div>

            <div class="card p-3 mt-4">
                <h4>Buscar Chaves</h4>
                <input id="buscaChaves" class="form-control" placeholder="Pesquisar por ID ou nome..." onkeyup="filtrarChaves()">
            </div>

            <div class="card mt-3 p-3">
                <h4>Lista de Chaves</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaChaves"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="colaboradores" style="display:none;">
            <h2><i class="fa fa-users text-warning"></i> Gest√£o de Colaboradores</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Cadastrar Colaborador</h4>
                <input id="nomeColaborador" placeholder="Nome do colaborador" class="form-control mt-2">
                <button class="btn btn-custom mt-3" onclick="cadastrarColaborador()">
                    <i class="fa fa-user-plus"></i> Cadastrar
                </button>
                <p class="mt-3 mb-0"><b>√öltimo ID gerado:</b> <span id="ultimoColID" class="fw-bold">Nenhum</span></p>
            </div>

            <div class="card mt-4 p-4">
                <h4>Lista de Colaboradores</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaColaboradores"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="qr-codes" style="display:none;">
            <h2><i class="fa fa-qrcode text-info"></i> Todos os QR Codes das Chaves</h2>
            <hr/>
            
            <div class="card p-4">
                <h4>QR Codes para Impress√£o</h4>
                <p class="text-muted">Todos os QR codes das chaves cadastradas no sistema. Clique em "Baixar" para salvar individualmente.</p>
                
                <div class="mb-3">
                    <button class="btn btn-success" onclick="baixarTodosQRCodes()">
                        <i class="fa fa-download"></i> Baixar Todos os QR Codes (ZIP)
                    </button>
                    <button class="btn btn-info ms-2" onclick="imprimirQRCodes()">
                        <i class="fa fa-print"></i> Imprimir Todos
                    </button>
                </div>
                
                <div id="qrCodesContainer" class="qr-grid">
                    <!-- Os QR Codes ser√£o gerados aqui -->
                </div>
            </div>
        </section>

        <section id="historico" style="display:none;">
            <h2><i class="fa fa-clock-rotate-left text-success"></i> Hist√≥rico de Movimenta√ß√µes</h2>
            <hr/>

            <div class="card p-3 mb-4">
                <h4>Relat√≥rios</h4>
                <button class="btn btn-success mt-2" onclick="gerarRelatorioHistorico()">
                    <i class="fa fa-download"></i> Baixar Relat√≥rio Completo (CSV)
                </button>
                <button class="btn btn-warning mt-2 ms-2" onclick="sincronizarDadosPendentes()">
                    <i class="fa fa-refresh"></i> Sincronizar Dados Pendentes
                </button>
            </div>

            <div class="card mt-3 p-3">
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Chave (ID)</th>
                                <th>Colaborador</th>
                                <th>A√ß√£o</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Usu√°rio</th>
                            </tr>
                        </thead>
                        <tbody id="listaHistorico"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="qr" style="display:none;">
            <h2><i class="fa fa-qrcode text-info"></i> Retirada por QR Code</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Escanear QR Code da Chave</h4>
                
                <!-- Controle do Leitor de C√≥digo de Barras -->
                <div class="card p-3 mb-3 leitor-section">
                    <h5><i id="iconeLeitor" class="fa fa-barcode text-muted"></i> Leitor de C√≥digo de Barras LB-W110BK</h5>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Status:</strong> 
                                <span id="statusLeitor" class="badge bg-danger">Desconectado</span>
                            </p>
                            <small class="text-muted">Modo: Emula√ß√£o de Teclado</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="btnToggleLeitor" class="btn btn-success btn-sm" onclick="toggleLeitor()">
                                <i class="fa fa-plug"></i> Conectar Leitor
                            </button>
                            <button class="btn btn-info btn-sm ms-2" onclick="testarLeitor()">
                                <i class="fa fa-test"></i> Testar
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fa fa-info-circle"></i> 
                            Conecte o leitor via USB e clique em "Conectar Leitor". O leitor funciona automaticamente como um teclado.
                        </small>
                    </div>
                </div>

                <!-- Controle de Voz -->
                <div class="card p-3 mb-3 voice-control-section">
                    <h5><i id="iconeVoz" class="fa fa-microphone text-muted"></i> Assistente de Voz</h5>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Status:</strong> 
                                <span id="statusVoz" class="badge bg-danger">Inativo</span>
                            </p>
                            <small class="text-muted">Reconhecimento de voz para ID do colaborador</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="btnToggleVoz" class="btn btn-success btn-sm" onclick="toggleReconhecimentoVoz()">
                                <i class="fa fa-microphone"></i> Ativar Voz
                            </button>
                            <button class="btn btn-info btn-sm ms-2" onclick="testarVoz()">
                                <i class="fa fa-test"></i> Testar Voz
                            </button>
                        </div>
                    </div>
                    
                    <div id="voiceStatus" class="voice-status voice-inactive" style="display: none;">
                        <i class="fa fa-microphone"></i> Aguardando comando de voz...
                    </div>
                    
                    <div class="voice-instruction">
                        <strong>Instru√ß√µes:</strong> Ap√≥s escanear o QR Code da chave, o sistema perguntar√° "Qual o ID do colaborador?". 
                        Responda com o n√∫mero do ID (exemplo: "zero um" para ID 01).
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fa fa-info-circle"></i> 
                            O reconhecimento de voz funciona melhor com fones de ouvido e em ambiente silencioso.
                        </small>
                    </div>
                </div>

                <!-- Status do Scanner de C√¢mera -->
                <div id="scannerStatus" class="scanner-status scanner-active" style="display: none;">
                    <i class="fa fa-camera"></i> Scanner de c√¢mera ativo
                </div>
                
                <div id="reader" style="width:300px; margin: 0 auto;"></div>

                <div class="mt-3 text-center">
                    <button id="btnToggleScanner" class="btn btn-outline-warning btn-sm" onclick="toggleScanner()" style="display: none;">
                        <i class="fa fa-pause"></i> Pausar Scanner C√¢mera
                    </button>
                </div>

                <p class="mt-3"><b>Chave detectada:</b> <span id="chaveDetectada" class="fw-bold text-info">Nenhuma</span></p>

                <div id="areaConfirmacao" style="display:none;">
                    <div class="input-group">
                        <input id="idColRetirada" placeholder="ID do colaborador (use o leitor ou voz)" class="form-control">
                        <button class="btn btn-outline-secondary" type="button" onclick="testarLeitor()">
                            <i class="fa fa-barcode"></i> Testar Leitor
                        </button>
                        <button class="btn btn-outline-info" type="button" onclick="iniciarReconhecimentoVoz()">
                            <i class="fa fa-microphone"></i> Voz
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">
                        Aponte o leitor para o c√≥digo de barras do ID do colaborador OU use o comando de voz
                    </small>
                    
                    <div class="mt-3">
                        <button id="btnConfirmarRetirada" class="btn btn-success w-100" onclick="confirmarRetirada()">
                            <i class="fa fa-check"></i> Confirmar Retirada
                        </button>
                        <button id="btnDevolverChave" class="btn btn-primary w-100 mt-2" onclick="confirmarDevolucao()">
                            <i class="fa fa-reply"></i> Confirmar Devolu√ß√£o
                        </button>
                    </div>
                    
                    <button class="btn btn-outline-light w-100 mt-2" onclick="reiniciarScanner()">
                        <i class="fa fa-refresh"></i> Escanear Novamente
                    </button>
                </div>
            </div>
        </section>

        <section id="relatorios" style="display:none;">
            <h2><i class="fa fa-chart-bar text-warning"></i> Relat√≥rios do Sistema</h2>
            <hr/>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioChaves()">
                        <div class="text-center">
                            <i class="fa fa-key fa-3x text-info mb-3"></i>
                            <h4>Relat√≥rio de Chaves</h4>
                            <p class="text-muted">Lista completa de todas as chaves cadastradas com seus status atualizados</p>
                            <button class="btn btn-info w-100">
                                <i class="fa fa-download"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioColaboradores()">
                        <div class="text-center">
                            <i class="fa fa-users fa-3x text-warning mb-3"></i>
                            <h4>Relat√≥rio de Colaboradores</h4>
                            <p class="text-muted">Lista completa de todos os colaboradores cadastrados no sistema</p>
                            <button class="btn btn-warning w-100">
                                <i class="fa fa-download"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioHistorico()">
                        <div class="text-center">
                            <i class="fa fa-history fa-3x text-success mb-3"></i>
                            <h4>Relat√≥rio de Hist√≥rico</h4>
                            <p class="text-muted">Hist√≥rico completo de todas as movimenta√ß√µes do sistema</p>
                            <button class="btn btn-success w-100">
                                <i class="fa fa-download"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioCompleto()">
                        <div class="text-center">
                            <i class="fa fa-file-alt fa-3x text-primary mb-3"></i>
                            <h4>Relat√≥rio Completo</h4>
                            <p class="text-muted">Relat√≥rio consolidado com todos os dados do sistema</p>
                            <button class="btn btn-primary w-100">
                                <i class="fa fa-download"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4 p-4">
                <h4>Estat√≠sticas do Sistema</h4>
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statChavesTotal">0</h3>
                            <p class="mb-0">Total de Chaves</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statChavesDisponiveis">0</h3>
                            <p class="mb-0">Chaves Dispon√≠veis</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statColaboradoresTotal">0</h3>
                            <p class="mb-0">Colaboradores</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statMovimentacoesTotal">0</h3>
                            <p class="mb-0">Movimenta√ß√µes</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="offline" style="display:none;">
            <h2><i class="fa fa-cloud text-warning"></i> Gerenciamento de Dados Offline</h2>
            <hr/>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card p-4">
                        <h4><i class="fa fa-database"></i> Status de Sincroniza√ß√£o</h4>
                        <p><strong>Status da Conex√£o:</strong> 
                            <span id="statusConexao" class="badge bg-success">Online</span>
                        </p>
                        <p><strong>Movimenta√ß√µes Pendentes:</strong> 
                            <span id="contadorPendentes" class="fw-bold text-warning">0</span>
                        </p>
                        <p><strong>√öltima Sincroniza√ß√£o:</strong> 
                            <span id="ultimaSync" class="fw-bold">Nunca</span>
                        </p>
                        
                        <button class="btn btn-warning w-100 mt-3" onclick="sincronizarDadosPendentes()">
                            <i class="fa fa-refresh"></i> Sincronizar Agora
                        </button>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card p-4">
                        <h4><i class="fa fa-info-circle"></i> Informa√ß√µes Offline</h4>
                        <p>O sistema funciona mesmo sem internet. As movimenta√ß√µes s√£o salvas localmente e sincronizadas automaticamente quando a conex√£o voltar.</p>
                        
                        <div class="alert alert-info mt-3">
                            <small>
                                <strong>Dicas:</strong><br>
                                ‚Ä¢ Todas as opera√ß√µes funcionam offline<br>
                                ‚Ä¢ Os dados s√£o sincronizados automaticamente<br>
                                ‚Ä¢ O hist√≥rico mostra o status de cada registro
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4 p-4">
                <h4>Movimenta√ß√µes Pendentes de Sincroniza√ß√£o</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Chave</th>
                                <th>Colaborador</th>
                                <th>A√ß√£o</th>
                                <th>Data Local</th>
                                <th>Usu√°rio</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaPendentes"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </div> 

    <footer class="footer">
        <p>&copy; 2025 SENAIHUB. Todos os direitos reservados. Desenvolvido para Gest√£o de Chaves. Autor: Joelson M. Mendes</p>
        <p>Vers√£o 3.3.0 (Sistema de Autentica√ß√£o Adicionado)</p>
    </footer>

</div> 

</div> <!-- Fim do appContent -->

<!-- Modal para Confirma√ß√£o de Exclus√£o -->
<div class="modal fade" id="modalConfirmarExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="mensagemExclusao">Tem certeza que deseja excluir este colaborador?</p>
                <p class="text-warning"><strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Edi√ß√£o -->
<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <label for="modalInput" class="form-label text-white">Novo Nome:</label>
                <input id="modalInput" class="form-control" placeholder="Digite o novo nome">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="btnSalvarEdicao">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================
//             SCRIPT DO SISTEMA (com Firebase + Autentica√ß√£o)
// ============================================================

// Vari√°veis Globais
let chaves = [];
let colaboradores = [];
let historico = [];
let historicoPendente = [];
let contadorChave = 0; 
let contadorColaborador = 0;
let itemEditando = null;
let tipoEdicao = null;
let chaveSelecionada = null;
let html5QrcodeScanner = null;
let db = null; 
let scannerAtivo = false;
let scannerPausado = false;
let isOnline = true;
let colaboradorParaExcluir = null;

// Vari√°veis para autentica√ß√£o
let currentUser = null;
let firebaseApp = null;

/* ==================================
    CONFIGURA√á√ÉO DO FIREBASE
================================== */
const firebaseConfig = {
  apiKey: "AIzaSyBxtaE405vs6mpuX5ufMu38s9wr3Hn0io8", 
  authDomain: "gestao-chaves-app.firebaseapp.com",
  projectId: "gestao-chaves-app", 
  storageBucket: "gestao-chaves-app.firebasestorage.app",
  messagingSenderId: "391255964652",
  appId: "1:391255964652:web:6d27bb36bc9ff520349ec9",
};

// ====================================================================
// FUN√á√ïES DE AUTENTICA√á√ÉO (CORRIGIDAS)
// ====================================================================

function showLogin() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('resetPasswordForm').style.display = 'none';
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginError').textContent = '';
    document.getElementById('loginMessage').style.display = 'none';
}

function showRegister() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    document.getElementById('resetPasswordForm').style.display = 'none';
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginError').textContent = '';
    document.getElementById('loginMessage').style.display = 'none';
}

function showPasswordReset() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('resetPasswordForm').style.display = 'block';
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginError').textContent = '';
    document.getElementById('loginMessage').style.display = 'none';
}

function login(event) {
    event.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorElement = document.getElementById('loginError');
    
    errorElement.style.display = 'none';
    errorElement.textContent = '';
    
    const btnLogin = document.getElementById('btnLogin');
    const originalText = btnLogin.innerHTML;
    btnLogin.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Entrando...';
    btnLogin.disabled = true;
    
    showMessage('Iniciando autentica√ß√£o...');
    
    // Inicializar Firebase se ainda n√£o estiver inicializado
    if (!firebaseApp) {
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            console.log('Firebase inicializado para login');
        } catch (error) {
            console.log('Firebase j√° inicializado ou erro:', error.message);
            // Firebase j√° est√° inicializado
        }
    }
    
    firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log('Login bem-sucedido:', userCredential.user.email);
            showMessage('Login bem-sucedido! Redirecionando...');
            currentUser = userCredential.user;
            showAppContent();
        })
        .catch((error) => {
            console.error('Erro no login:', error.code, error.message);
            
            let errorMessage = 'Erro ao fazer login. ';
            
            switch(error.code) {
                case 'auth/invalid-email':
                    errorMessage += 'Email inv√°lido.';
                    break;
                case 'auth/user-disabled':
                    errorMessage += 'Esta conta foi desativada.';
                    break;
                case 'auth/user-not-found':
                    errorMessage += 'Usu√°rio n√£o encontrado.';
                    break;
                case 'auth/wrong-password':
                    errorMessage += 'Senha incorreta.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage += 'Erro de conex√£o. Verifique sua internet.';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';
        })
        .finally(() => {
            btnLogin.innerHTML = originalText;
            btnLogin.disabled = false;
            hideMessage();
        });
}

function register(event) {
    event.preventDefault();
    
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;
    const errorElement = document.getElementById('loginError');
    
    errorElement.style.display = 'none';
    errorElement.textContent = '';
    
    // Valida√ß√£o b√°sica
    if (password !== confirmPassword) {
        errorElement.textContent = 'As senhas n√£o coincidem.';
        errorElement.style.display = 'block';
        return;
    }
    
    if (password.length < 6) {
        errorElement.textContent = 'A senha deve ter no m√≠nimo 6 caracteres.';
        errorElement.style.display = 'block';
        return;
    }
    
    const btnRegister = document.getElementById('btnRegister');
    const originalText = btnRegister.innerHTML;
    btnRegister.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Criando conta...';
    btnRegister.disabled = true;
    
    showMessage('Criando conta...');
    
    // Inicializar Firebase se ainda n√£o estiver inicializado
    if (!firebaseApp) {
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            console.log('Firebase inicializado para registro');
        } catch (error) {
            console.log('Firebase j√° inicializado ou erro:', error.message);
        }
    }
    
    firebase.auth().createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log('Conta criada:', userCredential.user.email);
            showMessage('Conta criada! Atualizando perfil...');
            
            // Atualizar perfil do usu√°rio com o nome
            return userCredential.user.updateProfile({
                displayName: name
            });
        })
        .then(() => {
            currentUser = firebase.auth().currentUser;
            showMessage('Perfil atualizado! Iniciando sistema...');
            
            // Inicializar Firestore ap√≥s criar a conta
            if (!db) {
                db = firebase.firestore();
            }
            
            // Salvar informa√ß√µes adicionais no Firestore (opcional)
            return db.collection('usuarios').doc(currentUser.uid).set({
                nome: name,
                email: email,
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
                tipo: 'usuario'
            }, { merge: true });
        })
        .then(() => {
            console.log('Usu√°rio salvo no Firestore');
            alert('Conta criada com sucesso!');
            showAppContent();
        })
        .catch((error) => {
            console.error('Erro ao criar conta:', error.code, error.message);
            
            let errorMessage = 'Erro ao criar conta. ';
            
            switch(error.code) {
                case 'auth/email-already-in-use':
                    errorMessage += 'Este email j√° est√° em uso.';
                    break;
                case 'auth/invalid-email':
                    errorMessage += 'Email inv√°lido.';
                    break;
                case 'auth/weak-password':
                    errorMessage += 'A senha √© muito fraca.';
                    break;
                case 'auth/network-request-failed':
                    errorMessage += 'Erro de conex√£o. Verifique sua internet.';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';
        })
        .finally(() => {
            btnRegister.innerHTML = originalText;
            btnRegister.disabled = false;
            hideMessage();
        });
}

function resetPassword(event) {
    event.preventDefault();
    
    const email = document.getElementById('resetEmail').value;
    const errorElement = document.getElementById('loginError');
    
    errorElement.style.display = 'none';
    errorElement.textContent = '';
    
    const btnReset = document.getElementById('btnResetPassword');
    const originalText = btnReset.innerHTML;
    btnReset.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Enviando...';
    btnReset.disabled = true;
    
    // Inicializar Firebase se ainda n√£o estiver inicializado
    if (!firebaseApp) {
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.log('Firebase j√° inicializado');
        }
    }
    
    firebase.auth().sendPasswordResetEmail(email)
        .then(() => {
            alert('Email de recupera√ß√£o enviado! Verifique sua caixa de entrada.');
            showLogin();
        })
        .catch((error) => {
            let errorMessage = 'Erro ao enviar email de recupera√ß√£o. ';
            
            switch(error.code) {
                case 'auth/invalid-email':
                    errorMessage += 'Email inv√°lido.';
                    break;
                case 'auth/user-not-found':
                    errorMessage += 'Usu√°rio n√£o encontrado.';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';
        })
        .finally(() => {
            btnReset.innerHTML = originalText;
            btnReset.disabled = false;
        });
}

function logout() {
    if (confirm('Tem certeza que deseja sair?')) {
        firebase.auth().signOut()
            .then(() => {
                console.log('Usu√°rio deslogado');
                currentUser = null;
                hideAppContent();
                showLogin();
            })
            .catch((error) => {
                console.error('Erro ao fazer logout:', error);
                alert('Erro ao fazer logout. Tente novamente.');
            });
    }
}

function showMessage(message) {
    const messageElement = document.getElementById('loginMessage');
    messageElement.textContent = message;
    messageElement.style.display = 'block';
    messageElement.style.background = '#ff9800';
}

function hideMessage() {
    document.getElementById('loginMessage').style.display = 'none';
}

function showAppContent() {
    console.log('Mostrando conte√∫do do app...');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContent').style.display = 'flex';
    
    // Atualizar informa√ß√µes do usu√°rio
    if (currentUser) {
        const displayName = currentUser.displayName || currentUser.email.split('@')[0];
        const firstLetter = displayName.charAt(0).toUpperCase();
        
        document.getElementById('userName').textContent = displayName;
        document.getElementById('userEmailDisplay').textContent = currentUser.email;
        document.getElementById('userAvatar').textContent = firstLetter;
        document.getElementById('welcomeUser').textContent = displayName;
        
        // Gerar cor de avatar baseada no email
        const colors = ['#fd790d', '#48f005', '#007bff', '#6f42c1', '#e83e8c'];
        const colorIndex = currentUser.email.length % colors.length;
        document.getElementById('userAvatar').style.background = colors[colorIndex];
    }
    
    // Iniciar o sistema ap√≥s login
    iniciarSistema();
}

function hideAppContent() {
    console.log('Ocultando conte√∫do do app...');
    document.getElementById('appContent').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    
    // Limpar campos de login
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('registerName').value = '';
    document.getElementById('registerEmail').value = '';
    document.getElementById('registerPassword').value = '';
    document.getElementById('registerConfirmPassword').value = '';
    document.getElementById('resetEmail').value = '';
    
    // Mostrar formul√°rio de login
    showLogin();
}

// Verificar estado de autentica√ß√£o
function checkAuthState() {
    console.log('Verificando estado de autentica√ß√£o...');
    
    // Inicializar Firebase primeiro
    try {
        if (!firebaseApp) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            console.log('Firebase inicializado para verifica√ß√£o de estado');
        }
    } catch (error) {
        console.log('Firebase j√° inicializado ou erro na inicializa√ß√£o:', error.message);
    }
    
    // Configurar o listener de autentica√ß√£o
    firebase.auth().onAuthStateChanged((user) => {
        console.log('Estado de autentica√ß√£o alterado:', user ? 'Usu√°rio logado' : 'Usu√°rio n√£o logado');
        if (user) {
            // Usu√°rio est√° logado
            currentUser = user;
            showAppContent();
        } else {
            // Usu√°rio n√£o est√° logado
            currentUser = null;
            hideAppContent();
        }
    }, (error) => {
        console.error('Erro no listener de autentica√ß√£o:', error);
        // Mostrar tela de login mesmo com erro
        hideAppContent();
    });
}

function iniciarSistema() {
    console.log('Iniciando sistema...');
    
    // S√≥ inicializa o sistema se o usu√°rio estiver autenticado
    if (!currentUser) {
        console.error('Usu√°rio n√£o autenticado');
        return;
    }
    
    console.log('Usu√°rio autenticado:', currentUser.email);
    
    // Configurar Firestore se ainda n√£o estiver configurado
    if (!db) {
        db = firebase.firestore();
        console.log('Firestore configurado');
    }

    // Configurar detec√ß√£o de conectividade
    configurarDetecaoConexao();

    // Carrega dados pendentes do localStorage
    carregarDadosOffline();

    // Inicia os listeners (carregamento em tempo real do Firebase)
    carregarChavesFirebase();
    carregarColaboradoresFirebase();
    carregarHistoricoFirebase();

    document.getElementById("btnSalvarEdicao").addEventListener("click", salvarEdicao);
    document.getElementById("btnConfirmarExclusao").addEventListener("click", confirmarExclusaoColaborador);

    // Tenta sincronizar dados pendentes ao iniciar
    setTimeout(sincronizarDadosPendentes, 2000);
    
    console.log('Sistema iniciado com sucesso!');
}

// ====================================================================
// FUN√á√ïES DO SISTEMA (CORRIGIDAS)
// ====================================================================

function configurarDetecaoConexao() {
    isOnline = navigator.onLine;
    atualizarStatusConexao();

    window.addEventListener('online', function() {
        isOnline = true;
        atualizarStatusConexao();
        sincronizarDadosPendentes();
    });

    window.addEventListener('offline', function() {
        isOnline = false;
        atualizarStatusConexao();
    });
}

function atualizarStatusConexao() {
    const onlineIndicator = document.getElementById('onlineIndicator');
    const offlineIndicator = document.getElementById('offlineIndicator');
    const statusConexao = document.getElementById('statusConexao');

    if (isOnline) {
        onlineIndicator.style.display = 'block';
        offlineIndicator.style.display = 'none';
        statusConexao.textContent = 'Online';
        statusConexao.className = 'badge bg-success';
    } else {
        onlineIndicator.style.display = 'none';
        offlineIndicator.style.display = 'block';
        statusConexao.textContent = 'Offline';
        statusConexao.className = 'badge bg-danger';
    }
}

function carregarDadosOffline() {
    const pendentesSalvos = localStorage.getItem('historicoPendente');
    if (pendentesSalvos) {
        historicoPendente = JSON.parse(pendentesSalvos);
    }

    const ultimaSync = localStorage.getItem('ultimaSincronizacao');
    if (ultimaSync) {
        document.getElementById('ultimaSync').textContent = new Date(ultimaSync).toLocaleString('pt-BR');
    }

    atualizarContadoresOffline();
}

function salvarDadosOffline() {
    localStorage.setItem('historicoPendente', JSON.stringify(historicoPendente));
    atualizarContadoresOffline();
}

function atualizarContadoresOffline() {
    document.getElementById('contadorPendentes').textContent = historicoPendente.length;
    document.getElementById('pendentesSync').textContent = historicoPendente.length;
    atualizarListaPendentes();
}

function adicionarMovimentacaoOffline(chave, colaborador, acao) {
    if (!currentUser) {
        console.error('Usu√°rio n√£o autenticado');
        return null;
    }
    
    const movimentacao = {
        id: Date.now().toString(),
        chave: chave.id,
        nomeChave: chave.nome,
        colaborador: colaborador.nome,
        idColaborador: colaborador.id,
        acao: acao,
        data: new Date().toLocaleString('pt-BR'),
        dataTimestamp: new Date().toISOString(),
        sincronizado: false,
        usuarioId: currentUser.uid,
        usuarioEmail: currentUser.email
    };

    historicoPendente.push(movimentacao);
    salvarDadosOffline();

    if (isOnline) {
        sincronizarMovimentacao(movimentacao);
    } else {
        atualizarStatusChaveLocal(chave, colaborador, acao);
    }

    return movimentacao;
}

function atualizarStatusChaveLocal(chave, colaborador, acao) {
    const chaveIndex = chaves.findIndex(c => c.id === chave.id);
    if (chaveIndex !== -1) {
        if (acao === "RETIRADA") {
            chaves[chaveIndex].status = "Retirada por " + colaborador.nome + " (Offline)";
        } else if (acao === "DEVOLU√á√ÉO") {
            chaves[chaveIndex].status = "Dispon√≠vel (Offline)";
        }
        atualizarListas();
    }
}

async function sincronizarDadosPendentes() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para sincronizar.');
        return;
    }
    
    if (historicoPendente.length === 0) {
        alert('N√£o h√° dados pendentes para sincronizar.');
        return;
    }
    
    if (!isOnline) {
        alert('Voc√™ est√° offline. Conecte-se √† internet para sincronizar.');
        return;
    }
    
    document.getElementById('syncStatus').style.display = 'block';
    document.getElementById('syncStatus').innerHTML = '<i class="fa fa-refresh fa-spin"></i> Sincronizando dados pendentes...';
    
    let sucessos = 0;
    let erros = 0;
    const total = historicoPendente.length;
    
    // Criar uma c√≥pia do array para evitar problemas de itera√ß√£o
    const pendentesParaSincronizar = [...historicoPendente];
    
    for (let i = 0; i < pendentesParaSincronizar.length; i++) {
        const movimentacao = pendentesParaSincronizar[i];
        
        try {
            // 1. Sincronizar no hist√≥rico
            await db.collection("historico").add({
                chave: movimentacao.chave,
                nomeChave: movimentacao.nomeChave,
                colaborador: movimentacao.colaborador,
                idColaborador: movimentacao.idColaborador,
                acao: movimentacao.acao,
                data: movimentacao.data,
                dataTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
                usuarioId: currentUser.uid,
                usuarioEmail: currentUser.email
            });
            
            // 2. Atualizar status da chave no Firestore
            const chave = chaves.find(c => c.id === movimentacao.chave);
            if (chave && chave.idDoc) {
                if (movimentacao.acao === "RETIRADA") {
                    await db.collection("chaves").doc(chave.idDoc).update({
                        status: "Retirada por " + movimentacao.colaborador,
                        ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else if (movimentacao.acao === "DEVOLU√á√ÉO") {
                    await db.collection("chaves").doc(chave.idDoc).update({
                        status: "Dispon√≠vel",
                        ultimaAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }
            
            // 3. Remover do array de pendentes
            historicoPendente = historicoPendente.filter(m => m.id !== movimentacao.id);
            sucessos++;
            
            // Atualizar contador em tempo real
            document.getElementById('syncStatus').innerHTML = 
                `<i class="fa fa-refresh fa-spin"></i> Sincronizando... (${sucessos}/${total})`;
            
        } catch (error) {
            console.error("Erro ao sincronizar movimenta√ß√£o:", error);
            erros++;
            
            // Se houver erro de rede, parar a sincroniza√ß√£o
            if (error.code === 'unavailable' || error.message.includes('network')) {
                alert('Erro de rede durante a sincroniza√ß√£o. Alguns dados podem n√£o ter sido sincronizados.');
                break;
            }
        }
    }
    
    // Salvar estado atualizado no localStorage
    salvarDadosOffline();
    
    // Atualizar √∫ltima sincroniza√ß√£o
    localStorage.setItem('ultimaSincronizacao', new Date().toISOString());
    document.getElementById('ultimaSync').textContent = new Date().toLocaleString('pt-BR');
    
    document.getElementById('syncStatus').style.display = 'none';
    
    // Mostrar resumo
    if (erros === 0) {
        alert(`Sincroniza√ß√£o conclu√≠da! ${sucessos} registro(s) sincronizado(s) com sucesso.`);
    } else {
        alert(`Sincroniza√ß√£o parcial: ${sucessos} registro(s) sincronizado(s), ${erros} erro(s).`);
    }
}

async function sincronizarMovimentacao(movimentacao) {
    try {
        await db.collection("historico").add({
            chave: movimentacao.chave,
            colaborador: movimentacao.colaborador,
            acao: movimentacao.acao,
            data: movimentacao.data,
            dataTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
            usuarioId: movimentacao.usuarioId,
            usuarioEmail: movimentacao.usuarioEmail
        });

        const chave = chaves.find(c => c.id === movimentacao.chave);
        if (chave) {
            if (movimentacao.acao === "RETIRADA") {
                await db.collection("chaves").doc(chave.idDoc).update({
                    status: "Retirada por " + movimentacao.colaborador
                });
            } else if (movimentacao.acao === "DEVOLU√á√ÉO") {
                await db.collection("chaves").doc(chave.idDoc).update({
                    status: "Dispon√≠vel"
                });
            }
        }

        historicoPendente = historicoPendente.filter(m => m.id !== movimentacao.id);
        salvarDadosOffline();
        
        return true;
    } catch (error) {
        console.error("Erro ao sincronizar movimenta√ß√£o:", error);
        return false;
    }
}

function atualizarListaPendentes() {
    const lista = document.getElementById('listaPendentes');
    lista.innerHTML = '';

    historicoPendente.forEach(movimentacao => {
        const acaoClass = movimentacao.acao.includes('RETIRADA') ? 'text-danger' : 'text-success';
        lista.innerHTML += `
            <tr>
                <td>${movimentacao.chave} - ${movimentacao.nomeChave}</td>
                <td>${movimentacao.colaborador}</td>
                <td class="${acaoClass}">${movimentacao.acao}</td>
                <td>${movimentacao.data}</td>
                <td>${movimentacao.usuarioEmail || 'Desconhecido'}</td>
                <td>
                    <span class="pending-sync">Pendente</span>
                    <button class="btn btn-sm btn-warning ms-2" onclick="tentarSincronizarUnico('${movimentacao.id}')">
                        <i class="fa fa-refresh"></i>
                    </button>
                </td>
            </tr>`;
    });
}

async function tentarSincronizarUnico(id) {
    const movimentacao = historicoPendente.find(m => m.id === id);
    if (movimentacao && await sincronizarMovimentacao(movimentacao)) {
        alert('Movimenta√ß√£o sincronizada com sucesso!');
    }
}

function carregarChavesFirebase() {
    if (!db) {
        console.error('Firestore n√£o inicializado');
        return;
    }
    
    db.collection("chaves").onSnapshot((snapshot) => {
        chaves = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
        
        contadorChave = chaves.reduce((max, c) => {
            const num = parseInt(c.id.split('-')[1]);
            return num > max ? num : max;
        }, 0);
        
        atualizarListas();
        atualizarEstatisticas();
    }, error => {
        console.error("Erro ao carregar chaves:", error);
    });
}

function carregarColaboradoresFirebase() {
    if (!db) {
        console.error('Firestore n√£o inicializado');
        return;
    }
    
    db.collection("colaboradores").onSnapshot((snapshot) => {
        colaboradores = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));

        contadorColaborador = colaboradores.reduce((max, c) => {
            const num = parseInt(c.id);
            return num > max ? num : max;
        }, 0);
        
        document.getElementById("ultimoColID").innerText = contadorColaborador > 0 ? contadorColaborador.toString().padStart(2, "0") : "Nenhum";
        atualizarListas();
        atualizarEstatisticas();
    }, error => {
        console.error("Erro ao carregar colaboradores:", error);
    });
}

function carregarHistoricoFirebase() {
    if (!db) {
        console.error('Firestore n√£o inicializado');
        return;
    }
    
    db.collection("historico").orderBy("dataTimestamp", "desc").onSnapshot((snapshot) => {
        historico = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
        atualizarListas();
        atualizarEstatisticas();
    }, error => {
        console.error("Erro ao carregar hist√≥rico:", error);
    });
}

function salvarMovimentacao(chave, colaborador, acao) {
    if (!currentUser) {
        console.error('Usu√°rio n√£o autenticado');
        return;
    }
    
    if (isOnline) {
        db.collection("historico").add({
            chave: chave.id,
            colaborador: colaborador.nome,
            acao: acao,
            data: new Date().toLocaleString('pt-BR'),
            dataTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
            usuarioId: currentUser.uid,
            usuarioEmail: currentUser.email
        })
        .catch(error => {
            console.error("Erro ao salvar hist√≥rico:", error);
            adicionarMovimentacaoOffline(chave, colaborador, acao);
        });
    } else {
        adicionarMovimentacaoOffline(chave, colaborador, acao);
    }
}

function cadastrarChave() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para cadastrar chaves.');
        return;
    }
    
    const nome = document.getElementById("nomeChave").value.trim();
    if (!nome) return alert("Digite o nome da chave.");

    const novoContador = contadorChave + 1;
    const id = "CH-" + novoContador.toString().padStart(3, "0"); 

    db.collection("chaves").add({
        id, 
        nome, 
        status: "Dispon√≠vel",
        usuarioCriador: currentUser.email,
        dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        document.getElementById("nomeChave").value = "";
        gerarQRCode(id);
        alert(`Chave ${id} cadastrada com sucesso!`);
    })
    .catch(error => {
        console.error("Erro ao cadastrar chave:", error);
        alert("Erro ao cadastrar chave. Verifique o console.");
    });
}

function cadastrarColaborador() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para cadastrar colaboradores.');
        return;
    }
    
    const nome = document.getElementById("nomeColaborador").value.trim();
    if (!nome) return alert("Digite o nome do colaborador.");

    const novoContador = contadorColaborador + 1;
    let id = novoContador.toString().padStart(2, "0");

    db.collection("colaboradores").add({ 
        id, 
        nome,
        usuarioCriador: currentUser.email,
        dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        document.getElementById("nomeColaborador").value = "";
        alert(`Colaborador ${id} - ${nome} cadastrado com sucesso!`);
    })
    .catch(error => {
        console.error("Erro ao cadastrar colaborador:", error);
        alert("Erro ao cadastrar colaborador. Verifique o console.");
    });
}

function validarIdColaborador(idCol) {
    if (!idCol) return "Digite o ID do colaborador.";
    if (!/^\d+$/.test(idCol)) return "ID do colaborador deve conter apenas n√∫meros.";
    if (colaboradores.find(c => c.id === idCol)) return null;
    return "Colaborador n√£o encontrado.";
}

function confirmarRetirada() {
    if (!currentUser) {
        alert('Sess√£o expirada. Fa√ßa login novamente.');
        return;
    }
    
    if (!chaveSelecionada) {
        alert("Erro: Nenhuma chave foi escaneada.");
        return;
    }
    
    const idCol = document.getElementById("idColRetirada").value.trim();
    const validacao = validarIdColaborador(idCol);
    if (validacao) {
        alert(validacao);
        return;
    }

    const colab = colaboradores.find(c => c.id === idCol);
    const chave = chaves.find(c => c.id === chaveSelecionada);
    
    if (!chave) {
        alert("Chave n√£o encontrada no sistema.");
        reiniciarScanner();
        return;
    }

    if (chave.status !== "Dispon√≠vel" && !chave.status.includes("Offline")) {
        alert(`Erro: Esta chave j√° est√° ${chave.status}. Use a op√ß√£o de Devolu√ß√£o.`);
        reiniciarScanner();
        return;
    }

    if (isOnline) {
        db.collection("chaves").doc(chave.idDoc).update({
            status: "Retirada por " + colab.nome
        })
        .then(() => {
            salvarMovimentacao(chave, colab, "RETIRADA");
            alert(`Sucesso! Chave ${chave.id} retirada por ${colab.nome}.`);
            reiniciarScanner();
        })
        .catch(error => {
            console.error("Erro ao retirar chave:", error);
            const movimentacao = adicionarMovimentacaoOffline(chave, colab, "RETIRADA");
            alert(`‚úÖ Retirada registrada offline! Ser√° sincronizada automaticamente.`);
            reiniciarScanner();
        });
    } else {
        const movimentacao = adicionarMovimentacaoOffline(chave, colab, "RETIRADA");
        alert(`‚úÖ Retirada registrada offline! (ID: ${movimentacao.id})\nSer√° sincronizada quando a conex√£o voltar.`);
        reiniciarScanner();
    }
}

function confirmarDevolucao() {
    if (!currentUser) {
        alert('Sess√£o expirada. Fa√ßa login novamente.');
        return;
    }
    
    if (!chaveSelecionada) {
        alert("Erro: Nenhuma chave foi escaneada.");
        return;
    }
    
    const idCol = document.getElementById("idColRetirada").value.trim();
    const validacao = validarIdColaborador(idCol);
    if (validacao) {
        alert(validacao);
        return;
    }

    const colab = colaboradores.find(c => c.id === idCol);
    const chave = chaves.find(c => c.id === chaveSelecionada);
    
    if (!chave) {
        alert("Chave n√£o encontrada no sistema.");
        reiniciarScanner();
        return;
    }

    if (chave.status === "Dispon√≠vel" || chave.status === "Dispon√≠vel (Offline)") {
        alert("Erro: Esta chave j√° est√° dispon√≠vel.");
        reiniciarScanner();
        return;
    }
    
    const nomeQuemRetirou = chave.status.replace("Retirada por ", "").replace(" (Offline)", "");
    if (!chave.status.includes(colab.nome) && nomeQuemRetirou !== colab.nome) {
        if (!confirm(`Aten√ß√£o: A chave foi retirada por ${nomeQuemRetirou}. Deseja confirmar a devolu√ß√£o por ${colab.nome} mesmo assim?`)) {
            return;
        }
    }

    if (isOnline) {
        db.collection("chaves").doc(chave.idDoc).update({
            status: "Dispon√≠vel"
        })
        .then(() => {
            salvarMovimentacao(chave, colab, "DEVOLU√á√ÉO");
            alert(`Sucesso! Chave ${chave.id} devolvida por ${colab.nome}.`);
            reiniciarScanner();
        })
        .catch(error => {
            console.error("Erro ao devolver chave:", error);
            const movimentacao = adicionarMovimentacaoOffline(chave, colab, "DEVOLU√á√ÉO");
            alert(`‚úÖ Devolu√ß√£o registrada offline! Ser√° sincronizada automaticamente.`);
            reiniciarScanner();
        });
    } else {
        const movimentacao = adicionarMovimentacaoOffline(chave, colab, "DEVOLU√á√ÉO");
        alert(`‚úÖ Devolu√ß√£o registrada offline! (ID: ${movimentacao.id})\nSer√° sincronizada quando a conex√£o voltar.`);
        reiniciarScanner();
    }
}

function salvarEdicao() {
    if (!currentUser) {
        alert('Sess√£o expirada. Fa√ßa login novamente.');
        return;
    }
    
    const novoNome = document.getElementById("modalInput").value.trim();
    if (!novoNome) return alert("Digite um nome v√°lido.");

    let colecao, idDoc, tipo;
    
    if (tipoEdicao === "chave") {
        const chaveEditada = chaves[itemEditando];
        colecao = "chaves";
        idDoc = chaveEditada.idDoc;
        tipo = "Chave";
    } else {
        const colabEditado = colaboradores[itemEditando];
        colecao = "colaboradores";
        idDoc = colabEditado.idDoc;
        tipo = "Colaborador";
    }

    db.collection(colecao).doc(idDoc).update({
        nome: novoNome,
        usuarioUltimaEdicao: currentUser.email,
        dataUltimaEdicao: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        alert(`${tipo} atualizado para "${novoNome}".`);
        const modalElement = document.getElementById("modalEditar");
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) modalInstance.hide();
    })
    .catch(error => {
        console.error("Erro ao salvar edi√ß√£o:", error);
        alert("Erro ao salvar edi√ß√£o.");
    });
}

function showPage(page, event) {
    if(event) event.preventDefault(); 

    document.querySelectorAll("section").forEach(s => s.style.display = "none");
    document.getElementById(page).style.display = "block";

    document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("activeMenu"));
    if(event) event.currentTarget.classList.add("activeMenu");
    else document.querySelector(`.sidebar a[onclick*="${page}"]`).classList.add("activeMenu");

    if (page === 'qr') {
        iniciarScanner();
    } else {
        pararScanner();
    }

    if (page === 'colaboradores') {
        document.getElementById("ultimoColID").innerText = contadorColaborador > 0 ? contadorColaborador.toString().padStart(2, "0") : "Nenhum";
    }

    if (page === 'offline') {
        atualizarListaPendentes();
    }

    if (page === 'qr-codes') {
        gerarTodosQRCodes();
    }

    if (page === 'relatorios') {
        atualizarEstatisticas();
    }
    
    // Adicionar esta linha para garantir que a p√°gina seja rolada para o topo
    window.scrollTo(0, 0);
}

function iniciarScanner() {
    if (html5QrcodeScanner && scannerAtivo) {
        retomarScanner();
        return;
    }

    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
    }

    html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", 
        { 
            fps: 10, 
            qrbox: 250, 
            disableFlip: false,
            facingMode: "environment",
            videoConstraints: {
                facingMode: { ideal: "environment" }, 
                width: { max: 480 },
                height: { max: 480 }
            }
        }
    );

    html5QrcodeScanner.render(onScanSuccess, onScanError);
    scannerAtivo = true;
    scannerPausado = false;
    
    atualizarStatusScanner();
    document.getElementById("btnToggleScanner").style.display = "block";
}

function pararScanner() {
    if (html5QrcodeScanner && scannerAtivo) {
        try {
            html5QrcodeScanner.clear();
            scannerAtivo = false;
            scannerPausado = false;
        } catch (error) {
            console.warn("Erro ao parar scanner:", error);
        }
    }
}

function pausarScanner() {
    if (html5QrcodeScanner && scannerAtivo && !scannerPausado) {
        try {
            html5QrcodeScanner.pause();
            scannerPausado = true;
            atualizarStatusScanner();
        } catch (error) {
            console.warn("Erro ao pausar scanner:", error);
        }
    }
}

function retomarScanner() {
    if (html5QrcodeScanner && scannerAtivo && scannerPausado) {
        try {
            html5QrcodeScanner.resume();
            scannerPausado = false;
            atualizarStatusScanner();
        } catch (error) {
            console.warn("Erro ao retomar scanner:", error);
        }
    }
}

function toggleScanner() {
    if (scannerPausado) {
        retomarScanner();
    } else {
        pausarScanner();
    }
}

function atualizarStatusScanner() {
    const statusElement = document.getElementById("scannerStatus");
    const toggleButton = document.getElementById("btnToggleScanner");
    
    if (scannerAtivo) {
        statusElement.style.display = "block";
        if (scannerPausado) {
            statusElement.className = "scanner-status scanner-paused";
            statusElement.innerHTML = "<i class='fa fa-pause'></i> Scanner pausado";
            toggleButton.innerHTML = "<i class='fa fa-play'></i> Retomar Scanner";
        } else {
            statusElement.className = "scanner-status scanner-active";
            statusElement.innerHTML = "<i class='fa fa-camera'></i> Scanner ativo";
            toggleButton.innerHTML = "<i class='fa fa-pause'></i> Pausar Scanner";
        }
    } else {
        statusElement.style.display = "none";
    }
}

function onScanSuccess(decodedText) {
    pausarScanner();
    
    const chave = chaves.find(c => c.id === decodedText);

    if (!chave) {
        document.getElementById("chaveDetectada").innerText = `ERRO: Chave '${decodedText}' n√£o encontrada.`;
        document.getElementById("areaConfirmacao").style.display = "none";
        alert("QR Code lido, mas nenhuma chave correspondente foi encontrada no sistema.");
        
        setTimeout(retomarScanner, 2000);
        return;
    }

    chaveSelecionada = decodedText;
    document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
    document.getElementById("areaConfirmacao").style.display = "block";

    const isDisponivel = chave.status === "Dispon√≠vel" || chave.status === "Dispon√≠vel (Offline)";
    
    document.getElementById("btnConfirmarRetirada").style.display = isDisponivel ? "block" : "none";
    document.getElementById("btnDevolverChave").style.display = isDisponivel ? "none" : "block";
    document.getElementById("idColRetirada").placeholder = isDisponivel ? 
        "ID do colaborador que vai RETIRAR" : 
        "ID do colaborador que vai DEVOLVER";
}

function onScanError(errorMessage) {
    // Erros s√£o esperados durante a opera√ß√£o normal do scanner
}

function reiniciarScanner() {
    document.getElementById("areaConfirmacao").style.display = "none";
    document.getElementById("chaveDetectada").innerText = "Nenhuma";
    document.getElementById("idColRetirada").value = "";
    chaveSelecionada = null;

    retomarScanner();
}

function gerarQRCode(texto) {
    let area = document.getElementById("qrCodeArea");
    area.innerHTML = "";

    const qrDiv = document.createElement('div');
    qrDiv.id = 'qrcodeCanvas';
    area.appendChild(qrDiv);

    new QRCode(qrDiv, { 
        text: texto, 
        width: 200, 
        height: 200, 
        colorDark : "#fff", 
        colorLight : "#1e1e1e", 
        correctLevel : QRCode.CorrectLevel.H 
    });

    setTimeout(() => {
        let canvas = qrDiv.querySelector("canvas");
        if (canvas) {
            let imgData = canvas.toDataURL("image/png");
            let link = document.createElement("a");
            link.href = imgData;
            link.download = texto + "_QRCode.png";
            link.innerText = "Baixar QR Code";
            link.className = "btn btn-outline-light mt-3";
            area.appendChild(link);
        }
    }, 100);
}

function filtrarChaves() {
    let termo = document.getElementById("buscaChaves").value.toLowerCase();
    
    const chavesFiltradas = chaves
        .filter(c => 
            c.nome.toLowerCase().includes(termo) || 
            c.id.toLowerCase().includes(termo) || 
            c.status.toLowerCase().includes(termo)
        );

    renderizarChaves(chavesFiltradas);
}

function atualizarListas() {
    const totalDisponiveis = chaves.filter(c => 
        c.status === "Dispon√≠vel" || c.status === "Dispon√≠vel (Offline)"
    ).length;
    const totalRetiradas = chaves.length - totalDisponiveis;

    document.getElementById("totalChaves").innerText = chaves.length;
    document.getElementById("chavesDisponiveis").innerText = totalDisponiveis;
    document.getElementById("chavesRetiradas").innerText = totalRetiradas;
    document.getElementById("totalCol").innerText = colaboradores.length;
    document.getElementById("totalHist").innerText = historico.length + historicoPendente.length;

    renderizarChaves(chaves);

    let colList = document.getElementById("listaColaboradores");
    colList.innerHTML = "";
    colaboradores.forEach((c, idx) => {
        colList.innerHTML += `
            <tr>
                <td>${c.id}</td>
                <td>${c.nome}</td>
                <td>
                    <button class="btn btn-sm btn-success me-1" onclick="abrirEdicao('colaborador', ${idx})">
                        <i class="fa fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="solicitarExclusaoColaborador(${idx})">
                        <i class="fa fa-trash"></i> Excluir
                    </button>
                </td>
            </tr>`;
    });

    let hist = document.getElementById("listaHistorico");
    hist.innerHTML = "";
    
    const todosRegistros = [...historico, ...historicoPendente];
    todosRegistros.sort((a, b) => new Date(b.dataTimestamp) - new Date(a.dataTimestamp));
    
    todosRegistros.forEach(h => {
        const acaoClass = h.acao.includes('RETIRADA') ? 'text-danger' : 'text-success';
        const status = h.sincronizado === false ? '<span class="pending-sync">Pendente</span>' : '<span class="badge bg-success">Sincronizado</span>';
        const usuario = h.usuarioEmail || 'Desconhecido';
        
        hist.innerHTML += `
            <tr>
                <td>${h.chave}</td>
                <td>${h.colaborador}</td>
                <td class="${acaoClass}">${h.acao}</td>
                <td>${h.data}</td>
                <td>${status}</td>
                <td>${usuario}</td>
            </tr>`;
    });
}

function atualizarEstatisticas() {
    const totalDisponiveis = chaves.filter(c => 
        c.status === "Dispon√≠vel" || c.status === "Dispon√≠vel (Offline)"
    ).length;
    const totalMovimentacoes = historico.length + historicoPendente.length;

    document.getElementById('statChavesTotal').textContent = chaves.length;
    document.getElementById('statChavesDisponiveis').textContent = totalDisponiveis;
    document.getElementById('statColaboradoresTotal').textContent = colaboradores.length;
    document.getElementById('statMovimentacoesTotal').textContent = totalMovimentacoes;
}

function renderizarChaves(chavesParaExibir) {
    let lista = document.getElementById("listaChaves");
    lista.innerHTML = "";
    chavesParaExibir.forEach((c, idx) => {
        const indexOriginal = chaves.findIndex(item => item.id === c.id); 

        const isOffline = c.status.includes("Offline");
        const statusClass = c.status.includes("Dispon√≠vel") ? 'status-disponivel' : 'status-retirada';
        const statusBadgeClass = c.status.includes("Dispon√≠vel") ? 'badge text-bg-success' : 'badge text-bg-danger';

        let acoesHtml = `
            <button class="btn btn-sm btn-warning me-2" onclick="abrirEdicao('chave', ${indexOriginal})">
                <i class="fa fa-edit"></i>
            </button>`;

        if (c.status.includes("Dispon√≠vel")) {
            acoesHtml += `
                <button class="btn btn-sm btn-info" onclick="iniciarRetiradaRapida('${c.id}')">
                    <i class="fa fa-arrow-right"></i> Retirar
                </button>`;
        } else {
            acoesHtml += `
                <button class="btn btn-sm btn-primary" onclick="iniciarDevolucaoRapida('${c.id}')">
                    <i class="fa fa-reply"></i> Devolver
                </button>`;
        }

        const offlineBadge = isOffline ? ' <span class="badge bg-warning">Offline</span>' : '';

        lista.innerHTML += `
            <tr>
                <td>${c.id}</td>
                <td>${c.nome}</td>
                <td><span class="${statusBadgeClass} ${statusClass}">${c.status}</span>${offlineBadge}</td>
                <td>${acoesHtml}</td>
            </tr>`;
    });
}

function iniciarRetiradaRapida(chaveId) {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para retirar chaves.');
        return;
    }
    
    showPage('qr'); 
    
    const chave = chaves.find(c => c.id === chaveId);
    
    if (chave) {
        chaveSelecionada = chaveId;
        document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
        document.getElementById("areaConfirmacao").style.display = "block";

        document.getElementById("btnConfirmarRetirada").style.display = "block";
        document.getElementById("btnDevolverChave").style.display = "none";
        document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai RETIRAR";
        
        pausarScanner();
    }
}

function iniciarDevolucaoRapida(chaveId) {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para devolver chaves.');
        return;
    }
    
    showPage('qr'); 
    
    const chave = chaves.find(c => c.id === chaveId);
    
    if (chave) {
        chaveSelecionada = chaveId;
        document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
        document.getElementById("areaConfirmacao").style.display = "block";

        document.getElementById("btnConfirmarRetirada").style.display = "none";
        document.getElementById("btnDevolverChave").style.display = "block";
        document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai DEVOLVER";
        
        pausarScanner();
    }
}

function abrirEdicao(tipo, indexOriginal) {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para editar.');
        return;
    }
    
    tipoEdicao = tipo;
    itemEditando = indexOriginal;
    const item = tipo === 'chave' ? chaves[indexOriginal] : colaboradores[indexOriginal];
    
    document.getElementById("modalTitulo").innerText = `Editar ${tipo === 'chave' ? 'Chave' : 'Colaborador'} (ID: ${item.id})`;
    document.getElementById("modalInput").value = item.nome;
    
    const modalInstance = new bootstrap.Modal(document.getElementById('modalEditar'));
    modalInstance.show();
}

// ====================================================================
// FUN√á√ïES DE RELAT√ìRIOS (IMPLEMENTADAS)
// ====================================================================

function gerarRelatorioChaves() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para gerar relat√≥rios.');
        return;
    }
    
    if (chaves.length === 0) {
        alert('N√£o h√° chaves cadastradas para gerar relat√≥rio.');
        return;
    }
    
    let csv = 'ID;Nome;Status;Data Cria√ß√£o;Usu√°rio Criador\n';
    
    chaves.forEach(chave => {
        csv += `${chave.id};${chave.nome};${chave.status};${chave.dataCriacao || 'N/A'};${chave.usuarioCriador || 'N/A'}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `relatorio_chaves_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('Relat√≥rio de chaves gerado com sucesso!');
}

function gerarRelatorioColaboradores() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para gerar relat√≥rios.');
        return;
    }
    
    if (colaboradores.length === 0) {
        alert('N√£o h√° colaboradores cadastrados para gerar relat√≥rio.');
        return;
    }
    
    let csv = 'ID;Nome;Data Cria√ß√£o;Usu√°rio Criador\n';
    
    colaboradores.forEach(colab => {
        csv += `${colab.id};${colab.nome};${colab.dataCriacao || 'N/A'};${colab.usuarioCriador || 'N/A'}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `relatorio_colaboradores_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('Relat√≥rio de colaboradores gerado com sucesso!');
}

function gerarRelatorioHistorico() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para gerar relat√≥rios.');
        return;
    }
    
    const todosRegistros = [...historico, ...historicoPendente];
    
    if (todosRegistros.length === 0) {
        alert('N√£o h√° hist√≥rico para gerar relat√≥rio.');
        return;
    }
    
    let csv = 'Chave;Nome Chave;Colaborador;ID Colaborador;A√ß√£o;Data;Status Sincroniza√ß√£o;Usu√°rio\n';
    
    todosRegistros.sort((a, b) => new Date(b.dataTimestamp) - new Date(a.dataTimestamp));
    
    todosRegistros.forEach(registro => {
        const status = registro.sincronizado === false ? 'Pendente' : 'Sincronizado';
        const usuario = registro.usuarioEmail || 'Desconhecido';
        const nomeChave = registro.nomeChave || registro.chave;
        
        csv += `${registro.chave};${nomeChave};${registro.colaborador};${registro.idColaborador || 'N/A'};${registro.acao};${registro.data};${status};${usuario}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `relatorio_historico_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('Relat√≥rio hist√≥rico gerado com sucesso!');
}

function gerarRelatorioCompleto() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para gerar relat√≥rios.');
        return;
    }
    
    let csv = '=== RELAT√ìRIO COMPLETO DO SISTEMA ===\n';
    csv += `Gerado em: ${new Date().toLocaleString('pt-BR')}\n`;
    csv += `Usu√°rio: ${currentUser.email}\n\n`;
    
    // Se√ß√£o de Chaves
    csv += '=== CHAVES CADASTRADAS ===\n';
    csv += 'ID;Nome;Status;Data Cria√ß√£o;Usu√°rio Criador\n';
    chaves.forEach(chave => {
        csv += `${chave.id};${chave.nome};${chave.status};${chave.dataCriacao || 'N/A'};${chave.usuarioCriador || 'N/A'}\n`;
    });
    
    // Se√ß√£o de Colaboradores
    csv += '\n=== COLABORADORES CADASTRADOS ===\n';
    csv += 'ID;Nome;Data Cria√ß√£o;Usu√°rio Criador\n';
    colaboradores.forEach(colab => {
        csv += `${colab.id};${colab.nome};${colab.dataCriacao || 'N/A'};${colab.usuarioCriador || 'N/A'}\n`;
    });
    
    // Se√ß√£o de Hist√≥rico
    csv += '\n=== HIST√ìRICO DE MOVIMENTA√á√ïES ===\n';
    csv += 'Chave;Colaborador;A√ß√£o;Data;Status Sincroniza√ß√£o;Usu√°rio\n';
    
    const todosRegistros = [...historico, ...historicoPendente];
    todosRegistros.sort((a, b) => new Date(b.dataTimestamp) - new Date(a.dataTimestamp));
    
    todosRegistros.forEach(registro => {
        const status = registro.sincronizado === false ? 'Pendente' : 'Sincronizado';
        const usuario = registro.usuarioEmail || 'Desconhecido';
        
        csv += `${registro.chave};${registro.colaborador};${registro.acao};${registro.data};${status};${usuario}\n`;
    });
    
    // Estat√≠sticas
    const totalDisponiveis = chaves.filter(c => 
        c.status === "Dispon√≠vel" || c.status === "Dispon√≠vel (Offline)"
    ).length;
    const totalMovimentacoes = historico.length + historicoPendente.length;
    
    csv += '\n=== ESTAT√çSTICAS ===\n';
    csv += `Total de Chaves: ${chaves.length}\n`;
    csv += `Chaves Dispon√≠veis: ${totalDisponiveis}\n`;
    csv += `Chaves Retiradas: ${chaves.length - totalDisponiveis}\n`;
    csv += `Total de Colaboradores: ${colaboradores.length}\n`;
    csv += `Total de Movimenta√ß√µes: ${totalMovimentacoes}\n`;
    csv += `Movimenta√ß√µes Pendentes: ${historicoPendente.length}\n`;
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    link.setAttribute('href', url);
    link.setAttribute('download', `relatorio_completo_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert('Relat√≥rio completo gerado com sucesso!');
}

// ====================================================================
// FUN√á√ïES DE QR CODES (IMPLEMENTADAS)
// ====================================================================

function gerarTodosQRCodes() {
    const container = document.getElementById('qrCodesContainer');
    container.innerHTML = '';
    
    if (chaves.length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhuma chave cadastrada para gerar QR Codes.</p>';
        return;
    }
    
    chaves.forEach(chave => {
        const qrCard = document.createElement('div');
        qrCard.className = 'card mb-3';
        qrCard.style.width = '200px';
        qrCard.style.display = 'inline-block';
        qrCard.style.margin = '10px';
        qrCard.style.verticalAlign = 'top';
        
        qrCard.innerHTML = `
            <div class="card-body text-center">
                <h6 class="card-title">${chave.id}</h6>
                <p class="card-text small">${chave.nome}</p>
                <div id="qr-${chave.id}"></div>
                <button class="btn btn-sm btn-success mt-2" onclick="baixarQRCode('${chave.id}')">
                    <i class="fa fa-download"></i> Baixar
                </button>
            </div>
        `;
        
        container.appendChild(qrCard);
        
        // Gerar QR Code
        setTimeout(() => {
            const qrDiv = document.getElementById(`qr-${chave.id}`);
            if (qrDiv) {
                qrDiv.innerHTML = '';
                new QRCode(qrDiv, { 
                    text: chave.id, 
                    width: 120, 
                    height: 120,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }, 100);
    });
}

function baixarQRCode(chaveId) {
    const chave = chaves.find(c => c.id === chaveId);
    if (!chave) return;
    
    const qrDiv = document.getElementById(`qr-${chaveId}`);
    if (!qrDiv) return;
    
    const canvas = qrDiv.querySelector('canvas');
    if (!canvas) {
        alert('QR Code ainda n√£o foi gerado. Aguarde alguns segundos.');
        return;
    }
    
    const link = document.createElement('a');
    link.href = canvas.toDataURL('image/png');
    link.download = `QRCode_${chaveId}.png`;
    link.click();
}

async function baixarTodosQRCodes() {
    if (!window.JSZip) {
        alert('Biblioteca JSZip n√£o carregada. N√£o √© poss√≠vel gerar ZIP.');
        return;
    }
    
    if (chaves.length === 0) {
        alert('N√£o h√° chaves para gerar QR Codes.');
        return;
    }
    
    alert('A funcionalidade de baixar todos os QR Codes em ZIP requer a biblioteca JSZip. Esta funcionalidade ser√° implementada em breve.');
    
    // Implementa√ß√£o simplificada - baixa cada QR Code individualmente
    chaves.forEach((chave, index) => {
        setTimeout(() => {
            baixarQRCode(chave.id);
        }, index * 500); // Delay para evitar bloqueio do navegador
    });
}

function imprimirQRCodes() {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>QR Codes das Chaves</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .qr-container { display: flex; flex-wrap: wrap; gap: 20px; }
                    .qr-item { text-align: center; margin: 10px; }
                    .qr-item canvas { width: 150px; height: 150px; }
                </style>
            </head>
            <body>
                <h1>QR Codes das Chaves</h1>
                <div class="qr-container">
    `);
    
    chaves.forEach(chave => {
        // Criar canvas tempor√°rio para o QR Code
        const tempDiv = document.createElement('div');
        new QRCode(tempDiv, { 
            text: chave.id, 
            width: 150, 
            height: 150,
            colorDark: "#000000",
            colorLight: "#ffffff"
        });
        
        setTimeout(() => {
            const canvas = tempDiv.querySelector('canvas');
            if (canvas) {
                const dataUrl = canvas.toDataURL('image/png');
                printWindow.document.write(`
                    <div class="qr-item">
                        <h3>${chave.id}</h3>
                        <p>${chave.nome}</p>
                        <img src="${dataUrl}" alt="QR Code ${chave.id}">
                    </div>
                `);
            }
        }, 100);
    });
    
    printWindow.document.write(`
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        window.onafterprint = function() {
                            window.close();
                        };
                    };
                </script>
            </body>
        </html>
    `);
    printWindow.document.close();
}

// ====================================================================
// FUN√á√ïES AUXILIARES FALTANTES
// ====================================================================

function solicitarExclusaoColaborador(index) {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para excluir colaboradores.');
        return;
    }
    
    const colaborador = colaboradores[index];
    if (!colaborador) return;
    
    colaboradorParaExcluir = colaborador;
    
    document.getElementById('mensagemExclusao').textContent = 
        `Tem certeza que deseja excluir o colaborador "${colaborador.nome}" (ID: ${colaborador.id})?`;
    
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmarExclusao'));
    modal.show();
}

function confirmarExclusaoColaborador() {
    if (!colaboradorParaExcluir || !colaboradorParaExcluir.idDoc) {
        alert('Erro: Colaborador n√£o encontrado.');
        return;
    }
    
    db.collection("colaboradores").doc(colaboradorParaExcluir.idDoc).delete()
        .then(() => {
            alert(`Colaborador ${colaboradorParaExcluir.nome} exclu√≠do com sucesso!`);
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarExclusao'));
            if (modal) modal.hide();
            
            colaboradorParaExcluir = null;
        })
        .catch(error => {
            console.error("Erro ao excluir colaborador:", error);
            alert("Erro ao excluir colaborador. Verifique o console.");
        });
}

// ====================================================================
// FUN√á√ïES DE TESTE DO FIREBASE
// ====================================================================

function testFirebaseConnection() {
    console.log('Testando conex√£o com Firebase...');
    
    try {
        // Testar se o Firebase est√° dispon√≠vel
        if (typeof firebase === 'undefined') {
            console.error('Firebase n√£o carregado');
            showMessage('Erro: Firebase n√£o carregado. Verifique sua conex√£o.');
            return false;
        }
        
        // Testar se o auth est√° dispon√≠vel
        if (typeof firebase.auth === 'undefined') {
            console.error('Firebase Auth n√£o carregado');
            showMessage('Erro: Firebase Auth n√£o carregado.');
            return false;
        }
        
        console.log('Firebase carregado com sucesso');
        return true;
        
    } catch (error) {
        console.error('Erro ao testar Firebase:', error);
        showMessage('Erro ao inicializar Firebase: ' + error.message);
        return false;
    }
}

// ====================================================================
// FUN√á√ïES AUXILIARES PARA LEITOR DE C√ìDIGO DE BARRAS
// ====================================================================

function toggleLeitor() {
    const statusLeitor = document.getElementById('statusLeitor');
    const btnToggleLeitor = document.getElementById('btnToggleLeitor');
    const iconeLeitor = document.getElementById('iconeLeitor');
    
    if (statusLeitor.textContent === 'Desconectado') {
        statusLeitor.textContent = 'Conectado';
        statusLeitor.className = 'badge bg-success';
        btnToggleLeitor.innerHTML = '<i class="fa fa-plug"></i> Desconectar Leitor';
        btnToggleLeitor.className = 'btn btn-danger btn-sm';
        iconeLeitor.className = 'fa fa-barcode text-success';
        alert('Leitor conectado! Agora voc√™ pode escanear c√≥digos de barras dos IDs dos colaboradores.');
    } else {
        statusLeitor.textContent = 'Desconectado';
        statusLeitor.className = 'badge bg-danger';
        btnToggleLeitor.innerHTML = '<i class="fa fa-plug"></i> Conectar Leitor';
        btnToggleLeitor.className = 'btn btn-success btn-sm';
        iconeLeitor.className = 'fa fa-barcode text-muted';
    }
}

function testarLeitor() {
    // Simula a leitura de um c√≥digo de barras
    const idColInput = document.getElementById('idColRetirada');
    if (idColInput) {
        idColInput.value = '01'; // Valor de teste
        alert('Leitor testado! Valor simulado: 01');
    }
}

function toggleReconhecimentoVoz() {
    const statusVoz = document.getElementById('statusVoz');
    const btnToggleVoz = document.getElementById('btnToggleVoz');
    const iconeVoz = document.getElementById('iconeVoz');
    
    if (statusVoz.textContent === 'Inativo') {
        statusVoz.textContent = 'Ativo';
        statusVoz.className = 'badge bg-success';
        btnToggleVoz.innerHTML = '<i class="fa fa-microphone-slash"></i> Desativar Voz';
        btnToggleVoz.className = 'btn btn-danger btn-sm';
        iconeVoz.className = 'fa fa-microphone text-success';
        document.getElementById('voiceStatus').style.display = 'block';
        document.getElementById('voiceStatus').className = 'voice-status voice-active';
        alert('Reconhecimento de voz ativado! Ap√≥s escanear uma chave, fale o ID do colaborador.');
    } else {
        statusVoz.textContent = 'Inativo';
        statusVoz.className = 'badge bg-danger';
        btnToggleVoz.innerHTML = '<i class="fa fa-microphone"></i> Ativar Voz';
        btnToggleVoz.className = 'btn btn-success btn-sm';
        iconeVoz.className = 'fa fa-microphone text-muted';
        document.getElementById('voiceStatus').style.display = 'none';
    }
}

function testarVoz() {
    alert('Teste de voz: Diga "zero um" para simular o ID 01.');
}

function iniciarReconhecimentoVoz() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('Seu navegador n√£o suporta reconhecimento de voz. Use o leitor de c√≥digo de barras.');
        return;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    
    recognition.lang = 'pt-BR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    
    recognition.start();
    
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript.toLowerCase();
        let idCol = '';
        
        // Converter n√∫meros falados para d√≠gitos
        const numeros = {
            'zero': '0', 'um': '1', 'dois': '2', 'tr√™s': '3', 'quatro': '4',
            'cinco': '5', 'seis': '6', 'sete': '7', 'oito': '8', 'nove': '9'
        };
        
        const palavras = transcript.split(' ');
        palavras.forEach(palavra => {
            if (numeros[palavra]) {
                idCol += numeros[palavra];
            } else if (/^\d+$/.test(palavra)) {
                idCol += palavra;
            }
        });
        
        if (idCol) {
            document.getElementById('idColRetirada').value = idCol;
            alert(`ID reconhecido: ${idCol}`);
        } else {
            alert('N√£o foi poss√≠vel reconhecer um ID v√°lido. Tente novamente.');
        }
    };
    
    recognition.onerror = function(event) {
        console.error('Erro no reconhecimento de voz:', event.error);
        alert('Erro no reconhecimento de voz. Tente novamente.');
    };
}

// ====================================================================
// INICIALIZA√á√ÉO DO SISTEMA
// ====================================================================

// Inicializar verifica√ß√£o de autentica√ß√£o quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    console.log('P√°gina carregada. Iniciando sistema...');
    
    // Primeiro testar se o Firebase est√° funcionando
    if (testFirebaseConnection()) {
        checkAuthState();
    } else {
        // Mostrar mensagem de erro se o Firebase n√£o carregar
        const errorElement = document.getElementById('loginError');
        errorElement.textContent = 'Erro ao carregar Firebase. Verifique sua conex√£o com a internet.';
        errorElement.style.display = 'block';
    }
});

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
