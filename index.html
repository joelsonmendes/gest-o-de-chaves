<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Chaves ‚Äî SENAIHUB</title>

    <link rel="manifest" href="/manifest.json">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        /* =======================================
            ESTILOS BASE (DARK MODE)
            ======================================= */
        body {
            background: #121212;
            color: #fff;
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }
        
        /* Estilos para a tela de login */
        #loginScreen .form-control {
            background: #222 !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }

        #loginScreen .form-control:focus {
            border-color: #fd790d !important;
            box-shadow: 0 0 0 0.2rem rgba(253, 121, 13, 0.25) !important;
        }

        #loginScreen .alert {
            background: #dc3545;
            color: white;
            border: none;
        }

        #loginScreen .text-info {
            color: #17a2b8 !important;
            text-decoration: none;
        }

        #loginScreen .text-info:hover {
            color: #138496 !important;
            text-decoration: underline;
        }
        
        .content-wrapper {
            margin-left: 250px; /* Margem padr√£o para desktop */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .content {
            padding: 16px;
            flex-grow: 1;
        }
        .card {
            background: #1e1e1e;
            border: 1px solid #333;
            color: #fff;
        }
        input, select, textarea {
            background: #222 !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        input::placeholder {
            color: #aaa !important;
        }
        .btn-custom {
            background: #fd790d;
            border: none;
            color: #fff;
        }
        .btn-custom:hover {
            background: #48f005;
            color: #fff;
        }
        .qr-box canvas {
            display: block;
            margin: 15px auto 0;
            width: 200px !important;
            height: 200px !important;
        }
        .table > :not(caption) > * > * {
            background-color: #1e1e1e;
            color: #fff;
            padding: 0.6rem 0.6rem; /* <-- Diminui o espa√ßamento interno das c√©lulas */
        }

        /* =======================================
            SIDEBAR (BARRA LATERAL)
            ======================================= */
        .sidebar {
            height: 100vh;
            background: #1f1f1f;
            padding-top: 20px;
            position: fixed;
            width: 250px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar .logo-container {
            padding: 0 15px 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        .sidebar .logo-container img {
            /* Usando o nome do arquivo da sua imagem retangular (192x192) */
            max-width: 100%;
            height: auto;
            max-height: 60px;
        }
        .sidebar a {
            color: #999898;
            padding: 15px 20px;
            display: block;
            transition: 0.2s;
            font-size: 17px;
            text-decoration: none;
        }
        .sidebar a:hover, .activeMenu {
            background: #333;
            color: #fff !important;
        }
        
        /* √Årea do usu√°rio no sidebar */
        .user-area {
            margin-top: auto;
            border-top: 1px solid #333;
            padding: 15px 20px;
            background: #1a1a1a;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: #fd790d;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }

        /* =======================================
            FOOTER (RODAP√â)
            ======================================= */
        .footer {
            background: #1f1f1f;
            color: #ccc;
            text-align: center;
            padding: 15px 20px;
            font-size: 0.9em;
            border-top: 1px solid #333;
            margin-top: auto;
        }

        /* =======================================
            RESPONSIVIDADE (SMARTPHONE/TABLET)
            ======================================= */
        @media (max-width: 768px) {
            /* SIDEBAR: Vira um cabe√ßalho horizontal e rol√°vel */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative; 
                padding-top: 10px;
                flex-direction: row; 
                overflow-x: auto; 
                white-space: nowrap; 
                border-bottom: 1px solid #333;
            }

            /* Links do menu em linha */
            .sidebar a {
                display: inline-block;
                padding: 10px 15px;
                font-size: 15px;
            }

            /* Logo ocupa a largura total acima dos links */
            .sidebar .logo-container {
                display: block;
                text-align: center;
                width: 100%;
                border-bottom: none;
                margin-bottom: 5px;
            }

            /* CONTE√öDO: Remove a margem fixa */
            .content-wrapper {
                margin-left: 0;
                padding-top: 10px;
            }
            
            /* Ajustes para a √°rea do usu√°rio em mobile */
            .user-area {
                display: none; /* Oculta em mobile para economizar espa√ßo */
            }
        }

        /* =======================================
            ESTILOS ADICIONAIS PARA MELHOR UX
            ======================================= */
        .scanner-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .scanner-active {
            background: #1a331a;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        .scanner-paused {
            background: #332b1a;
            color: #FF9800;
            border: 1px solid #FF9800;
        }
        .status-disponivel {
            color: #4CAF50;
        }
        .status-retirada {
            color: #f44336;
        }
        .offline-indicator {
            background: #ff4444;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .online-indicator {
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .sync-status {
            background: #ff9800;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .pending-sync {
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        /* =======================================
            ESTILOS PARA A P√ÅGINA DE QR CODES
            ======================================= */
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .qr-card {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #444;
            transition: transform 0.2s;
        }
        .qr-card:hover {
            transform: translateY(-5px);
            border-color: #fd790d;
        }
        .qr-card canvas {
            margin: 0 auto;
        }
        .qr-info {
            margin-top: 15px;
        }
        .qr-info h5 {
            color: #fff;
            margin-bottom: 5px;
        }
        .qr-info .status {
            font-size: 0.9em;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        .status-disponivel-badge {
            background: #4CAF50;
            color: white;
        }
        .status-retirada-badge {
            background: #f44336;
            color: white;
        }
        
        /* =======================================
            ESTILOS PARA RELAT√ìRIOS
            ======================================= */
        .report-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .report-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* =======================================
            ESTILOS PARA O LEITOR DE C√ìDIGO DE BARRAS
            ======================================= */
        .leitor-section {
            background: #2d2d2d;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .leitor-section h5 {
            color: #fd790d;
            margin-bottom: 15px;
        }

        .leitor-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
        }

        /* =======================================
            ESTILOS PARA FUNCIONALIDADE DE VOZ
            ======================================= */
        .voice-control-section {
            background: #2d2d2d;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .voice-control-section h5 {
            color: #fd790d;
            margin-bottom: 15px;
        }

        .voice-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .voice-active {
            background: #1a331a;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .voice-inactive {
            background: #332b1a;
            color: #FF9800;
            border: 1px solid #FF9800;
        }

        .voice-instruction {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-style: italic;
            color: #ccc;
        }
        
        /* =======================================
            ESTILOS PARA TELA DE LOGIN
            ======================================= */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #121212 0%, #1a1a1a 100%);
        }
        
        .login-card {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo img {
            max-width: 150px;
            height: auto;
        }
        
        .login-title {
            text-align: center;
            color: #fff;
            margin-bottom: 5px;
            font-weight: 300;
        }
        
        .login-subtitle {
            text-align: center;
            color: #999;
            margin-bottom: 30px;
            font-size: 0.9em;
        }
        
        .login-error {
            background: #dc3545;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .login-divider {
            text-align: center;
            margin: 20px 0;
            color: #666;
            position: relative;
        }
        
        .login-divider::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #333;
        }
        
        .login-divider span {
            background: #1e1e1e;
            padding: 0 15px;
            position: relative;
        }
    </style>
</head>

<body>

<!-- =======================================
    TELA DE LOGIN
    ======================================= -->
<div id="loginScreen" class="login-container">
    <div class="login-card">
        <div class="login-logo">
            <img src="logo.png" alt="SENAIHUB Logo">
        </div>
        
        <h2 class="login-title">Gest√£o de Chaves SENAIHUB</h2>
        <p class="login-subtitle">Fa√ßa login para acessar o sistema</p>
        
        <div id="loginError" class="login-error"></div>
        
        <!-- Formul√°rio de Login -->
        <form id="loginForm" onsubmit="login(event)">
            <div class="mb-3">
                <label for="loginEmail" class="form-label text-white">Email</label>
                <input type="email" id="loginEmail" class="form-control" placeholder="seu@email.com" required>
            </div>
            
            <div class="mb-3">
                <label for="loginPassword" class="form-label text-white">Senha</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Sua senha" required>
                <div class="form-text text-muted">
                    <a href="#" onclick="showPasswordReset()" class="text-info" style="font-size: 0.9em;">Esqueceu a senha?</a>
                </div>
            </div>
            
            <button type="submit" class="btn btn-custom w-100 mb-3" id="btnLogin">
                <i class="fa fa-sign-in-alt"></i> Entrar
            </button>
            
            <div class="login-divider">
                <span>ou</span>
            </div>
            
            <div class="text-center">
                <a href="#" onclick="showRegister()" class="text-info">Criar nova conta</a>
            </div>
        </form>
        
        <!-- Formul√°rio de Registro -->
        <form id="registerForm" onsubmit="register(event)" style="display: none;">
            <div class="mb-3">
                <label for="registerName" class="form-label text-white">Nome completo</label>
                <input type="text" id="registerName" class="form-control" placeholder="Seu nome" required>
            </div>
            
            <div class="mb-3">
                <label for="registerEmail" class="form-label text-white">Email</label>
                <input type="email" id="registerEmail" class="form-control" placeholder="seu@email.com" required>
            </div>
            
            <div class="mb-3">
                <label for="registerPassword" class="form-label text-white">Senha (m√≠nimo 6 caracteres)</label>
                <input type="password" id="registerPassword" class="form-control" placeholder="Sua senha" minlength="6" required>
            </div>
            
            <div class="mb-3">
                <label for="registerConfirmPassword" class="form-label text-white">Confirmar senha</label>
                <input type="password" id="registerConfirmPassword" class="form-control" placeholder="Confirme a senha" required>
            </div>
            
            <button type="submit" class="btn btn-success w-100 mb-3" id="btnRegister">
                <i class="fa fa-user-plus"></i> Criar conta
            </button>
            
            <div class="text-center">
                <a href="#" onclick="showLogin()" class="text-info">Voltar para login</a>
            </div>
        </form>
        
        <!-- Formul√°rio de Recupera√ß√£o de Senha -->
        <form id="resetPasswordForm" onsubmit="resetPassword(event)" style="display: none;">
            <div class="mb-3">
                <label for="resetEmail" class="form-label text-white">Email</label>
                <input type="email" id="resetEmail" class="form-control" placeholder="seu@email.com" required>
                <div class="form-text text-muted">
                    Enviaremos um link para redefinir sua senha.
                </div>
            </div>
            
            <button type="submit" class="btn btn-warning w-100 mb-3" id="btnResetPassword">
                <i class="fa fa-envelope"></i> Enviar link de recupera√ß√£o
            </button>
            
            <div class="text-center">
                <a href="#" onclick="showLogin()" class="text-info">Voltar para login</a>
            </div>
        </form>
    </div>
</div>

<!-- =======================================
    CONTE√öDO PRINCIPAL (AP√ìS LOGIN)
    ======================================= -->
<div id="appContent" style="display: none; flex-direction: column; min-height: 100vh;">

<div class="sidebar">
    <div class="logo-container">
       <img src="logo.png" alt="SENAIHUB Logo">
    </div>
    <a href="#" onclick="showPage('home', event)" class="activeMenu"><i class="fa fa-home"></i> Home</a>
    <a href="#" onclick="showPage('chaves', event)"><i class="fa fa-key"></i> Chaves</a>
    <a href="#" onclick="showPage('colaboradores', event)"><i class="fa fa-users"></i> Colaboradores</a>
    <a href="#" onclick="showPage('qr-codes', event)"><i class="fa fa-qrcode"></i> Todos QR Codes</a>
    <a href="#" onclick="showPage('historico', event)"><i class="fa fa-clock-rotate-left"></i> Hist√≥rico</a>
    <a href="#" onclick="showPage('qr', event)"><i class="fa fa-camera"></i> Retirar por QR Code</a>
    <a href="#" onclick="showPage('relatorios', event)"><i class="fa fa-chart-bar"></i> Relat√≥rios</a>
    <a href="#" onclick="showPage('offline', event)"><i class="fa fa-cloud"></i> Dados Offline</a>
    
    <!-- √Årea do Usu√°rio -->
    <div class="user-area">
        <div class="user-info">
            <div class="user-avatar" id="userAvatar">
                U
            </div>
            <div>
                <div class="text-white small" id="userName">Usu√°rio</div>
                <div class="text-muted x-small" id="userEmailDisplay">email@exemplo.com</div>
            </div>
        </div>
        <a href="#" onclick="logout()" class="text-danger" style="display: block; text-align: center;">
            <i class="fa fa-sign-out-alt"></i> Sair
        </a>
    </div>
</div>

<div class="content-wrapper"> 
    <div class="content">

        <!-- Indicadores de Status de Conex√£o -->
        <div id="onlineIndicator" class="online-indicator">
            <i class="fa fa-wifi"></i> Conectado - Dados sincronizados
        </div>
        <div id="offlineIndicator" class="offline-indicator">
            <i class="fa fa-wifi-slash"></i> Modo Offline - Dados ser√£o sincronizados quando a conex√£o voltar
        </div>
        <div id="syncStatus" class="sync-status">
            <i class="fa fa-refresh fa-spin"></i> Sincronizando dados pendentes...
        </div>

        <section id="home">
            <h1 class="mb-4">üîë Sistema de Gest√£o de Chaves</h1>
            <p class="text-muted">Bem-vindo, <span id="welcomeUser">Usu√°rio</span>!</p>
            <hr/>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-key text-info"></i> Chaves</h3>
                        <p class="mb-0">Total Registradas: <span id="totalChaves" class="fw-bold">0</span></p>
                        <p class="mb-0">Dispon√≠veis: <span id="chavesDisponiveis" class="fw-bold">0</span></p>
                        <p class="mb-0">Retiradas: <span id="chavesRetiradas" class="fw-bold">0</span></p>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-users text-warning"></i> Colaboradores</h3>
                        <p>Total: <span id="totalCol" class="fw-bold">0</span></p>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-clock-rotate-left text-success"></i> Hist√≥rico</h3>
                        <p>Total: <span id="totalHist" class="fw-bold">0</span></p>
                        <p class="mb-0">Pendentes: <span id="pendentesSync" class="fw-bold text-warning">0</span></p>
                    </div>
                </div>
            </div>
        </section>

        <section id="chaves" style="display:none;">
            <h2><i class="fa fa-key text-info"></i> Gest√£o de Chaves</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Cadastrar Chave</h4>
                <input id="nomeChave" placeholder="Nome da chave (Ex: Sala 101)" class="form-control mt-2">
                <button class="btn btn-custom mt-2" onclick="cadastrarChave()">
                    <i class="fa fa-plus"></i> Cadastrar e Gerar QR Code
                </button>

                <div id="qrCodeArea" class="qr-box text-center mt-3"></div>
            </div>

            <div class="card p-3 mt-4">
                <h4>Buscar Chaves</h4>
                <input id="buscaChaves" class="form-control" placeholder="Pesquisar por ID ou nome..." onkeyup="filtrarChaves()">
            </div>

            <div class="card mt-3 p-3">
                <h4>Lista de Chaves</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaChaves"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="colaboradores" style="display:none;">
            <h2><i class="fa fa-users text-warning"></i> Gest√£o de Colaboradores</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Cadastrar Colaborador</h4>
                <input id="nomeColaborador" placeholder="Nome do colaborador" class="form-control mt-2">
                <button class="btn btn-custom mt-3" onclick="cadastrarColaborador()">
                    <i class="fa fa-user-plus"></i> Cadastrar
                </button>
                <p class="mt-3 mb-0"><b>√öltimo ID gerado:</b> <span id="ultimoColID" class="fw-bold">Nenhum</span></p>
            </div>

            <div class="card mt-4 p-4">
                <h4>Lista de Colaboradores</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaColaboradores"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="qr-codes" style="display:none;">
            <h2><i class="fa fa-qrcode text-info"></i> Todos os QR Codes das Chaves</h2>
            <hr/>
            
            <div class="card p-4">
                <h4>QR Codes para Impress√£o</h4>
                <p class="text-muted">Todos os QR codes das chaves cadastradas no sistema. Clique em "Baixar" para salvar individualmente.</p>
                
                <div class="mb-3">
                    <button class="btn btn-success" onclick="baixarTodosQRCodes()">
                        <i class="fa fa-download"></i> Baixar Todos os QR Codes (ZIP)
                    </button>
                    <button class="btn btn-info ms-2" onclick="imprimirQRCodes()">
                        <i class="fa fa-print"></i> Imprimir Todos
                    </button>
                </div>
                
                <div id="qrCodesContainer" class="qr-grid">
                    <!-- Os QR Codes ser√£o gerados aqui -->
                </div>
            </div>
        </section>

        <section id="historico" style="display:none;">
            <h2><i class="fa fa-clock-rotate-left text-success"></i> Hist√≥rico de Movimenta√ß√µes</h2>
            <hr/>

            <div class="card p-3 mb-4">
                <h4>Relat√≥rios</h4>
                <button class="btn btn-success mt-2" onclick="gerarRelatorioHistorico()">
                    <i class="fa fa-download"></i> Baixar Relat√≥rio Completo (CSV)
                </button>
                <button class="btn btn-warning mt-2 ms-2" onclick="sincronizarDadosPendentes()">
                    <i class="fa fa-refresh"></i> Sincronizar Dados Pendentes
                </button>
            </div>

            <div class="card mt-3 p-3">
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Chave (ID)</th>
                                <th>Colaborador</th>
                                <th>A√ß√£o</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Usu√°rio</th>
                            </tr>
                        </thead>
                        <tbody id="listaHistorico"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="qr" style="display:none;">
            <h2><i class="fa fa-qrcode text-info"></i> Retirada por QR Code</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Escanear QR Code da Chave</h4>
                
                <!-- Controle do Leitor de C√≥digo de Barras -->
                <div class="card p-3 mb-3 leitor-section">
                    <h5><i id="iconeLeitor" class="fa fa-barcode text-muted"></i> Leitor de C√≥digo de Barras LB-W110BK</h5>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Status:</strong> 
                                <span id="statusLeitor" class="badge bg-danger">Desconectado</span>
                            </p>
                            <small class="text-muted">Modo: Emula√ß√£o de Teclado</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="btnToggleLeitor" class="btn btn-success btn-sm" onclick="toggleLeitor()">
                                <i class="fa fa-plug"></i> Conectar Leitor
                            </button>
                            <button class="btn btn-info btn-sm ms-2" onclick="testarLeitor()">
                                <i class="fa fa-test"></i> Testar
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fa fa-info-circle"></i> 
                            Conecte o leitor via USB e clique em "Conectar Leitor". O leitor funciona automaticamente como um teclado.
                        </small>
                    </div>
                </div>

                <!-- Controle de Voz -->
                <div class="card p-3 mb-3 voice-control-section">
                    <h5><i id="iconeVoz" class="fa fa-microphone text-muted"></i> Assistente de Voz</h5>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Status:</strong> 
                                <span id="statusVoz" class="badge bg-danger">Inativo</span>
                            </p>
                            <small class="text-muted">Reconhecimento de voz para ID do colaborador</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="btnToggleVoz" class="btn btn-success btn-sm" onclick="toggleReconhecimentoVoz()">
                                <i class="fa fa-microphone"></i> Ativar Voz
                            </button>
                            <button class="btn btn-info btn-sm ms-2" onclick="testarVoz()">
                                <i class="fa fa-test"></i> Testar Voz
                            </button>
                        </div>
                    </div>
                    
                    <div id="voiceStatus" class="voice-status voice-inactive" style="display: none;">
                        <i class="fa fa-microphone"></i> Aguardando comando de voz...
                    </div>
                    
                    <div class="voice-instruction">
                        <strong>Instru√ß√µes:</strong> Ap√≥s escanear o QR Code da chave, o sistema perguntar√° "Qual o ID do colaborador?". 
                        Responda com o n√∫mero do ID (exemplo: "zero um" para ID 01).
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fa fa-info-circle"></i> 
                            O reconhecimento de voz funciona melhor com fones de ouvido e em ambiente silencioso.
                        </small>
                    </div>
                </div>

                <!-- Status do Scanner de C√¢mera -->
                <div id="scannerStatus" class="scanner-status scanner-active" style="display: none;">
                    <i class="fa fa-camera"></i> Scanner de c√¢mera ativo
                </div>
                
                <div id="reader" style="width:300px; margin: 0 auto;"></div>

                <div class="mt-3 text-center">
                    <button id="btnToggleScanner" class="btn btn-outline-warning btn-sm" onclick="toggleScanner()" style="display: none;">
                        <i class="fa fa-pause"></i> Pausar Scanner C√¢mera
                    </button>
                </div>

                <p class="mt-3"><b>Chave detectada:</b> <span id="chaveDetectada" class="fw-bold text-info">Nenhuma</span></p>

                <div id="areaConfirmacao" style="display:none;">
                    <div class="input-group">
                        <input id="idColRetirada" placeholder="ID do colaborador (use o leitor ou voz)" class="form-control">
                        <button class="btn btn-outline-secondary" type="button" onclick="testarLeitor()">
                            <i class="fa fa-barcode"></i> Testar Leitor
                        </button>
                        <button class="btn btn-outline-info" type="button" onclick="iniciarReconhecimentoVoz()">
                            <i class="fa fa-microphone"></i> Voz
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">
                        Aponte o leitor para o c√≥digo de barras do ID do colaborador OU use o comando de voz
                    </small>
                    
                    <div class="mt-3">
                        <button id="btnConfirmarRetirada" class="btn btn-success w-100" onclick="confirmarRetirada()">
                            <i class="fa fa-check"></i> Confirmar Retirada
                        </button>
                        <button id="btnDevolverChave" class="btn btn-primary w-100 mt-2" onclick="confirmarDevolucao()">
                            <i class="fa fa-reply"></i> Confirmar Devolu√ß√£o
                        </button>
                    </div>
                    
                    <button class="btn btn-outline-light w-100 mt-2" onclick="reiniciarScanner()">
                        <i class="fa fa-refresh"></i> Escanear Novamente
                    </button>
                </div>
            </div>
        </section>

        <section id="relatorios" style="display:none;">
            <h2><i class="fa fa-chart-bar text-warning"></i> Relat√≥rios do Sistema</h2>
            <hr/>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioChaves()">
                        <div class="text-center">
                            <i class="fa fa-key fa-3x text-info mb-3"></i>
                            <h4>Relat√≥rio de Chaves</h4>
                            <p class="text-muted">Lista completa de todas as chaves cadastradas com seus status atualizados</p>
                            <button class="btn btn-info w-100">
                                <i class="fa fa-download"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioColaboradores()">
                        <div class="text-center">
                            <i class="fa fa-users fa-3x text-warning mb-3"></i>
                            <h4>Relat√≥rio de Colaboradores</h4>
                            <p class="text-muted">Lista completa de todos os colaboradores cadastrados no sistema</p>
                            <button class="btn btn-warning w-100">
                                <i class="fa fa-download"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioHistorico()">
                        <div class="text-center">
                            <i class="fa fa-history fa-3x text-success mb-3"></i>
                            <h4>Relat√≥rio de Hist√≥rico</h4>
                            <p class="text-muted">Hist√≥rico completo de todas as movimenta√ß√µes do sistema</p>
                            <button class="btn btn-success w-100">
                                <i class="fa fa-download"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioCompleto()">
                        <div class="text-center">
                            <i class="fa fa-file-alt fa-3x text-primary mb-3"></i>
                            <h4>Relat√≥rio Completo</h4>
                            <p class="text-muted">Relat√≥rio consolidado com todos os dados do sistema</p>
                            <button class="btn btn-primary w-100">
                                <i class="fa fa-download"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4 p-4">
                <h4>Estat√≠sticas do Sistema</h4>
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statChavesTotal">0</h3>
                            <p class="mb-0">Total de Chaves</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statChavesDisponiveis">0</h3>
                            <p class="mb-0">Chaves Dispon√≠veis</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statColaboradoresTotal">0</h3>
                            <p class="mb-0">Colaboradores</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statMovimentacoesTotal">0</h3>
                            <p class="mb-0">Movimenta√ß√µes</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="offline" style="display:none;">
            <h2><i class="fa fa-cloud text-warning"></i> Gerenciamento de Dados Offline</h2>
            <hr/>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card p-4">
                        <h4><i class="fa fa-database"></i> Status de Sincroniza√ß√£o</h4>
                        <p><strong>Status da Conex√£o:</strong> 
                            <span id="statusConexao" class="badge bg-success">Online</span>
                        </p>
                        <p><strong>Movimenta√ß√µes Pendentes:</strong> 
                            <span id="contadorPendentes" class="fw-bold text-warning">0</span>
                        </p>
                        <p><strong>√öltima Sincroniza√ß√£o:</strong> 
                            <span id="ultimaSync" class="fw-bold">Nunca</span>
                        </p>
                        
                        <button class="btn btn-warning w-100 mt-3" onclick="sincronizarDadosPendentes()">
                            <i class="fa fa-refresh"></i> Sincronizar Agora
                        </button>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card p-4">
                        <h4><i class="fa fa-info-circle"></i> Informa√ß√µes Offline</h4>
                        <p>O sistema funciona mesmo sem internet. As movimenta√ß√µes s√£o salvas localmente e sincronizadas automaticamente quando a conex√£o voltar.</p>
                        
                        <div class="alert alert-info mt-3">
                            <small>
                                <strong>Dicas:</strong><br>
                                ‚Ä¢ Todas as opera√ß√µes funcionam offline<br>
                                ‚Ä¢ Os dados s√£o sincronizados automaticamente<br>
                                ‚Ä¢ O hist√≥rico mostra o status de cada registro
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4 p-4">
                <h4>Movimenta√ß√µes Pendentes de Sincroniza√ß√£o</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Chave</th>
                                <th>Colaborador</th>
                                <th>A√ß√£o</th>
                                <th>Data Local</th>
                                <th>Usu√°rio</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaPendentes"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </div> 

    <footer class="footer">
        <p>&copy; 2025 SENAIHUB. Todos os direitos reservados. Desenvolvido para Gest√£o de Chaves. Autor: Joelson M. Mendes</p>
        <p>Vers√£o 3.3.0 (Sistema de Autentica√ß√£o Adicionado)</p>
    </footer>

</div> 

</div> <!-- Fim do appContent -->

<!-- Modal para Confirma√ß√£o de Exclus√£o -->
<div class="modal fade" id="modalConfirmarExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Exclus√£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="mensagemExclusao">Tem certeza que deseja excluir este colaborador?</p>
                <p class="text-warning"><strong>Aten√ß√£o:</strong> Esta a√ß√£o n√£o pode ser desfeita!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Edi√ß√£o -->
<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <label for="modalInput" class="form-label text-white">Novo Nome:</label>
                <input id="modalInput" class="form-control" placeholder="Digite o novo nome">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="btnSalvarEdicao">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================
// ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†SCRIPT DO SISTEMA (com Firebase + Autentica√ß√£o)
// ============================================================

// Vari√°veis Globais
let chaves = [];
let colaboradores = [];
let historico = [];
let historicoPendente = [];
let contadorChave = 0; 
let contadorColaborador = 0;
let itemEditando = null;
let tipoEdicao = null;
let chaveSelecionada = null;
let html5QrcodeScanner = null;
let db = null; 
let scannerAtivo = false;
let scannerPausado = false;
let isOnline = true;
let colaboradorParaExcluir = null;

// Vari√°veis para o leitor LB-W110BK
let leitorConectado = false;
let codigoBuffer = '';
let timeoutBuffer;

// Vari√°veis para reconhecimento de voz
let reconhecimentoVoz = null;
let vozAtiva = false;
let aguardandoRespostaVoz = false;

// Vari√°veis de autentica√ß√£o
let currentUser = null;

/* ==================================
¬† ¬† CONFIGURA√á√ÉO DO FIREBASE
================================== */
const firebaseConfig = {
¬† apiKey: "AIzaSyBxtaE405vs6mpuX5ufMu38s9wr3Hn0io8", 
¬† authDomain: "gestao-chaves-app.firebaseapp.com",
¬† projectId: "gestao-chaves-app", 
¬† storageBucket:"gestao-chaves-app.firebasestorage.app",
¬† messagingSenderId: "391255964652",
¬† appId: "1:391255964652:web:6d27bb36bc9ff520349ec9",
};

// ====================================================================
// FUN√á√ïES DE AUTENTICA√á√ÉO
// ====================================================================

function showLogin() {
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('resetPasswordForm').style.display = 'none';
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginError').textContent = '';
}

function showRegister() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
    document.getElementById('resetPasswordForm').style.display = 'none';
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginError').textContent = '';
}

function showPasswordReset() {
    document.getElementById('loginForm').style.display = 'none';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('resetPasswordForm').style.display = 'block';
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('loginError').textContent = '';
}

function login(event) {
    event.preventDefault();
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorElement = document.getElementById('loginError');
    
    errorElement.style.display = 'none';
    errorElement.textContent = '';
    
    const btnLogin = document.getElementById('btnLogin');
    const originalText = btnLogin.innerHTML;
    btnLogin.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Entrando...';
    btnLogin.disabled = true;
    
    firebase.auth().signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // Sucesso
            currentUser = userCredential.user;
            showAppContent();
        })
        .catch((error) => {
            // Tratamento de erros
            let errorMessage = 'Erro ao fazer login. ';
            
            switch(error.code) {
                case 'auth/invalid-email':
                    errorMessage += 'Email inv√°lido.';
                    break;
                case 'auth/user-disabled':
                    errorMessage += 'Esta conta foi desativada.';
                    break;
                case 'auth/user-not-found':
                    errorMessage += 'Usu√°rio n√£o encontrado.';
                    break;
                case 'auth/wrong-password':
                    errorMessage += 'Senha incorreta.';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';
        })
        .finally(() => {
            btnLogin.innerHTML = originalText;
            btnLogin.disabled = false;
        });
}

function register(event) {
    event.preventDefault();
    
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('registerConfirmPassword').value;
    const errorElement = document.getElementById('loginError');
    
    errorElement.style.display = 'none';
    errorElement.textContent = '';
    
    // Valida√ß√£o b√°sica
    if (password !== confirmPassword) {
        errorElement.textContent = 'As senhas n√£o coincidem.';
        errorElement.style.display = 'block';
        return;
    }
    
    if (password.length < 6) {
        errorElement.textContent = 'A senha deve ter no m√≠nimo 6 caracteres.';
        errorElement.style.display = 'block';
        return;
    }
    
    const btnRegister = document.getElementById('btnRegister');
    const originalText = btnRegister.innerHTML;
    btnRegister.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Criando conta...';
    btnRegister.disabled = true;
    
    firebase.auth().createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
            // Atualizar perfil do usu√°rio com o nome
            return userCredential.user.updateProfile({
                displayName: name
            });
        })
        .then(() => {
            // Salvar informa√ß√µes adicionais no Firestore
            return db.collection('usuarios').doc(firebase.auth().currentUser.uid).set({
                nome: name,
                email: email,
                dataCriacao: firebase.firestore.FieldValue.serverTimestamp(),
                tipo: 'usuario'
            });
        })
        .then(() => {
            currentUser = firebase.auth().currentUser;
            alert('Conta criada com sucesso!');
            showAppContent();
        })
        .catch((error) => {
            let errorMessage = 'Erro ao criar conta. ';
            
            switch(error.code) {
                case 'auth/email-already-in-use':
                    errorMessage += 'Este email j√° est√° em uso.';
                    break;
                case 'auth/invalid-email':
                    errorMessage += 'Email inv√°lido.';
                    break;
                case 'auth/weak-password':
                    errorMessage += 'A senha √© muito fraca.';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';
        })
        .finally(() => {
            btnRegister.innerHTML = originalText;
            btnRegister.disabled = false;
        });
}

function resetPassword(event) {
    event.preventDefault();
    
    const email = document.getElementById('resetEmail').value;
    const errorElement = document.getElementById('loginError');
    
    errorElement.style.display = 'none';
    errorElement.textContent = '';
    
    const btnReset = document.getElementById('btnResetPassword');
    const originalText = btnReset.innerHTML;
    btnReset.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Enviando...';
    btnReset.disabled = true;
    
    firebase.auth().sendPasswordResetEmail(email)
        .then(() => {
            alert('Email de recupera√ß√£o enviado! Verifique sua caixa de entrada.');
            showLogin();
        })
        .catch((error) => {
            let errorMessage = 'Erro ao enviar email de recupera√ß√£o. ';
            
            switch(error.code) {
                case 'auth/invalid-email':
                    errorMessage += 'Email inv√°lido.';
                    break;
                case 'auth/user-not-found':
                    errorMessage += 'Usu√°rio n√£o encontrado.';
                    break;
                default:
                    errorMessage += error.message;
            }
            
            errorElement.textContent = errorMessage;
            errorElement.style.display = 'block';
        })
        .finally(() => {
            btnReset.innerHTML = originalText;
            btnReset.disabled = false;
        });
}

function logout() {
    if (confirm('Tem certeza que deseja sair?')) {
        firebase.auth().signOut()
            .then(() => {
                currentUser = null;
                hideAppContent();
                showLogin();
            })
            .catch((error) => {
                console.error('Erro ao fazer logout:', error);
                alert('Erro ao fazer logout. Tente novamente.');
            });
    }
}

function showAppContent() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appContent').style.display = 'flex';
    
    // Atualizar informa√ß√µes do usu√°rio
    if (currentUser) {
        const displayName = currentUser.displayName || currentUser.email.split('@')[0];
        const firstLetter = displayName.charAt(0).toUpperCase();
        
        document.getElementById('userName').textContent = displayName;
        document.getElementById('userEmailDisplay').textContent = currentUser.email;
        document.getElementById('userAvatar').textContent = firstLetter;
        document.getElementById('welcomeUser').textContent = displayName;
        
        // Gerar cor de avatar baseada no email
        const colors = ['#fd790d', '#48f005', '#007bff', '#6f42c1', '#e83e8c'];
        const colorIndex = currentUser.email.length % colors.length;
        document.getElementById('userAvatar').style.background = colors[colorIndex];
    }
    
    // Iniciar o sistema ap√≥s login
    iniciarSistema();
}

function hideAppContent() {
    document.getElementById('appContent').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    
    // Limpar campos de login
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
    document.getElementById('registerName').value = '';
    document.getElementById('registerEmail').value = '';
    document.getElementById('registerPassword').value = '';
    document.getElementById('registerConfirmPassword').value = '';
    document.getElementById('resetEmail').value = '';
    
    // Mostrar formul√°rio de login
    showLogin();
}

// Verificar estado de autentica√ß√£o
function checkAuthState() {
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // Usu√°rio est√° logado
            currentUser = user;
            showAppContent();
        } else {
            // Usu√°rio n√£o est√° logado
            currentUser = null;
            hideAppContent();
        }
    });
}

function iniciarSistema() {
    // S√≥ inicializa o sistema se o usu√°rio estiver autenticado
    if (!currentUser) {
        console.error('Usu√°rio n√£o autenticado');
        return;
    }
    
    // Inicializa o Firebase e o Firestore
    const app = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();

    // Configura detec√ß√£o de conectividade
    configurarDetecaoConexao();

    // Carrega dados pendentes do localStorage
    carregarDadosOffline();

    // Inicia os listeners (carregamento em tempo real do Firebase)
    carregarChavesFirebase();
    carregarColaboradoresFirebase();
    carregarHistoricoFirebase();

    document.getElementById("btnSalvarEdicao").addEventListener("click", salvarEdicao);
    document.getElementById("btnConfirmarExclusao").addEventListener("click", confirmarExclusaoColaborador);

    // Inicializa o leitor automaticamente (modo teclado sempre dispon√≠vel)
    setTimeout(() => {
        inicializarLeitorTeclado();
    }, 1000);

    // Inicializa o reconhecimento de voz
    inicializarReconhecimentoVoz();

    // Tenta sincronizar dados pendentes ao iniciar
    setTimeout(sincronizarDadosPendentes, 2000);
}

// ====================================================================
// FUNCIONALIDADE DE RECONHECIMENTO DE VOZ
// ====================================================================

function inicializarReconhecimentoVoz() {
¬† ¬† // Verifica se o navegador suporta reconhecimento de voz
¬† ¬† if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
¬† ¬† ¬† ¬† console.warn('Reconhecimento de voz n√£o suportado neste navegador');
¬† ¬† ¬† ¬† document.getElementById('btnToggleVoz').disabled = true;
¬† ¬† ¬† ¬† document.getElementById('btnToggleVoz').innerHTML = '<i class="fa fa-microphone-slash"></i> N√£o Suportado';
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† // Cria inst√¢ncia do reconhecimento de voz
¬† ¬† const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
¬† ¬† reconhecimentoVoz = new SpeechRecognition();
¬† ¬† 
¬† ¬† // Configura√ß√µes
¬† ¬† reconhecimentoVoz.continuous = false;
¬† ¬† reconhecimentoVoz.interimResults = false;
¬† ¬† reconhecimentoVoz.lang = 'pt-BR';

¬† ¬† // Eventos
¬† ¬† reconhecimentoVoz.onstart = function() {
¬† ¬† ¬† ¬† console.log('Reconhecimento de voz iniciado');
¬† ¬† ¬† ¬† atualizarStatusVozInterface(true, true);
¬† ¬† };

¬† ¬† reconhecimentoVoz.onresult = function(event) {
¬† ¬† ¬† ¬† const transcript = event.results[0][0].transcript.trim();
¬† ¬† ¬† ¬† console.log('Texto reconhecido:', transcript);
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† processarComandoVoz(transcript);
¬† ¬† };

¬† ¬† reconhecimentoVoz.onerror = function(event) {
¬† ¬† ¬† ¬† console.error('Erro no reconhecimento de voz:', event.error);
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† if (event.error === 'not-allowed') {
¬† ¬† ¬† ¬† ¬† ¬† alert('Permiss√£o para uso do microfone negada. Por favor, permita o acesso ao microfone.');
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† atualizarStatusVozInterface(false, false);
¬† ¬† ¬† ¬† aguardandoRespostaVoz = false;
¬† ¬† };

¬† ¬† reconhecimentoVoz.onend = function() {
¬† ¬† ¬† ¬† console.log('Reconhecimento de voz finalizado');
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† // Se ainda estiver aguardando resposta, reinicia o reconhecimento
¬† ¬† ¬† ¬† if (aguardandoRespostaVoz && vozAtiva) {
¬† ¬† ¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† reconhecimentoVoz.start();
¬† ¬† ¬† ¬† ¬† ¬† }, 500);
¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† atualizarStatusVozInterface(vozAtiva, false);
¬† ¬† ¬† ¬† }
¬† ¬† };
}

function toggleReconhecimentoVoz() {
¬† ¬† if (vozAtiva) {
¬† ¬† ¬† ¬† desativarReconhecimentoVoz();
¬† ¬† } else {
¬† ¬† ¬† ¬† ativarReconhecimentoVoz();
¬† ¬† }
}

function ativarReconhecimentoVoz() {
¬† ¬† if (!reconhecimentoVoz) {
¬† ¬† ¬† ¬† alert('Reconhecimento de voz n√£o est√° dispon√≠vel neste navegador.');
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† vozAtiva = true;
¬† ¬† aguardandoRespostaVoz = false;
¬† ¬† 
¬† ¬† // Solicita permiss√£o do usu√°rio
¬† ¬† reconhecimentoVoz.start();
¬† ¬† 
¬† ¬† alert('Assistente de voz ativado! Ap√≥s escanear um QR Code, o sistema perguntar√° qual o ID do colaborador.');
}

function desativarReconhecimentoVoz() {
¬† ¬† vozAtiva = false;
¬† ¬† aguardandoRespostaVoz = false;
¬† ¬† 
¬† ¬† if (reconhecimentoVoz) {
¬† ¬† ¬† ¬† reconhecimentoVoz.stop();
¬† ¬† }
¬† ¬† 
¬† ¬† atualizarStatusVozInterface(false, false);
¬† ¬† alert('Assistente de voz desativado.');
}

function iniciarReconhecimentoVoz() {
¬† ¬† if (!vozAtiva) {
¬† ¬† ¬† ¬† alert('Ative o reconhecimento de voz primeiro!');
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† if (!reconhecimentoVoz) {
¬† ¬† ¬† ¬† alert('Reconhecimento de voz n√£o dispon√≠vel.');
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† try {
¬† ¬† ¬† ¬† reconhecimentoVoz.start();
¬† ¬† ¬† ¬† atualizarStatusVozInterface(true, true);
¬† ¬† } catch (error) {
¬† ¬† ¬† ¬† console.error('Erro ao iniciar reconhecimento de voz:', error);
¬† ¬† }
}

function processarComandoVoz(comando) {
¬† ¬† console.log('Processando comando de voz:', comando);
¬† ¬† 
¬† ¬† // Converte n√∫meros por extenso para d√≠gitos
¬† ¬† const textoProcessado = converterNumerosPorExtenso(comando);
¬† ¬† 
¬† ¬† // Extrai apenas n√∫meros do comando
¬† ¬† const numeros = textoProcessado.match(/\d+/g);
¬† ¬† 
¬† ¬† if (numeros && numeros.length > 0) {
¬† ¬† ¬† ¬† const idColaborador = numeros.join('');
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† // Verifica se √© um ID v√°lido (apenas n√∫meros)
¬† ¬† ¬† ¬† if (/^\d+$/.test(idColaborador)) {
¬† ¬† ¬† ¬† ¬† ¬† document.getElementById('idColRetirada').value = idColaborador;
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† // Feedback visual
¬† ¬† ¬† ¬† ¬† ¬† const inputElement = document.getElementById('idColRetirada');
¬† ¬† ¬† ¬† ¬† ¬† inputElement.style.borderColor = '#4CAF50';
¬† ¬† ¬† ¬† ¬† ¬† inputElement.style.backgroundColor = '#1a331a';
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† inputElement.style.borderColor = '';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† inputElement.style.backgroundColor = '';
¬† ¬† ¬† ¬† ¬† ¬† }, 2000);
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† // Foca no bot√£o de confirma√ß√£o apropriado
¬† ¬† ¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const btnRetirada = document.getElementById('btnConfirmarRetirada');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const btnDevolucao = document.getElementById('btnDevolverChave');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (btnRetirada.style.display !== 'none') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† btnRetirada.focus();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else if (btnDevolucao.style.display !== 'none') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† btnDevolucao.focus();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† }, 100);
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† falarTexto(`ID ${idColaborador} reconhecido. Pressione o bot√£o de confirma√ß√£o.`);
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† falarTexto('ID inv√°lido. Por favor, diga apenas n√∫meros.');
¬† ¬† ¬† ¬† }
¬† ¬† } else {
¬† ¬† ¬† ¬† falarTexto('N√£o entendi o ID. Por favor, diga o n√∫mero do colaborador.');
¬† ¬† }
¬† ¬† 
¬† ¬† aguardandoRespostaVoz = false;
}

function converterNumerosPorExtenso(texto) {
¬† ¬† const numerosPorExtenso = {
¬† ¬† ¬† ¬† 'zero': '0', 'um': '1', 'dois': '2', 'tr√™s': '3', 'quatro': '4',
¬† ¬† ¬† ¬† 'cinco': '5', 'seis': '6', 'sete': '7', 'oito': '8', 'nove': '9',
¬† ¬† ¬† ¬† 'dez': '10', 'onze': '11', 'doze': '12', 'treze': '13', 'catorze': '14',
¬† ¬† ¬† ¬† 'quinze': '15', 'dezesseis': '16', 'dezessete': '17', 'dezoito': '18',
¬† ¬† ¬† ¬† 'dezenove': '19', 'vinte': '20'
¬† ¬† };
¬† ¬† 
¬† ¬† let textoConvertido = texto.toLowerCase();
¬† ¬† 
¬† ¬† for (const [extenso, numero] of Object.entries(numerosPorExtenso)) {
¬† ¬† ¬† ¬† const regex = new RegExp('\\b' + extenso + '\\b', 'g');
¬† ¬† ¬† ¬† textoConvertido = textoConvertido.replace(regex, numero);
¬† ¬† }
¬† ¬† 
¬† ¬† return textoConvertido;
}

function falarTexto(texto) {
¬† ¬† if ('speechSynthesis' in window) {
¬† ¬† ¬† ¬† const utterance = new SpeechSynthesisUtterance(texto);
¬† ¬† ¬† ¬† utterance.lang = 'pt-BR';
¬† ¬† ¬† ¬† utterance.rate = 1.0;
¬† ¬† ¬† ¬† utterance.pitch = 1.0;
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† window.speechSynthesis.speak(utterance);
¬† ¬† }
}

function perguntarIdColaborador() {
¬† ¬† if (vozAtiva) {
¬† ¬† ¬† ¬† aguardandoRespostaVoz = true;
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† falarTexto('Qual o ID do colaborador?');
¬† ¬† ¬† ¬† }, 500);
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† if (reconhecimentoVoz && aguardandoRespostaVoz) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† reconhecimentoVoz.start();
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }, 1500);
¬† ¬† }
}

function atualizarStatusVozInterface(ativa, ouvindo) {
¬† ¬† const statusElement = document.getElementById('statusVoz');
¬† ¬† const btnToggle = document.getElementById('btnToggleVoz');
¬† ¬† const iconeVoz = document.getElementById('iconeVoz');
¬† ¬† const voiceStatusElement = document.getElementById('voiceStatus');
¬† ¬† 
¬† ¬† if (ativa) {
¬† ¬† ¬† ¬† if (ouvindo) {
¬† ¬† ¬† ¬† ¬† ¬† statusElement.textContent = 'Ouvindo...';
¬† ¬† ¬† ¬† ¬† ¬† statusElement.className = 'badge bg-success';
¬† ¬† ¬† ¬† ¬† ¬† btnToggle.innerHTML = '<i class="fa fa-microphone-slash"></i> Desativar Voz';
¬† ¬† ¬† ¬† ¬† ¬† btnToggle.className = 'btn btn-warning btn-sm';
¬† ¬† ¬† ¬† ¬† ¬† iconeVoz.className = 'fa fa-microphone text-success';
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† voiceStatusElement.style.display = 'block';
¬† ¬† ¬† ¬† ¬† ¬† voiceStatusElement.className = 'voice-status voice-active';
¬† ¬† ¬† ¬† ¬† ¬† voiceStatusElement.innerHTML = '<i class="fa fa-microphone"></i> Ouvindo... Fale agora';
¬† ¬† ¬† ¬† } else {
¬† ¬† ¬† ¬† ¬† ¬† statusElement.textContent = 'Ativo';
¬† ¬† ¬† ¬† ¬† ¬† statusElement.className = 'badge bg-info';
¬† ¬† ¬† ¬† ¬† ¬† btnToggle.innerHTML = '<i class="fa fa-microphone-slash"></i> Desativar Voz';
¬† ¬† ¬† ¬† ¬† ¬† btnToggle.className = 'btn btn-warning btn-sm';
¬† ¬† ¬† ¬† ¬† ¬† iconeVoz.className = 'fa fa-microphone text-info';
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† voiceStatusElement.style.display = 'block';
¬† ¬† ¬† ¬† ¬† ¬† voiceStatusElement.className = 'voice-status voice-inactive';
¬† ¬† ¬† ¬† ¬† ¬† voiceStatusElement.innerHTML = '<i class="fa fa-microphone"></i> Aguardando comando de voz...';
¬† ¬† ¬† ¬† }
¬† ¬† } else {
¬† ¬† ¬† ¬† statusElement.textContent = 'Inativo';
¬† ¬† ¬† ¬† statusElement.className = 'badge bg-danger';
¬† ¬† ¬† ¬† btnToggle.innerHTML = '<i class="fa fa-microphone"></i> Ativar Voz';
¬† ¬† ¬† ¬† btnToggle.className = 'btn btn-success btn-sm';
¬† ¬† ¬† ¬† iconeVoz.className = 'fa fa-microphone text-muted';
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† voiceStatusElement.style.display = 'none';
¬† ¬† }
}

function testarVoz() {
¬† ¬† if (!vozAtiva) {
¬† ¬† ¬† ¬† alert('Ative o reconhecimento de voz primeiro!');
¬† ¬† ¬† ¬† return;
¬† ¬† }
¬† ¬† 
¬† ¬† falarTexto('Teste de voz funcionando. Diga o ID do colaborador quando solicitado.');
¬† ¬† 
¬† ¬† // Simula uma pergunta de teste
¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† if (vozAtiva) {
¬† ¬† ¬† ¬† ¬† ¬† aguardandoRespostaVoz = true;
¬† ¬† ¬† ¬† ¬† ¬† reconhecimentoVoz.start();
¬† ¬† ¬† ¬† }
¬† ¬† }, 2000);
}

// ====================================================================
// CONEX√ÉO COM LEITOR DE C√ìDIGO DE BARRAS LB-W110BK (MODO TECLADO)
// ====================================================================

// Fun√ß√£o para inicializar o leitor no modo teclado
function inicializarLeitorTeclado() {
¬† ¬† leitorConectado = true;
¬† ¬† document.addEventListener('keydown', handleLeitorInput);
¬† ¬† atualizarStatusLeitorInterface();
¬† ¬† console.log('Leitor LB-W110BK inicializado no modo teclado');
}

// Fun√ß√£o para processar a entrada do leitor
function handleLeitorInput(event) {
¬† ¬† // Ignora se n√£o for um caractere normal ou se for teclas especiais
¬† ¬† if (event.key.length > 1 && !['Enter', 'Tab'].includes(event.key)) {
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† // Se for Enter, processa o c√≥digo acumulado
¬† ¬† if (event.key === 'Enter') {
¬† ¬† ¬† ¬† event.preventDefault();
¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† if (codigoBuffer.trim()) {
¬† ¬† ¬† ¬† ¬† ¬† processarCodigoBarras(codigoBuffer.trim());
¬† ¬† ¬† ¬† ¬† ¬† codigoBuffer = '';
¬† ¬† ¬† ¬† ¬† ¬† clearTimeout(timeoutBuffer);
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† return;
¬† ¬† }

¬† ¬† // Adiciona o caractere ao buffer
¬† ¬† codigoBuffer += event.key;
¬† ¬† 
¬† ¬† // Limpa o buffer ap√≥s um tempo (para casos onde n√£o h√° Enter)
¬† ¬† clearTimeout(timeoutBuffer);
¬† ¬† timeoutBuffer = setTimeout(() => {
¬† ¬† ¬† ¬† if (codigoBuffer.length > 3) { // Assume que √© um c√≥digo v√°lido
¬† ¬† ¬† ¬† ¬† ¬† processarCodigoBarras(codigoBuffer);
¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† codigoBuffer = '';
¬† ¬† }, 100);
}

// Fun√ß√£o para processar o c√≥digo lido
function processarCodigoBarras(codigo) {
¬† ¬† console.log('C√≥digo lido:', codigo);
¬† ¬† 
¬† ¬† // Remove poss√≠veis caracteres especiais do leitor
¬† ¬† codigo = codigo.replace(/[^\w\-]/g, '');
¬† ¬† 
¬† ¬† // Verifica se est√° na p√°gina de QR Code
¬† ¬† const paginaQR = document.getElementById('qr').style.display !== 'none';
¬† ¬† 
¬† ¬† if (paginaQR) {
¬† ¬† ¬† ¬† // Na p√°gina QR, primeiro verifica se √© uma chave
¬† ¬† ¬† ¬† if (codigo.startsWith('CH-')) {
¬† ¬† ¬† ¬† ¬† ¬† onScanSuccess(codigo);
¬† ¬† ¬† ¬† ¬† ¬† return;
¬† ¬† ¬† ¬† }
¬† ¬† }
¬† ¬† 
¬† ¬† // Se n√£o for chave ou n√£o estiver na p√°gina QR, assume que √© ID de colaborador
¬† ¬† if (/^\d+$/.test(codigo)) {
¬† ¬† ¬† ¬† const inputColaborador = document.getElementById('idColRetirada');
¬† ¬† ¬† ¬† if (inputColaborador) {
¬† ¬† ¬† ¬† ¬† ¬† inputColaborador.value = codigo;
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† // Foca no pr√≥ximo campo se estiver na √°rea de confirma√ß√£o
¬† ¬† ¬† ¬† ¬† ¬† if (document.getElementById('areaConfirmacao').style.display !== 'none') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const btnRetirada = document.getElementById('btnConfirmarRetirada');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const btnDevolucao = document.getElementById('btnDevolverChave');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (btnRetirada.style.display !== 'none') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† btnRetirada.focus();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else if (btnDevolucao.style.display !== 'none') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† btnDevolucao.focus();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }, 100);
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }
¬† ¬† } else if (codigo.startsWith('CH-')) {
¬† ¬† ¬† ¬† // Se for chave mas n√£o est√° na p√°gina QR, muda para a p√°gina QR
¬† ¬† ¬† ¬† showPage('qr');
¬† ¬† ¬† ¬† setTimeout(() => onScanSuccess(codigo), 500);
¬† ¬† }
}

// Fun√ß√£o para conectar/desconectar o leitor
function toggleLeitor() {
¬† ¬† if (leitorConectado) {
¬† ¬† ¬† ¬† desconectarLeitor();
¬† ¬† } else {
¬† ¬† ¬† ¬† conectarLeitor();
¬† ¬† }
}

// Fun√ß√£o para conectar o leitor
function conectarLeitor() {
¬† ¬† if (!leitorConectado) {
¬† ¬† ¬† ¬† inicializarLeitorTeclado();
¬† ¬† ¬† ¬† alert('Leitor LB-W110BK conectado! Agora voc√™ pode usar o leitor para escanear QR Codes e c√≥digos de barras.');
¬† ¬† }
}

// Fun√ß√£o para desconectar o leitor
function desconectarLeitor() {
¬† ¬† if (leitorConectado) {
¬† ¬† ¬† ¬† document.removeEventListener('keydown', handleLeitorInput);
¬† ¬† ¬† ¬† leitorConectado = false;
¬† ¬† ¬† ¬† codigoBuffer = '';
¬† ¬† ¬† ¬† clearTimeout(timeoutBuffer);
¬† ¬† ¬† ¬† atualizarStatusLeitorInterface();
¬† ¬† ¬† ¬† alert('Leitor desconectado.');
¬† ¬† }
}

// Fun√ß√£o para atualizar a interface do leitor
function atualizarStatusLeitorInterface() {
¬† ¬† const statusElement = document.getElementById('statusLeitor');
¬† ¬† const btnToggle = document.getElementById('btnToggleLeitor');
¬† ¬† const iconeLeitor = document.getElementById('iconeLeitor');
¬† ¬† 
¬† ¬† if (leitorConectado) {
¬† ¬† ¬† ¬† statusElement.textContent = 'Conectado';
¬† ¬† ¬† ¬† statusElement.className = 'badge bg-success';
¬† ¬† ¬† ¬† btnToggle.innerHTML = '<i class="fa fa-power-off"></i> Desconectar Leitor';
¬† ¬† ¬† ¬† btnToggle.className = 'btn btn-warning btn-sm';
¬† ¬† ¬† ¬† iconeLeitor.className = 'fa fa-barcode text-success';
¬† ¬† } else {
¬† ¬† ¬† ¬† statusElement.textContent = 'Desconectado';
¬† ¬† ¬† ¬† statusElement.className = 'badge bg-danger';
¬† ¬† ¬† ¬† btnToggle.innerHTML = '<i class="fa fa-plug"></i> Conectar Leitor';
¬† ¬† ¬† ¬† btnToggle.className = 'btn btn-success btn-sm';
¬† ¬† ¬† ¬† iconeLeitor.className = 'fa fa-barcode text-muted';
¬† ¬† }
}

// Fun√ß√£o para testar o leitor
function testarLeitor() {
¬† ¬† if (!leitorConectado) {
¬† ¬† ¬† ¬† alert('Conecte o leitor primeiro!');
¬† ¬† ¬† ¬† return;
¬† ¬† }
¬† ¬† 
¬† ¬† const inputColaborador = document.getElementById('idColRetirada');
¬† ¬† if (inputColaborador) {
¬† ¬† ¬† ¬† inputColaborador.focus();
¬† ¬† ¬† ¬† alert('Aponte o leitor para o c√≥digo de barras do colaborador...');
¬† ¬† } else {
¬† ¬† ¬† ¬† alert('Aponte o leitor para um QR Code de chave...');
¬† ¬† }
}

// Fun√ß√£o para focar automaticamente no campo de colaborador quando necess√°rio
function focarCampoColaborador() {
¬† ¬† setTimeout(() => {
¬† ¬† ¬† ¬† const inputColaborador = document.getElementById('idColRetirada');
¬† ¬† ¬† ¬† if (inputColaborador && document.getElementById('areaConfirmacao').style.display !== 'none') {
¬† ¬† ¬† ¬† ¬† ¬† inputColaborador.focus();
¬† ¬† ¬† ¬† ¬† ¬† 
¬† ¬† ¬† ¬† ¬† ¬† // Se a voz estiver ativa, pergunta qual o ID do colaborador
¬† ¬† ¬† ¬† ¬† ¬† if (vozAtiva) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† perguntarIdColaborador();
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† }
¬† ¬† }, 500);
}

// ====================================================================
// FUN√á√ïES DE RELAT√ìRIOS CORRIGIDAS (UTF-8)
// ====================================================================

function gerarRelatorioChaves() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para gerar relat√≥rios.');
        return;
    }
    
    // Cria o conte√∫do CSV com BOM para UTF-8
    let csvContent = "\uFEFF"; // BOM para UTF-8
    csvContent += "ID da Chave,Nome da Chave,Status,Data de Cadastro\n";

    chaves.forEach(chave => {
        // Remove caracteres problem√°ticos e formata corretamente
        const nomeChave = limparTextoCSV(chave.nome);
        const statusChave = limparTextoCSV(chave.status);
        const dataCadastro = new Date().toLocaleDateString('pt-BR');
        
        let row = `${chave.id},"${nomeChave}","${statusChave}","${dataCadastro}"\n`;
        csvContent += row;
    });

    criarDownloadCSV(csvContent, `relatorio_chaves_${formatarDataArquivo()}.csv`);
    alert("Relat√≥rio de chaves gerado com sucesso!");
}

function gerarRelatorioColaboradores() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para gerar relat√≥rios.');
        return;
    }
    
    let csvContent = "\uFEFF"; // BOM para UTF-8
    csvContent += "ID do Colaborador,Nome do Colaborador,Data de Cadastro\n";

    colaboradores.forEach(colaborador => {
        const nomeColaborador = limparTextoCSV(colaborador.nome);
        const dataCadastro = new Date().toLocaleDateString('pt-BR');
        
        let row = `${colaborador.id},"${nomeColaborador}","${dataCadastro}"\n`;
        csvContent += row;
    });

    criarDownloadCSV(csvContent, `relatorio_colaboradores_${formatarDataArquivo()}.csv`);
    alert("Relat√≥rio de colaboradores gerado com sucesso!");
}

function gerarRelatorioHistorico() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para gerar relat√≥rios.');
        return;
    }
    
    let csvContent = "\uFEFF"; // BOM para UTF-8
    csvContent += "ID da Chave,Nome do Colaborador,A√ß√£o,Data,Status,Usu√°rio\n";

    // Combina hist√≥rico online com pendentes
    const todosRegistros = [...historico, ...historicoPendente];
    todosRegistros.sort((a, b) => new Date(b.dataTimestamp) - new Date(a.dataTimestamp));

    todosRegistros.forEach(registro => {
        const nomeColaborador = limparTextoCSV(registro.colaborador);
        const status = registro.sincronizado === false ? 'Pendente' : 'Sincronizado';
        const usuario = registro.usuarioEmail || 'Desconhecido';
        
        let row = `${registro.chave},"${nomeColaborador}","${registro.acao}","${registro.data}","${status}","${usuario}"\n`;
        csvContent += row;
    });

    criarDownloadCSV(csvContent, `relatorio_historico_${formatarDataArquivo()}.csv`);
    alert("Relat√≥rio de hist√≥rico gerado com sucesso!");
}

function gerarRelatorioCompleto() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para gerar relat√≥rios.');
        return;
    }
    
    let csvContent = "\uFEFF"; // BOM para UTF-8
    csvContent += "Tipo,ID,Nome,Status,Data,Usu√°rio\n";

    // Adiciona chaves
    chaves.forEach(chave => {
        const nomeChave = limparTextoCSV(chave.nome);
        const statusChave = limparTextoCSV(chave.status);
        const dataCadastro = new Date().toLocaleDateString('pt-BR');
        
        let row = `Chave,${chave.id},"${nomeChave}","${statusChave}","${dataCadastro}","Sistema"\n`;
        csvContent += row;
    });

    // Adiciona colaboradores
    colaboradores.forEach(colaborador => {
        const nomeColaborador = limparTextoCSV(colaborador.nome);
        const dataCadastro = new Date().toLocaleDateString('pt-BR');
        
        let row = `Colaborador,${colaborador.id},"${nomeColaborador}","Ativo","${dataCadastro}","Sistema"\n`;
        csvContent += row;
    });

    // Adiciona hist√≥rico
    const todosRegistros = [...historico, ...historicoPendente];
    todosRegistros.forEach(registro => {
        const nomeColaborador = limparTextoCSV(registro.colaborador);
        const status = registro.sincronizado === false ? 'Pendente' : 'Sincronizado';
        const usuario = registro.usuarioEmail || 'Desconhecido';
        
        let row = `Movimenta√ß√£o,${registro.chave},"${nomeColaborador}","${registro.acao}","${registro.data}","${usuario}"\n`;
        csvContent += row;
    });

    criarDownloadCSV(csvContent, `relatorio_completo_${formatarDataArquivo()}.csv`);
    alert("Relat√≥rio completo gerado com sucesso!");
}

// Fun√ß√µes auxiliares para formata√ß√£o correta do CSV
function limparTextoCSV(texto) {
    if (!texto) return '';
    
    // Remove caracteres problem√°ticos para CSV
    return texto.toString()
        .replace(/"/g, '""') // Escapa aspas duplas
        .replace(/\n/g, ' ') // Remove quebras de linha
        .replace(/\r/g, ' ') // Remove carriage return
        .replace(/\t/g, ' ') // Remove tabs
        .trim();
}

function formatarDataArquivo() {
    const data = new Date();
    return data.toISOString().split('T')[0]; // Formato YYYY-MM-DD
}

function criarDownloadCSV(csvContent, nomeArquivo) {
    // Cria blob com encoding UTF-8
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    
    // Cria link de download
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    link.setAttribute("href", url);
    link.setAttribute("download", nomeArquivo);
    link.style.visibility = 'hidden';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// ====================================================================
// NOVAS FUNCIONALIDADES: P√ÅGINA DE QR CODES
// ====================================================================

function gerarTodosQRCodes() {
    const container = document.getElementById('qrCodesContainer');
    container.innerHTML = '';

    chaves.forEach(chave => {
        const qrCard = document.createElement('div');
        qrCard.className = 'qr-card';
        
        const qrDiv = document.createElement('div');
        qrDiv.id = `qr-${chave.id}`;
        
        const qrInfo = document.createElement('div');
        qrInfo.className = 'qr-info';
        
        const statusClass = chave.status.includes('Dispon√≠vel') ? 'status-disponivel-badge' : 'status-retirada-badge';
        
        qrInfo.innerHTML = `
            <h5>${chave.id}</h5>
            <p class="text-muted">${chave.nome}</p>
            <span class="status ${statusClass}">${chave.status}</span>
            <div class="mt-2">
                <button class="btn btn-sm btn-outline-light" onclick="baixarQRCodeIndividual('${chave.id}')">
                    <i class="fa fa-download"></i> Baixar
                </button>
            </div>
        `;
        
        qrCard.appendChild(qrDiv);
        qrCard.appendChild(qrInfo);
        container.appendChild(qrCard);
        
        // Gera o QR Code
        new QRCode(qrDiv, {
            text: chave.id,
            width: 150,
            height: 150,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
    });
}

function baixarQRCodeIndividual(chaveId) {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para baixar QR Codes.');
        return;
    }
    
    const chave = chaves.find(c => c.id === chaveId);
    if (!chave) return;
    
    const qrDiv = document.getElementById(`qr-${chaveId}`);
    const canvas = qrDiv.querySelector('canvas');
    
    if (canvas) {
        const link = document.createElement('a');
        link.download = `QRCode_${chaveId}_${chave.nome}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }
}

function baixarTodosQRCodes() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para baixar QR Codes.');
        return;
    }
    
    alert("Funcionalidade de download em lote ser√° implementada em breve!");
    // Em uma implementa√ß√£o real, voc√™ usaria uma biblioteca como JSZip
    // para compactar todos os QR Codes e fazer download
}

function imprimirQRCodes() {
    window.print();
}

// ====================================================================
// NOVAS FUNCIONALIDADES: EXCLUS√ÉO DE COLABORADORES
// ====================================================================

function solicitarExclusaoColaborador(index) {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para excluir colaboradores.');
        return;
    }
    
    const colaborador = colaboradores[index];
    if (!colaborador) return;
    
    // Verifica se o colaborador tem movimenta√ß√µes no hist√≥rico
    const temMovimentacoes = historico.some(h => h.colaborador === colaborador.nome) || 
                            historicoPendente.some(h => h.colaborador === colaborador.nome);
    
    if (temMovimentacoes) {
        alert('N√£o √© poss√≠vel excluir este colaborador pois existem movimenta√ß√µes associadas a ele no hist√≥rico.');
        return;
    }
    
    colaboradorParaExcluir = index;
    
    document.getElementById('mensagemExclusao').textContent = 
        `Tem certeza que deseja excluir o colaborador ${colaborador.id} - ${colaborador.nome}?`;
    
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmarExclusao'));
    modal.show();
}

function confirmarExclusaoColaborador() {
    if (!currentUser) {
        alert('Sess√£o expirada. Fa√ßa login novamente.');
        return;
    }
    
    if (colaboradorParaExcluir === null) return;
    
    const colaborador = colaboradores[colaboradorParaExcluir];
    
    db.collection("colaboradores").doc(colaborador.idDoc).delete()
    .then(() => {
        alert(`Colaborador ${colaborador.id} - ${colaborador.nome} exclu√≠do com sucesso!`);
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarExclusao'));
        modal.hide();
        colaboradorParaExcluir = null;
    })
    .catch(error => {
        console.error("Erro ao excluir colaborador:", error);
        alert("Erro ao excluir colaborador. Tente novamente.");
    });
}

// ====================================================================
// FUNCIONALIDADE OFFLINE (MANTIDA)
// ====================================================================

function configurarDetecaoConexao() {
    isOnline = navigator.onLine;
    atualizarStatusConexao();

    window.addEventListener('online', function() {
        isOnline = true;
        atualizarStatusConexao();
        sincronizarDadosPendentes();
    });

    window.addEventListener('offline', function() {
        isOnline = false;
        atualizarStatusConexao();
    });
}

function atualizarStatusConexao() {
    const onlineIndicator = document.getElementById('onlineIndicator');
    const offlineIndicator = document.getElementById('offlineIndicator');
    const statusConexao = document.getElementById('statusConexao');

    if (isOnline) {
        onlineIndicator.style.display = 'block';
        offlineIndicator.style.display = 'none';
        statusConexao.textContent = 'Online';
        statusConexao.className = 'badge bg-success';
    } else {
        onlineIndicator.style.display = 'none';
        offlineIndicator.style.display = 'block';
        statusConexao.textContent = 'Offline';
        statusConexao.className = 'badge bg-danger';
    }
}

function carregarDadosOffline() {
    const pendentesSalvos = localStorage.getItem('historicoPendente');
    if (pendentesSalvos) {
        historicoPendente = JSON.parse(pendentesSalvos);
    }

    const ultimaSync = localStorage.getItem('ultimaSincronizacao');
    if (ultimaSync) {
        document.getElementById('ultimaSync').textContent = new Date(ultimaSync).toLocaleString('pt-BR');
    }

    atualizarContadoresOffline();
}

function salvarDadosOffline() {
    localStorage.setItem('historicoPendente', JSON.stringify(historicoPendente));
    atualizarContadoresOffline();
}

function atualizarContadoresOffline() {
    document.getElementById('contadorPendentes').textContent = historicoPendente.length;
    document.getElementById('pendentesSync').textContent = historicoPendente.length;
    atualizarListaPendentes();
}

function adicionarMovimentacaoOffline(chave, colaborador, acao) {
    if (!currentUser) {
        console.error('Usu√°rio n√£o autenticado');
        return null;
    }
    
    const movimentacao = {
        id: Date.now().toString(),
        chave: chave.id,
        nomeChave: chave.nome,
        colaborador: colaborador.nome,
        idColaborador: colaborador.id,
        acao: acao,
        data: new Date().toLocaleString('pt-BR'),
        dataTimestamp: new Date().toISOString(),
        sincronizado: false,
        usuarioId: currentUser.uid,
        usuarioEmail: currentUser.email
    };

    historicoPendente.push(movimentacao);
    salvarDadosOffline();

    if (isOnline) {
        sincronizarMovimentacao(movimentacao);
    } else {
        atualizarStatusChaveLocal(chave, colaborador, acao);
    }

    return movimentacao;
}

function atualizarStatusChaveLocal(chave, colaborador, acao) {
    const chaveIndex = chaves.findIndex(c => c.id === chave.id);
    if (chaveIndex !== -1) {
        if (acao === "RETIRADA") {
            chaves[chaveIndex].status = "Retirada por " + colaborador.nome + " (Offline)";
        } else if (acao === "DEVOLU√á√ÉO") {
            chaves[chaveIndex].status = "Dispon√≠vel (Offline)";
        }
        atualizarListas();
    }
}

async function sincronizarDadosPendentes() {
    if (!currentUser) {
        console.error('Usu√°rio n√£o autenticado');
        return;
    }
    
    if (!isOnline || historicoPendente.length === 0) return;

    document.getElementById('syncStatus').style.display = 'block';
    
    let sucessos = 0;
    let erros = 0;

    for (let i = historicoPendente.length - 1; i >= 0; i--) {
        const movimentacao = historicoPendente[i];
        
        if (await sincronizarMovimentacao(movimentacao)) {
            sucessos++;
        } else {
            erros++;
            break;
        }
    }

    document.getElementById('syncStatus').style.display = 'none';
    
    if (erros === 0) {
        localStorage.setItem('ultimaSincronizacao', new Date().toISOString());
        document.getElementById('ultimaSync').textContent = new Date().toLocaleString('pt-BR');
    }
}

async function sincronizarMovimentacao(movimentacao) {
    try {
        await db.collection("historico").add({
            chave: movimentacao.chave,
            colaborador: movimentacao.colaborador,
            acao: movimentacao.acao,
            data: movimentacao.data,
            dataTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
            usuarioId: movimentacao.usuarioId,
            usuarioEmail: movimentacao.usuarioEmail
        });

        const chave = chaves.find(c => c.id === movimentacao.chave);
        if (chave) {
            if (movimentacao.acao === "RETIRADA") {
                await db.collection("chaves").doc(chave.idDoc).update({
                    status: "Retirada por " + movimentacao.colaborador
                });
            } else if (movimentacao.acao === "DEVOLU√á√ÉO") {
                await db.collection("chaves").doc(chave.idDoc).update({
                    status: "Dispon√≠vel"
                });
            }
        }

        historicoPendente = historicoPendente.filter(m => m.id !== movimentacao.id);
        salvarDadosOffline();
        
        return true;
    } catch (error) {
        console.error("Erro ao sincronizar movimenta√ß√£o:", error);
        return false;
    }
}

function atualizarListaPendentes() {
    const lista = document.getElementById('listaPendentes');
    lista.innerHTML = '';

    historicoPendente.forEach(movimentacao => {
        const acaoClass = movimentacao.acao.includes('RETIRADA') ? 'text-danger' : 'text-success';
        lista.innerHTML += `
            <tr>
                <td>${movimentacao.chave} - ${movimentacao.nomeChave}</td>
                <td>${movimentacao.colaborador}</td>
                <td class="${acaoClass}">${movimentacao.acao}</td>
                <td>${movimentacao.data}</td>
                <td>${movimentacao.usuarioEmail || 'Desconhecido'}</td>
                <td>
                    <span class="pending-sync">Pendente</span>
                    <button class="btn btn-sm btn-warning ms-2" onclick="tentarSincronizarUnico('${movimentacao.id}')">
                        <i class="fa fa-refresh"></i>
                    </button>
                </td>
            </tr>`;
    });
}

async function tentarSincronizarUnico(id) {
    const movimentacao = historicoPendente.find(m => m.id === id);
    if (movimentacao && await sincronizarMovimentacao(movimentacao)) {
        alert('Movimenta√ß√£o sincronizada com sucesso!');
    }
}

// ====================================================================
// FUN√á√ïES DE LEITURA DO FIREBASE
// ====================================================================

function carregarChavesFirebase() {
    db.collection("chaves").onSnapshot((snapshot) => {
        chaves = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
        
        contadorChave = chaves.reduce((max, c) => {
            const num = parseInt(c.id.split('-')[1]);
            return num > max ? num : max;
        }, 0);
        
        atualizarListas();
        atualizarEstatisticas();
    }, error => {
        console.error("Erro ao carregar chaves:", error);
    });
}

function carregarColaboradoresFirebase() {
    db.collection("colaboradores").onSnapshot((snapshot) => {
        colaboradores = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));

        contadorColaborador = colaboradores.reduce((max, c) => {
            const num = parseInt(c.id);
            return num > max ? num : max;
        }, 0);
        
        document.getElementById("ultimoColID").innerText = contadorColaborador > 0 ? contadorColaborador.toString().padStart(2, "0") : "Nenhum";
        atualizarListas();
        atualizarEstatisticas();
    }, error => {
        console.error("Erro ao carregar colaboradores:", error);
    });
}

function carregarHistoricoFirebase() {
    db.collection("historico").orderBy("dataTimestamp", "desc").onSnapshot((snapshot) => {
        historico = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
        atualizarListas();
        atualizarEstatisticas();
    }, error => {
        console.error("Erro ao carregar hist√≥rico:", error);
    });
}

// ====================================================================
// FUN√á√ïES DE ESCRITA E CRIA√á√ÉO
// ====================================================================

function salvarMovimentacao(chave, colaborador, acao) {
    if (!currentUser) {
        console.error('Usu√°rio n√£o autenticado');
        return;
    }
    
    if (isOnline) {
        db.collection("historico").add({
            chave: chave.id,
            colaborador: colaborador.nome,
            acao: acao,
            data: new Date().toLocaleString('pt-BR'),
            dataTimestamp: firebase.firestore.FieldValue.serverTimestamp(),
            usuarioId: currentUser.uid,
            usuarioEmail: currentUser.email
        })
        .catch(error => {
            console.error("Erro ao salvar hist√≥rico:", error);
            adicionarMovimentacaoOffline(chave, colaborador, acao);
        });
    } else {
        adicionarMovimentacaoOffline(chave, colaborador, acao);
    }
}

function cadastrarChave() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para cadastrar chaves.');
        return;
    }
    
    const nome = document.getElementById("nomeChave").value.trim();
    if (!nome) return alert("Digite o nome da chave.");

    const novoContador = contadorChave + 1;
    const id = "CH-" + novoContador.toString().padStart(3, "0"); 

    db.collection("chaves").add({
        id, 
        nome, 
        status: "Dispon√≠vel",
        usuarioCriador: currentUser.email,
        dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        document.getElementById("nomeChave").value = "";
        gerarQRCode(id);
        alert(`Chave ${id} cadastrada com sucesso!`);
    })
    .catch(error => {
        console.error("Erro ao cadastrar chave:", error);
        alert("Erro ao cadastrar chave. Verifique o console.");
    });
}

function cadastrarColaborador() {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para cadastrar colaboradores.');
        return;
    }
    
    const nome = document.getElementById("nomeColaborador").value.trim();
    if (!nome) return alert("Digite o nome do colaborador.");

    const novoContador = contadorColaborador + 1;
    let id = novoContador.toString().padStart(2, "0");

    db.collection("colaboradores").add({ 
        id, 
        nome,
        usuarioCriador: currentUser.email,
        dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        document.getElementById("nomeColaborador").value = "";
        alert(`Colaborador ${id} - ${nome} cadastrado com sucesso!`);
    })
    .catch(error => {
        console.error("Erro ao cadastrar colaborador:", error);
        alert("Erro ao cadastrar colaborador. Verifique o console.");
    });
}

// ====================================================================
// FUN√á√ïES DE RETIRADA E DEVOLU√á√ÉO
// ====================================================================

function validarIdColaborador(idCol) {
    if (!idCol) return "Digite o ID do colaborador.";
    if (!/^\d+$/.test(idCol)) return "ID do colaborador deve conter apenas n√∫meros.";
    if (colaboradores.find(c => c.id === idCol)) return null;
    return "Colaborador n√£o encontrado.";
}

function confirmarRetirada() {
    if (!currentUser) {
        alert('Sess√£o expirada. Fa√ßa login novamente.');
        return;
    }
    
    if (!chaveSelecionada) {
        alert("Erro: Nenhuma chave foi escaneada.");
        return;
    }
    
    const idCol = document.getElementById("idColRetirada").value.trim();
    const validacao = validarIdColaborador(idCol);
    if (validacao) {
        alert(validacao);
        return;
    }

    const colab = colaboradores.find(c => c.id === idCol);
    const chave = chaves.find(c => c.id === chaveSelecionada);
    
    if (!chave) {
        alert("Chave n√£o encontrada no sistema.");
        reiniciarScanner();
        return;
    }

    if (chave.status !== "Dispon√≠vel" && !chave.status.includes("Offline")) {
        alert(`Erro: Esta chave j√° est√° ${chave.status}. Use a op√ß√£o de Devolu√ß√£o.`);
        reiniciarScanner();
        return;
    }

    if (isOnline) {
        db.collection("chaves").doc(chave.idDoc).update({
            status: "Retirada por " + colab.nome
        })
        .then(() => {
            salvarMovimentacao(chave, colab, "RETIRADA");
            alert(`Sucesso! Chave ${chave.id} retirada por ${colab.nome}.`);
            reiniciarScanner();
        })
        .catch(error => {
            console.error("Erro ao retirar chave:", error);
            const movimentacao = adicionarMovimentacaoOffline(chave, colab, "RETIRADA");
            alert(`‚úÖ Retirada registrada offline! Ser√° sincronizada automaticamente.`);
            reiniciarScanner();
        });
    } else {
        const movimentacao = adicionarMovimentacaoOffline(chave, colab, "RETIRADA");
        alert(`‚úÖ Retirada registrada offline! (ID: ${movimentacao.id})\nSer√° sincronizada quando a conex√£o voltar.`);
        reiniciarScanner();
    }
}

function confirmarDevolucao() {
    if (!currentUser) {
        alert('Sess√£o expirada. Fa√ßa login novamente.');
        return;
    }
    
    if (!chaveSelecionada) {
        alert("Erro: Nenhuma chave foi escaneada.");
        return;
    }
    
    const idCol = document.getElementById("idColRetirada").value.trim();
    const validacao = validarIdColaborador(idCol);
    if (validacao) {
        alert(validacao);
        return;
    }

    const colab = colaboradores.find(c => c.id === idCol);
    const chave = chaves.find(c => c.id === chaveSelecionada);
    
    if (!chave) {
        alert("Chave n√£o encontrada no sistema.");
        reiniciarScanner();
        return;
    }

    if (chave.status === "Dispon√≠vel" || chave.status === "Dispon√≠vel (Offline)") {
        alert("Erro: Esta chave j√° est√° dispon√≠vel.");
        reiniciarScanner();
        return;
    }
    
    const nomeQuemRetirou = chave.status.replace("Retirada por ", "").replace(" (Offline)", "");
    if (!chave.status.includes(colab.nome) && nomeQuemRetirou !== colab.nome) {
        if (!confirm(`Aten√ß√£o: A chave foi retirada por ${nomeQuemRetirou}. Deseja confirmar a devolu√ß√£o por ${colab.nome} mesmo assim?`)) {
            return;
        }
    }

    if (isOnline) {
        db.collection("chaves").doc(chave.idDoc).update({
            status: "Dispon√≠vel"
        })
        .then(() => {
            salvarMovimentacao(chave, colab, "DEVOLU√á√ÉO");
            alert(`Sucesso! Chave ${chave.id} devolvida por ${colab.nome}.`);
            reiniciarScanner();
        })
        .catch(error => {
            console.error("Erro ao devolver chave:", error);
            const movimentacao = adicionarMovimentacaoOffline(chave, colab, "DEVOLU√á√ÉO");
            alert(`‚úÖ Devolu√ß√£o registrada offline! Ser√° sincronizada automaticamente.`);
            reiniciarScanner();
        });
    } else {
        const movimentacao = adicionarMovimentacaoOffline(chave, colab, "DEVOLU√á√ÉO");
        alert(`‚úÖ Devolu√ß√£o registrada offline! (ID: ${movimentacao.id})\nSer√° sincronizada quando a conex√£o voltar.`);
        reiniciarScanner();
    }
}

function salvarEdicao() {
    if (!currentUser) {
        alert('Sess√£o expirada. Fa√ßa login novamente.');
        return;
    }
    
    const novoNome = document.getElementById("modalInput").value.trim();
    if (!novoNome) return alert("Digite um nome v√°lido.");

    let colecao, idDoc, tipo;
    
    if (tipoEdicao === "chave") {
        const chaveEditada = chaves[itemEditando];
        colecao = "chaves";
        idDoc = chaveEditada.idDoc;
        tipo = "Chave";
    } else {
        const colabEditado = colaboradores[itemEditando];
        colecao = "colaboradores";
        idDoc = colabEditado.idDoc;
        tipo = "Colaborador";
    }

    db.collection(colecao).doc(idDoc).update({
        nome: novoNome,
        usuarioUltimaEdicao: currentUser.email,
        dataUltimaEdicao: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
        alert(`${tipo} atualizado para "${novoNome}".`);
        const modalElement = document.getElementById("modalEditar");
        const modalInstance = bootstrap.Modal.getInstance(modalElement);
        if (modalInstance) modalInstance.hide();
    })
    .catch(error => {
        console.error("Erro ao salvar edi√ß√£o:", error);
        alert("Erro ao salvar edi√ß√£o.");
    });
}

// ====================================================================
// FUN√á√ïES DO SCANNER
// ====================================================================

function showPage(page, event) {
    if(event) event.preventDefault(); 

    document.querySelectorAll("section").forEach(s => s.style.display = "none");
    document.getElementById(page).style.display = "block";

    document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("activeMenu"));
    if(event) event.currentTarget.classList.add("activeMenu");
    else document.querySelector(`.sidebar a[onclick*="${page}"]`).classList.add("activeMenu");

    if (page === 'qr') {
        iniciarScanner();
    } else {
        pararScanner();
    }

    if (page === 'colaboradores') {
        document.getElementById("ultimoColID").innerText = contadorColaborador > 0 ? contadorColaborador.toString().padStart(2, "0") : "Nenhum";
    }

    if (page === 'offline') {
        atualizarListaPendentes();
    }

    if (page === 'qr-codes') {
        gerarTodosQRCodes();
    }

    if (page === 'relatorios') {
        atualizarEstatisticas();
    }
}

function iniciarScanner() {
    if (html5QrcodeScanner && scannerAtivo) {
        retomarScanner();
        return;
    }

    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
    }

    html5QrcodeScanner = new Html5QrcodeScanner(
        "reader", 
        { 
            fps: 10, 
            qrbox: 250, 
            disableFlip: false,
            facingMode: "environment",
            videoConstraints: {
                facingMode: { ideal: "environment" }, 
                width: { max: 480 },
                height: { max: 480 }
            }
        }
    );

    html5QrcodeScanner.render(onScanSuccess, onScanError);
    scannerAtivo = true;
    scannerPausado = false;
    
    atualizarStatusScanner();
    document.getElementById("btnToggleScanner").style.display = "block";
}

function pararScanner() {
    if (html5QrcodeScanner && scannerAtivo) {
        try {
            html5QrcodeScanner.clear();
            scannerAtivo = false;
            scannerPausado = false;
        } catch (error) {
            console.warn("Erro ao parar scanner:", error);
        }
    }
}

function pausarScanner() {
    if (html5QrcodeScanner && scannerAtivo && !scannerPausado) {
        try {
            html5QrcodeScanner.pause();
            scannerPausado = true;
            atualizarStatusScanner();
        } catch (error) {
            console.warn("Erro ao pausar scanner:", error);
        }
    }
}

function retomarScanner() {
    if (html5QrcodeScanner && scannerAtivo && scannerPausado) {
        try {
            html5QrcodeScanner.resume();
            scannerPausado = false;
            atualizarStatusScanner();
        } catch (error) {
            console.warn("Erro ao retomar scanner:", error);
        }
    }
}

function toggleScanner() {
    if (scannerPausado) {
        retomarScanner();
    } else {
        pausarScanner();
    }
}

function atualizarStatusScanner() {
    const statusElement = document.getElementById("scannerStatus");
    const toggleButton = document.getElementById("btnToggleScanner");
    
    if (scannerAtivo) {
        statusElement.style.display = "block";
        if (scannerPausado) {
            statusElement.className = "scanner-status scanner-paused";
            statusElement.innerHTML = "<i class='fa fa-pause'></i> Scanner pausado";
            toggleButton.innerHTML = "<i class='fa fa-play'></i> Retomar Scanner";
        } else {
            statusElement.className = "scanner-status scanner-active";
            statusElement.innerHTML = "<i class='fa fa-camera'></i> Scanner ativo";
            toggleButton.innerHTML = "<i class='fa fa-pause'></i> Pausar Scanner";
        }
    } else {
        statusElement.style.display = "none";
    }
}

function onScanSuccess(decodedText) {
    pausarScanner();
    
    const chave = chaves.find(c => c.id === decodedText);

    if (!chave) {
        document.getElementById("chaveDetectada").innerText = `ERRO: Chave '${decodedText}' n√£o encontrada.`;
        document.getElementById("areaConfirmacao").style.display = "none";
        alert("QR Code lido, mas nenhuma chave correspondente foi encontrada no sistema.");
        
        setTimeout(retomarScanner, 2000);
        return;
    }

    chaveSelecionada = decodedText;
    document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
    document.getElementById("areaConfirmacao").style.display = "block";

    const isDisponivel = chave.status === "Dispon√≠vel" || chave.status === "Dispon√≠vel (Offline)";
    
    document.getElementById("btnConfirmarRetirada").style.display = isDisponivel ? "block" : "none";
    document.getElementById("btnDevolverChave").style.display = isDisponivel ? "none" : "block";
    document.getElementById("idColRetirada").placeholder = isDisponivel ? 
        "ID do colaborador que vai RETIRAR" : 
        "ID do colaborador que vai DEVOLVER";
    
    // Foca automaticamente no campo do colaborador
    focarCampoColaborador();
}

function onScanError(errorMessage) {
    // Erros s√£o esperados durante a opera√ß√£o normal do scanner
}

function reiniciarScanner() {
    document.getElementById("areaConfirmacao").style.display = "none";
    document.getElementById("chaveDetectada").innerText = "Nenhuma";
    document.getElementById("idColRetirada").value = "";
    chaveSelecionada = null;

    // Para o reconhecimento de voz se estiver ativo
    aguardandoRespostaVoz = false;

    retomarScanner();
}

// ====================================================================
// FUN√á√ïES UTILS (Renderiza√ß√£o, QR Code, UX)
// ====================================================================

function gerarQRCode(texto) {
    let area = document.getElementById("qrCodeArea");
    area.innerHTML = "";

    const qrDiv = document.createElement('div');
    qrDiv.id = 'qrcodeCanvas';
    area.appendChild(qrDiv);

    new QRCode(qrDiv, { 
        text: texto, 
        width: 200, 
        height: 200, 
        colorDark : "#fff", 
        colorLight : "#1e1e1e", 
        correctLevel : QRCode.CorrectLevel.H 
    });

    setTimeout(() => {
        let canvas = qrDiv.querySelector("canvas");
        if (canvas) {
            let imgData = canvas.toDataURL("image/png");
            let link = document.createElement("a");
            link.href = imgData;
            link.download = texto + "_QRCode.png";
            link.innerText = "Baixar QR Code";
            link.className = "btn btn-outline-light mt-3";
            area.appendChild(link);
        }
    }, 100);
}

function filtrarChaves() {
    let termo = document.getElementById("buscaChaves").value.toLowerCase();
    
    const chavesFiltradas = chaves
        .filter(c => 
            c.nome.toLowerCase().includes(termo) || 
            c.id.toLowerCase().includes(termo) || 
            c.status.toLowerCase().includes(termo)
        );

    renderizarChaves(chavesFiltradas);
}

function atualizarListas() {
    const totalDisponiveis = chaves.filter(c => 
        c.status === "Dispon√≠vel" || c.status === "Dispon√≠vel (Offline)"
    ).length;
    const totalRetiradas = chaves.length - totalDisponiveis;

    document.getElementById("totalChaves").innerText = chaves.length;
    document.getElementById("chavesDisponiveis").innerText = totalDisponiveis;
    document.getElementById("chavesRetiradas").innerText = totalRetiradas;
    document.getElementById("totalCol").innerText = colaboradores.length;
    document.getElementById("totalHist").innerText = historico.length + historicoPendente.length;

    renderizarChaves(chaves);

    let colList = document.getElementById("listaColaboradores");
    colList.innerHTML = "";
    colaboradores.forEach((c, idx) => {
        colList.innerHTML += `
            <tr>
                <td>${c.id}</td>
                <td>${c.nome}</td>
                <td>
                    <button class="btn btn-sm btn-success me-1" onclick="abrirEdicao('colaborador', ${idx})">
                        <i class="fa fa-edit"></i> Editar
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="solicitarExclusaoColaborador(${idx})">
                        <i class="fa fa-trash"></i> Excluir
                    </button>
                </td>
            </tr>`;
    });

    let hist = document.getElementById("listaHistorico");
    hist.innerHTML = "";
    
    const todosRegistros = [...historico, ...historicoPendente];
    todosRegistros.sort((a, b) => new Date(b.dataTimestamp) - new Date(a.dataTimestamp));
    
    todosRegistros.forEach(h => {
        const acaoClass = h.acao.includes('RETIRADA') ? 'text-danger' : 'text-success';
        const status = h.sincronizado === false ? '<span class="pending-sync">Pendente</span>' : '<span class="badge bg-success">Sincronizado</span>';
        const usuario = h.usuarioEmail || 'Desconhecido';
        
        hist.innerHTML += `
            <tr>
                <td>${h.chave}</td>
                <td>${h.colaborador}</td>
                <td class="${acaoClass}">${h.acao}</td>
                <td>${h.data}</td>
                <td>${status}</td>
                <td>${usuario}</td>
            </tr>`;
    });
}

function atualizarEstatisticas() {
    const totalDisponiveis = chaves.filter(c => 
        c.status === "Dispon√≠vel" || c.status === "Dispon√≠vel (Offline)"
    ).length;
    const totalMovimentacoes = historico.length + historicoPendente.length;

    document.getElementById('statChavesTotal').textContent = chaves.length;
    document.getElementById('statChavesDisponiveis').textContent = totalDisponiveis;
    document.getElementById('statColaboradoresTotal').textContent = colaboradores.length;
    document.getElementById('statMovimentacoesTotal').textContent = totalMovimentacoes;
}

function renderizarChaves(chavesParaExibir) {
    let lista = document.getElementById("listaChaves");
    lista.innerHTML = "";
    chavesParaExibir.forEach((c, idx) => {
        const indexOriginal = chaves.findIndex(item => item.id === c.id); 

        const isOffline = c.status.includes("Offline");
        const statusClass = c.status.includes("Dispon√≠vel") ? 'status-disponivel' : 'status-retirada';
        const statusBadgeClass = c.status.includes("Dispon√≠vel") ? 'badge text-bg-success' : 'badge text-bg-danger';

        let acoesHtml = `
            <button class="btn btn-sm btn-warning me-2" onclick="abrirEdicao('chave', ${indexOriginal})">
                <i class="fa fa-edit"></i>
            </button>`;

        if (c.status.includes("Dispon√≠vel")) {
            acoesHtml += `
                <button class="btn btn-sm btn-info" onclick="iniciarRetiradaRapida('${c.id}')">
                    <i class="fa fa-arrow-right"></i> Retirar
                </button>`;
        } else {
            acoesHtml += `
                <button class="btn btn-sm btn-primary" onclick="iniciarDevolucaoRapida('${c.id}')">
                    <i class="fa fa-reply"></i> Devolver
                </button>`;
        }

        const offlineBadge = isOffline ? ' <span class="badge bg-warning">Offline</span>' : '';

        lista.innerHTML += `
            <tr>
                <td>${c.id}</td>
                <td>${c.nome}</td>
                <td><span class="${statusBadgeClass} ${statusClass}">${c.status}</span>${offlineBadge}</td>
                <td>${acoesHtml}</td>
            </tr>`;
    });
}

function iniciarRetiradaRapida(chaveId) {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para retirar chaves.');
        return;
    }
    
    showPage('qr'); 
    
    const chave = chaves.find(c => c.id === chaveId);
    
    if (chave) {
        chaveSelecionada = chaveId;
        document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
        document.getElementById("areaConfirmacao").style.display = "block";

        document.getElementById("btnConfirmarRetirada").style.display = "block";
        document.getElementById("btnDevolverChave").style.display = "none";
        document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai RETIRAR";
        
        pausarScanner();
    }
}

function iniciarDevolucaoRapida(chaveId) {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para devolver chaves.');
        return;
    }
    
    showPage('qr'); 
    
    const chave = chaves.find(c => c.id === chaveId);
    
    if (chave) {
        chaveSelecionada = chaveId;
        document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
        document.getElementById("areaConfirmacao").style.display = "block";

        document.getElementById("btnConfirmarRetirada").style.display = "none";
        document.getElementById("btnDevolverChave").style.display = "block";
        document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai DEVOLVER";
        
        pausarScanner();
    }
}

function abrirEdicao(tipo, indexOriginal) {
    if (!currentUser) {
        alert('Voc√™ precisa estar logado para editar.');
        return;
    }
    
    tipoEdicao = tipo;
    itemEditando = indexOriginal;
    const item = tipo === 'chave' ? chaves[indexOriginal] : colaboradores[indexOriginal];
    
    document.getElementById("modalTitulo").innerText = `Editar ${tipo === 'chave' ? 'Chave' : 'Colaborador'} (ID: ${item.id})`;
    document.getElementById("modalInput").value = item.nome;
    
    const modalInstance = new bootstrap.Modal(document.getElementById('modalEditar'));
    modalInstance.show();
}

// ====================================================================
// INICIALIZA√á√ÉO DO SISTEMA
// ====================================================================

// Inicializar verifica√ß√£o de autentica√ß√£o quando a p√°gina carrega
document.addEventListener('DOMContentLoaded', function() {
    checkAuthState();
});

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
