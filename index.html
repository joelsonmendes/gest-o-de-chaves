<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o de Chaves â€” SENAIHUB</title>

    <link rel="manifest" href="/manifest.json">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* =======================================
            ESTILOS BASE (DARK MODE)
            ======================================= */
        body {
            background: #121212;
            color: #fff;
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }
        .content-wrapper {
            margin-left: 250px; /* Margem padrÃ£o para desktop */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .content {
            padding: 16px;
            flex-grow: 1;
        }
        .card {
            background: #1e1e1e;
            border: 1px solid #333;
            color: #fff;
        }
        input, select, textarea {
            background: #222 !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        input::placeholder {
            color: #aaa !important;
        }
        .btn-custom {
            background: #fd790d;
            border: none;
            color: #fff;
        }
        .btn-custom:hover {
            background: #48f005;
            color: #fff;
        }
        .qr-box canvas {
            display: block;
            margin: 15px auto 0;
            width: 200px !important;
            height: 200px !important;
        }
        .table > :not(caption) > * > * {
            background-color: #1e1e1e;
            color: #fff;
            padding: 0.6rem 0.6rem; /* <-- Diminui o espaÃ§amento interno das cÃ©lulas */
        }

        /* =======================================
            SIDEBAR (BARRA LATERAL)
            ======================================= */
        .sidebar {
            height: 100vh;
            background: #1f1f1f;
            padding-top: 20px;
            position: fixed;
            width: 250px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar .logo-container {
            padding: 0 15px 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        .sidebar .logo-container img {
            /* Usando o nome do arquivo da sua imagem retangular (192x192) */
            max-width: 100%;
            height: auto;
            max-height: 60px;
        }
        .sidebar a {
            color: #999898;
            padding: 15px 20px;
            display: block;
            transition: 0.2s;
            font-size: 17px;
            text-decoration: none;
        }
        .sidebar a:hover, .activeMenu {
            background: #333;
            color: #fff !important;
        }

        /* =======================================
            FOOTER (RODAPÃ‰)
            ======================================= */
        .footer {
            background: #1f1f1f;
            color: #ccc;
            text-align: center;
            padding: 15px 20px;
            font-size: 0.9em;
            border-top: 1px solid #333;
            margin-top: auto;
        }

        /* =======================================
            RESPONSIVIDADE (SMARTPHONE/TABLET)
            ======================================= */
        @media (max-width: 768px) {
            /* SIDEBAR: Vira um cabeÃ§alho horizontal e rolÃ¡vel */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative; 
                padding-top: 10px;
                flex-direction: row; 
                overflow-x: auto; 
                white-space: nowrap; 
                border-bottom: 1px solid #333;
            }

            /* Links do menu em linha */
            .sidebar a {
                display: inline-block;
                padding: 10px 15px;
                font-size: 15px;
            }

            /* Logo ocupa a largura total acima dos links */
            .sidebar .logo-container {
                display: block;
                text-align: center;
                width: 100%;
                border-bottom: none;
                margin-bottom: 5px;
            }

            /* CONTEÃšDO: Remove a margem fixa */
            .content-wrapper {
                margin-left: 0;
                padding-top: 10px;
            }
        }

        /* =======================================
            ESTILOS ADICIONAIS PARA MELHOR UX
            ======================================= */
        .scanner-status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
        .scanner-active {
            background: #1a331a;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }
        .scanner-paused {
            background: #332b1a;
            color: #FF9800;
            border: 1px solid #FF9800;
        }
        .status-disponivel {
            color: #4CAF50;
        }
        .status-retirada {
            color: #f44336;
        }
        .offline-indicator {
            background: #ff4444;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .online-indicator {
            background: #4CAF50;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .sync-status {
            background: #ff9800;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .pending-sync {
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        
        /* =======================================
            ESTILOS PARA A PÃGINA DE QR CODES
            ======================================= */
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .qr-card {
            background: #2d2d2d;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #444;
            transition: transform 0.2s;
        }
        .qr-card:hover {
            transform: translateY(-5px);
            border-color: #fd790d;
        }
        .qr-card canvas {
            margin: 0 auto;
        }
        .qr-info {
            margin-top: 15px;
        }
        .qr-info h5 {
            color: #fff;
            margin-bottom: 5px;
        }
        .qr-info .status {
            font-size: 0.9em;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        .status-disponivel-badge {
            background: #4CAF50;
            color: white;
        }
        .status-retirada-badge {
            background: #f44336;
            color: white;
        }
        
        /* =======================================
            ESTILOS PARA RELATÃ“RIOS
            ======================================= */
        .report-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .report-card {
            cursor: pointer;
            transition: all 0.3s;
        }
        .report-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* =======================================
            ESTILOS PARA O LEITOR DE CÃ“DIGO DE BARRAS
            ======================================= */
        .leitor-section {
            background: #2d2d2d;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .leitor-section h5 {
            color: #fd790d;
            margin-bottom: 15px;
        }

        .leitor-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
        }

        /* =======================================
            ESTILOS PARA FUNCIONALIDADE DE VOZ
            ======================================= */
        .voice-control-section {
            background: #2d2d2d;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .voice-control-section h5 {
            color: #fd790d;
            margin-bottom: 15px;
        }

        .voice-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .voice-active {
            background: #1a331a;
            color: #4CAF50;
            border: 1px solid #4CAF50;
        }

        .voice-inactive {
            background: #332b1a;
            color: #FF9800;
            border: 1px solid #FF9800;
        }

        .voice-instruction {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-style: italic;
            color: #ccc;
        }
    </style>
</head>

<body onload="iniciarSistema()">

<div class="sidebar">
    <div class="logo-container">
       <img src="logo.png" alt="SENAIHUB Logo">
    </div>
    <a href="#" onclick="showPage('home', event)" class="activeMenu"><i class="fa fa-home"></i> Home</a>
    <a href="#" onclick="showPage('chaves', event)"><i class="fa fa-key"></i> Chaves</a>
    <a href="#" onclick="showPage('colaboradores', event)"><i class="fa fa-users"></i> Colaboradores</a>
    <a href="#" onclick="showPage('qr-codes', event)"><i class="fa fa-qrcode"></i> Todos QR Codes</a>
    <a href="#" onclick="showPage('historico', event)"><i class="fa fa-clock-rotate-left"></i> HistÃ³rico</a>
    <a href="#" onclick="showPage('qr', event)"><i class="fa fa-camera"></i> Retirar por QR Code</a>
    <a href="#" onclick="showPage('relatorios', event)"><i class="fa fa-chart-bar"></i> RelatÃ³rios</a>
    <a href="#" onclick="showPage('offline', event)"><i class="fa fa-cloud"></i> Dados Offline</a>
</div>

<div class="content-wrapper"> 
    <div class="content">

        <!-- Indicadores de Status de ConexÃ£o -->
        <div id="onlineIndicator" class="online-indicator">
            <i class="fa fa-wifi"></i> Conectado - Dados sincronizados
        </div>
        <div id="offlineIndicator" class="offline-indicator">
            <i class="fa fa-wifi-slash"></i> Modo Offline - Dados serÃ£o sincronizados quando a conexÃ£o voltar
        </div>
        <div id="syncStatus" class="sync-status">
            <i class="fa fa-refresh fa-spin"></i> Sincronizando dados pendentes...
        </div>

        <section id="home">
            <h1 class="mb-4">ðŸ”‘ Sistema de GestÃ£o de Chaves</h1>
            <hr/>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-key text-info"></i> Chaves</h3>
                        <p class="mb-0">Total Registradas: <span id="totalChaves" class="fw-bold">0</span></p>
                        <p class="mb-0">DisponÃ­veis: <span id="chavesDisponiveis" class="fw-bold">0</span></p>
                        <p class="mb-0">Retiradas: <span id="chavesRetiradas" class="fw-bold">0</span></p>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-users text-warning"></i> Colaboradores</h3>
                        <p>Total: <span id="totalCol" class="fw-bold">0</span></p>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-clock-rotate-left text-success"></i> HistÃ³rico</h3>
                        <p>Total: <span id="totalHist" class="fw-bold">0</span></p>
                        <p class="mb-0">Pendentes: <span id="pendentesSync" class="fw-bold text-warning">0</span></p>
                    </div>
                </div>
            </div>
        </section>

        <section id="chaves" style="display:none;">
            <h2><i class="fa fa-key text-info"></i> GestÃ£o de Chaves</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Cadastrar Chave</h4>
                <input id="nomeChave" placeholder="Nome da chave (Ex: Sala 101)" class="form-control mt-2">
                <button class="btn btn-custom mt-2" onclick="cadastrarChave()">
                    <i class="fa fa-plus"></i> Cadastrar e Gerar QR Code
                </button>

                <div id="qrCodeArea" class="qr-box text-center mt-3"></div>
            </div>

            <div class="card p-3 mt-4">
                <h4>Buscar Chaves</h4>
                <input id="buscaChaves" class="form-control" placeholder="Pesquisar por ID ou nome..." onkeyup="filtrarChaves()">
            </div>

            <div class="card mt-3 p-3">
                <h4>Lista de Chaves</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="listaChaves"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="colaboradores" style="display:none;">
            <h2><i class="fa fa-users text-warning"></i> GestÃ£o de Colaboradores</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Cadastrar Colaborador</h4>
                <input id="nomeColaborador" placeholder="Nome do colaborador" class="form-control mt-2">
                <button class="btn btn-custom mt-3" onclick="cadastrarColaborador()">
                    <i class="fa fa-user-plus"></i> Cadastrar
                </button>
                <p class="mt-3 mb-0"><b>Ãšltimo ID gerado:</b> <span id="ultimoColID" class="fw-bold">Nenhum</span></p>
            </div>

            <div class="card mt-4 p-4">
                <h4>Lista de Colaboradores</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="listaColaboradores"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="qr-codes" style="display:none;">
            <h2><i class="fa fa-qrcode text-info"></i> Todos os QR Codes das Chaves</h2>
            <hr/>
            
            <div class="card p-4">
                <h4>QR Codes para ImpressÃ£o</h4>
                <p class="text-muted">Todos os QR codes das chaves cadastradas no sistema. Clique em "Baixar" para salvar individualmente.</p>
                
                <div class="mb-3">
                    <button class="btn btn-success" onclick="baixarTodosQRCodes()">
                        <i class="fa fa-download"></i> Baixar Todos os QR Codes (ZIP)
                    </button>
                    <button class="btn btn-info ms-2" onclick="imprimirQRCodes()">
                        <i class="fa fa-print"></i> Imprimir Todos
                    </button>
                </div>
                
                <div id="qrCodesContainer" class="qr-grid">
                    <!-- Os QR Codes serÃ£o gerados aqui -->
                </div>
            </div>
        </section>

        <section id="historico" style="display:none;">
            <h2><i class="fa fa-clock-rotate-left text-success"></i> HistÃ³rico de MovimentaÃ§Ãµes</h2>
            <hr/>

            <div class="card p-3 mb-4">
                <h4>RelatÃ³rios</h4>
                <button class="btn btn-success mt-2" onclick="gerarRelatorioHistorico()">
                    <i class="fa fa-download"></i> Baixar RelatÃ³rio Completo (CSV)
                </button>
                <button class="btn btn-warning mt-2 ms-2" onclick="sincronizarDadosPendentes()">
                    <i class="fa fa-refresh"></i> Sincronizar Dados Pendentes
                </button>
            </div>

            <div class="card mt-3 p-3">
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Chave (ID)</th>
                                <th>Colaborador</th>
                                <th>AÃ§Ã£o</th>
                                <th>Data</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="listaHistorico"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="qr" style="display:none;">
            <h2><i class="fa fa-qrcode text-info"></i> Retirada por QR Code</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Escanear QR Code da Chave</h4>
                
                <!-- Controle do Leitor de CÃ³digo de Barras -->
                <div class="card p-3 mb-3 leitor-section">
                    <h5><i id="iconeLeitor" class="fa fa-barcode text-muted"></i> Leitor de CÃ³digo de Barras LB-W110BK</h5>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Status:</strong> 
                                <span id="statusLeitor" class="badge bg-danger">Desconectado</span>
                            </p>
                            <small class="text-muted">Modo: EmulaÃ§Ã£o de Teclado</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="btnToggleLeitor" class="btn btn-success btn-sm" onclick="toggleLeitor()">
                                <i class="fa fa-plug"></i> Conectar Leitor
                            </button>
                            <button class="btn btn-info btn-sm ms-2" onclick="testarLeitor()">
                                <i class="fa fa-test"></i> Testar
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fa fa-info-circle"></i> 
                            Conecte o leitor via USB e clique em "Conectar Leitor". O leitor funciona automaticamente como um teclado.
                        </small>
                    </div>
                </div>

                <!-- Controle de Voz -->
                <div class="card p-3 mb-3 voice-control-section">
                    <h5><i id="iconeVoz" class="fa fa-microphone text-muted"></i> Assistente de Voz</h5>
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Status:</strong> 
                                <span id="statusVoz" class="badge bg-danger">Inativo</span>
                            </p>
                            <small class="text-muted">Reconhecimento de voz para ID do colaborador</small>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="btnToggleVoz" class="btn btn-success btn-sm" onclick="toggleReconhecimentoVoz()">
                                <i class="fa fa-microphone"></i> Ativar Voz
                            </button>
                            <button class="btn btn-info btn-sm ms-2" onclick="testarVoz()">
                                <i class="fa fa-test"></i> Testar Voz
                            </button>
                        </div>
                    </div>
                    
                    <div id="voiceStatus" class="voice-status voice-inactive" style="display: none;">
                        <i class="fa fa-microphone"></i> Aguardando comando de voz...
                    </div>
                    
                    <div class="voice-instruction">
                        <strong>InstruÃ§Ãµes:</strong> ApÃ³s escanear o QR Code da chave, o sistema perguntarÃ¡ "Qual o ID do colaborador?". 
                        Responda com o nÃºmero do ID (exemplo: "zero um" para ID 01).
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-info">
                            <i class="fa fa-info-circle"></i> 
                            O reconhecimento de voz funciona melhor com fones de ouvido e em ambiente silencioso.
                        </small>
                    </div>
                </div>

                <!-- Status do Scanner de CÃ¢mera -->
                <div id="scannerStatus" class="scanner-status scanner-active" style="display: none;">
                    <i class="fa fa-camera"></i> Scanner de cÃ¢mera ativo
                </div>
                
                <div id="reader" style="width:300px; margin: 0 auto;"></div>

                <div class="mt-3 text-center">
                    <button id="btnToggleScanner" class="btn btn-outline-warning btn-sm" onclick="toggleScanner()" style="display: none;">
                        <i class="fa fa-pause"></i> Pausar Scanner CÃ¢mera
                    </button>
                </div>

                <p class="mt-3"><b>Chave detectada:</b> <span id="chaveDetectada" class="fw-bold text-info">Nenhuma</span></p>

                <div id="areaConfirmacao" style="display:none;">
                    <div class="input-group">
                        <input id="idColRetirada" placeholder="ID do colaborador (use o leitor ou voz)" class="form-control">
                        <button class="btn btn-outline-secondary" type="button" onclick="testarLeitor()">
                            <i class="fa fa-barcode"></i> Testar Leitor
                        </button>
                        <button class="btn btn-outline-info" type="button" onclick="iniciarReconhecimentoVoz()">
                            <i class="fa fa-microphone"></i> Voz
                        </button>
                    </div>
                    <small class="text-muted d-block mt-1">
                        Aponte o leitor para o cÃ³digo de barras do ID do colaborador OU use o comando de voz
                    </small>
                    
                    <div class="mt-3">
                        <button id="btnConfirmarRetirada" class="btn btn-success w-100" onclick="confirmarRetirada()">
                            <i class="fa fa-check"></i> Confirmar Retirada
                        </button>
                        <button id="btnDevolverChave" class="btn btn-primary w-100 mt-2" onclick="confirmarDevolucao()">
                            <i class="fa fa-reply"></i> Confirmar DevoluÃ§Ã£o
                        </button>
                    </div>
                    
                    <button class="btn btn-outline-light w-100 mt-2" onclick="reiniciarScanner()">
                        <i class="fa fa-refresh"></i> Escanear Novamente
                    </button>
                </div>
            </div>
        </section>

        <section id="relatorios" style="display:none;">
            <h2><i class="fa fa-chart-bar text-warning"></i> RelatÃ³rios do Sistema</h2>
            <hr/>

            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioChaves()">
                        <div class="text-center">
                            <i class="fa fa-key fa-3x text-info mb-3"></i>
                            <h4>RelatÃ³rio de Chaves</h4>
                            <p class="text-muted">Lista completa de todas as chaves cadastradas com seus status atualizados</p>
                            <button class="btn btn-info w-100">
                                <i class="fa fa-download"></i> Gerar RelatÃ³rio
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioColaboradores()">
                        <div class="text-center">
                            <i class="fa fa-users fa-3x text-warning mb-3"></i>
                            <h4>RelatÃ³rio de Colaboradores</h4>
                            <p class="text-muted">Lista completa de todos os colaboradores cadastrados no sistema</p>
                            <button class="btn btn-warning w-100">
                                <i class="fa fa-download"></i> Gerar RelatÃ³rio
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioHistorico()">
                        <div class="text-center">
                            <i class="fa fa-history fa-3x text-success mb-3"></i>
                            <h4>RelatÃ³rio de HistÃ³rico</h4>
                            <p class="text-muted">HistÃ³rico completo de todas as movimentaÃ§Ãµes do sistema</p>
                            <button class="btn btn-success w-100">
                                <i class="fa fa-download"></i> Gerar RelatÃ³rio
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card report-card p-4 h-100" onclick="gerarRelatorioCompleto()">
                        <div class="text-center">
                            <i class="fa fa-file-alt fa-3x text-primary mb-3"></i>
                            <h4>RelatÃ³rio Completo</h4>
                            <p class="text-muted">RelatÃ³rio consolidado com todos os dados do sistema</p>
                            <button class="btn btn-primary w-100">
                                <i class="fa fa-download"></i> Gerar RelatÃ³rio
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4 p-4">
                <h4>EstatÃ­sticas do Sistema</h4>
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statChavesTotal">0</h3>
                            <p class="mb-0">Total de Chaves</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statChavesDisponiveis">0</h3>
                            <p class="mb-0">Chaves DisponÃ­veis</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statColaboradoresTotal">0</h3>
                            <p class="mb-0">Colaboradores</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-dark p-3">
                            <h3 id="statMovimentacoesTotal">0</h3>
                            <p class="mb-0">MovimentaÃ§Ãµes</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="offline" style="display:none;">
            <h2><i class="fa fa-cloud text-warning"></i> Gerenciamento de Dados Offline</h2>
            <hr/>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card p-4">
                        <h4><i class="fa fa-database"></i> Status de SincronizaÃ§Ã£o</h4>
                        <p><strong>Status da ConexÃ£o:</strong> 
                            <span id="statusConexao" class="badge bg-success">Online</span>
                        </p>
                        <p><strong>MovimentaÃ§Ãµes Pendentes:</strong> 
                            <span id="contadorPendentes" class="fw-bold text-warning">0</span>
                        </p>
                        <p><strong>Ãšltima SincronizaÃ§Ã£o:</strong> 
                            <span id="ultimaSync" class="fw-bold">Nunca</span>
                        </p>
                        
                        <button class="btn btn-warning w-100 mt-3" onclick="sincronizarDadosPendentes()">
                            <i class="fa fa-refresh"></i> Sincronizar Agora
                        </button>
                    </div>
                </div>

                <div class="col-md-6 mb-3">
                    <div class="card p-4">
                        <h4><i class="fa fa-info-circle"></i> InformaÃ§Ãµes Offline</h4>
                        <p>O sistema funciona mesmo sem internet. As movimentaÃ§Ãµes sÃ£o salvas localmente e sincronizadas automaticamente quando a conexÃ£o voltar.</p>
                        
                        <div class="alert alert-info mt-3">
                            <small>
                                <strong>Dicas:</strong><br>
                                â€¢ Todas as operaÃ§Ãµes funcionam offline<br>
                                â€¢ Os dados sÃ£o sincronizados automaticamente<br>
                                â€¢ O histÃ³rico mostra o status de cada registro
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4 p-4">
                <h4>MovimentaÃ§Ãµes Pendentes de SincronizaÃ§Ã£o</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Chave</th>
                                <th>Colaborador</th>
                                <th>AÃ§Ã£o</th>
                                <th>Data Local</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="listaPendentes"></tbody>
                    </table>
                </div>
            </div>
        </section>

    </div> 

    <footer class="footer">
        <p>&copy; 2025 SENAIHUB. Todos os direitos reservados. Desenvolvido para GestÃ£o de Chaves. Autor: Joelson M. Mendes</p>
        <p>VersÃ£o 3.2.0 (Funcionalidade de Voz Adicionada)</p>
    </footer>

</div> 

<!-- Modal para ConfirmaÃ§Ã£o de ExclusÃ£o -->
<div class="modal fade" id="modalConfirmarExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar ExclusÃ£o</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="mensagemExclusao">Tem certeza que deseja excluir este colaborador?</p>
                <p class="text-warning"><strong>AtenÃ§Ã£o:</strong> Esta aÃ§Ã£o nÃ£o pode ser desfeita!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmarExclusao">Excluir</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para EdiÃ§Ã£o -->
<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <label for="modalInput" class="form-label text-white">Novo Nome:</label>
                <input id="modalInput" class="form-control" placeholder="Digite o novo nome">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="btnSalvarEdicao">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================
// Â  Â  Â  Â  Â  Â  Â  Â  Â  Â SCRIPT DO SISTEMA (com Firebase + Offline + Voz)
// ============================================================

// VariÃ¡veis Globais
let chaves = [];
let colaboradores = [];
let historico = [];
let historicoPendente = [];
let contadorChave = 0; 
let contadorColaborador = 0;
let itemEditando = null;
let tipoEdicao = null;
let chaveSelecionada = null;
let html5QrcodeScanner = null;
let db = null; 
let scannerAtivo = false;
let scannerPausado = false;
let isOnline = true;
let colaboradorParaExcluir = null;

// VariÃ¡veis para o leitor LB-W110BK
let leitorConectado = false;
let codigoBuffer = '';
let timeoutBuffer;

// VariÃ¡veis para reconhecimento de voz
let reconhecimentoVoz = null;
let vozAtiva = false;
let aguardandoRespostaVoz = false;

/* ==================================
Â  Â  CONFIGURAÃ‡ÃƒO DO FIREBASE
================================== */
const firebaseConfig = {
Â  apiKey: "AIzaSyBxtaE405vs6mpuX5ufMu38s9wr3Hn0io8", 
Â  authDomain: "gestao-chaves-app.firebaseapp.com",
Â  projectId: "gestao-chaves-app", 
Â  storageBucket:"gestao-chaves-app.firebasestorage.app",
Â  messagingSenderId: "391255964652",
Â  appId: "1:391255964652:web:6d27bb36bc9ff520349ec9",
};

function iniciarSistema() {
Â  Â  // Inicializa o Firebase e o Firestore
Â  Â  const app = firebase.initializeApp(firebaseConfig);
Â  Â  db = firebase.firestore();

Â  Â  // Configura detecÃ§Ã£o de conectividade
Â  Â  configurarDetecaoConexao();

Â  Â  // Carrega dados pendentes do localStorage
Â  Â  carregarDadosOffline();

Â  Â  // Inicia os listeners (carregamento em tempo real do Firebase)
Â  Â  carregarChavesFirebase();
Â  Â  carregarColaboradoresFirebase();
Â  Â  carregarHistoricoFirebase();

Â  Â  document.getElementById("btnSalvarEdicao").addEventListener("click", salvarEdicao);
Â  Â  document.getElementById("btnConfirmarExclusao").addEventListener("click", confirmarExclusaoColaborador);

Â  Â  // Inicializa o leitor automaticamente (modo teclado sempre disponÃ­vel)
Â  Â  setTimeout(() => {
Â  Â  Â  Â  inicializarLeitorTeclado();
Â  Â  }, 1000);

Â  Â  // Inicializa o reconhecimento de voz
Â  Â  inicializarReconhecimentoVoz();

Â  Â  // Tenta sincronizar dados pendentes ao iniciar
Â  Â  setTimeout(sincronizarDadosPendentes, 2000);
}

// ====================================================================
// FUNCIONALIDADE DE RECONHECIMENTO DE VOZ
// ====================================================================

function inicializarReconhecimentoVoz() {
Â  Â  // Verifica se o navegador suporta reconhecimento de voz
Â  Â  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
Â  Â  Â  Â  console.warn('Reconhecimento de voz nÃ£o suportado neste navegador');
Â  Â  Â  Â  document.getElementById('btnToggleVoz').disabled = true;
Â  Â  Â  Â  document.getElementById('btnToggleVoz').innerHTML = '<i class="fa fa-microphone-slash"></i> NÃ£o Suportado';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Cria instÃ¢ncia do reconhecimento de voz
Â  Â  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
Â  Â  reconhecimentoVoz = new SpeechRecognition();
Â  Â  
Â  Â  // ConfiguraÃ§Ãµes
Â  Â  reconhecimentoVoz.continuous = false;
Â  Â  reconhecimentoVoz.interimResults = false;
Â  Â  reconhecimentoVoz.lang = 'pt-BR';

Â  Â  // Eventos
Â  Â  reconhecimentoVoz.onstart = function() {
Â  Â  Â  Â  console.log('Reconhecimento de voz iniciado');
Â  Â  Â  Â  atualizarStatusVozInterface(true, true);
Â  Â  };

Â  Â  reconhecimentoVoz.onresult = function(event) {
Â  Â  Â  Â  const transcript = event.results[0][0].transcript.trim();
Â  Â  Â  Â  console.log('Texto reconhecido:', transcript);
Â  Â  Â  Â  
Â  Â  Â  Â  processarComandoVoz(transcript);
Â  Â  };

Â  Â  reconhecimentoVoz.onerror = function(event) {
Â  Â  Â  Â  console.error('Erro no reconhecimento de voz:', event.error);
Â  Â  Â  Â  
Â  Â  Â  Â  if (event.error === 'not-allowed') {
Â  Â  Â  Â  Â  Â  alert('PermissÃ£o para uso do microfone negada. Por favor, permita o acesso ao microfone.');
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  atualizarStatusVozInterface(false, false);
Â  Â  Â  Â  aguardandoRespostaVoz = false;
Â  Â  };

Â  Â  reconhecimentoVoz.onend = function() {
Â  Â  Â  Â  console.log('Reconhecimento de voz finalizado');
Â  Â  Â  Â  
Â  Â  Â  Â  // Se ainda estiver aguardando resposta, reinicia o reconhecimento
Â  Â  Â  Â  if (aguardandoRespostaVoz && vozAtiva) {
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  reconhecimentoVoz.start();
Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  atualizarStatusVozInterface(vozAtiva, false);
Â  Â  Â  Â  }
Â  Â  };
}

function toggleReconhecimentoVoz() {
Â  Â  if (vozAtiva) {
Â  Â  Â  Â  desativarReconhecimentoVoz();
Â  Â  } else {
Â  Â  Â  Â  ativarReconhecimentoVoz();
Â  Â  }
}

function ativarReconhecimentoVoz() {
Â  Â  if (!reconhecimentoVoz) {
Â  Â  Â  Â  alert('Reconhecimento de voz nÃ£o estÃ¡ disponÃ­vel neste navegador.');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  vozAtiva = true;
Â  Â  aguardandoRespostaVoz = false;
Â  Â  
Â  Â  // Solicita permissÃ£o do usuÃ¡rio
Â  Â  reconhecimentoVoz.start();
Â  Â  
Â  Â  alert('Assistente de voz ativado! ApÃ³s escanear um QR Code, o sistema perguntarÃ¡ qual o ID do colaborador.');
}

function desativarReconhecimentoVoz() {
Â  Â  vozAtiva = false;
Â  Â  aguardandoRespostaVoz = false;
Â  Â  
Â  Â  if (reconhecimentoVoz) {
Â  Â  Â  Â  reconhecimentoVoz.stop();
Â  Â  }
Â  Â  
Â  Â  atualizarStatusVozInterface(false, false);
Â  Â  alert('Assistente de voz desativado.');
}

function iniciarReconhecimentoVoz() {
Â  Â  if (!vozAtiva) {
Â  Â  Â  Â  alert('Ative o reconhecimento de voz primeiro!');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (!reconhecimentoVoz) {
Â  Â  Â  Â  alert('Reconhecimento de voz nÃ£o disponÃ­vel.');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  try {
Â  Â  Â  Â  reconhecimentoVoz.start();
Â  Â  Â  Â  atualizarStatusVozInterface(true, true);
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error('Erro ao iniciar reconhecimento de voz:', error);
Â  Â  }
}

function processarComandoVoz(comando) {
Â  Â  console.log('Processando comando de voz:', comando);
Â  Â  
Â  Â  // Converte nÃºmeros por extenso para dÃ­gitos
Â  Â  const textoProcessado = converterNumerosPorExtenso(comando);
Â  Â  
Â  Â  // Extrai apenas nÃºmeros do comando
Â  Â  const numeros = textoProcessado.match(/\d+/g);
Â  Â  
Â  Â  if (numeros && numeros.length > 0) {
Â  Â  Â  Â  const idColaborador = numeros.join('');
Â  Â  Â  Â  
Â  Â  Â  Â  // Verifica se Ã© um ID vÃ¡lido (apenas nÃºmeros)
Â  Â  Â  Â  if (/^\d+$/.test(idColaborador)) {
Â  Â  Â  Â  Â  Â  document.getElementById('idColRetirada').value = idColaborador;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Feedback visual
Â  Â  Â  Â  Â  Â  const inputElement = document.getElementById('idColRetirada');
Â  Â  Â  Â  Â  Â  inputElement.style.borderColor = '#4CAF50';
Â  Â  Â  Â  Â  Â  inputElement.style.backgroundColor = '#1a331a';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  inputElement.style.borderColor = '';
Â  Â  Â  Â  Â  Â  Â  Â  inputElement.style.backgroundColor = '';
Â  Â  Â  Â  Â  Â  }, 2000);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Foca no botÃ£o de confirmaÃ§Ã£o apropriado
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const btnRetirada = document.getElementById('btnConfirmarRetirada');
Â  Â  Â  Â  Â  Â  Â  Â  const btnDevolucao = document.getElementById('btnDevolverChave');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (btnRetirada.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnRetirada.focus();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (btnDevolucao.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnDevolucao.focus();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  falarTexto(`ID ${idColaborador} reconhecido. Pressione o botÃ£o de confirmaÃ§Ã£o.`);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  falarTexto('ID invÃ¡lido. Por favor, diga apenas nÃºmeros.');
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  falarTexto('NÃ£o entendi o ID. Por favor, diga o nÃºmero do colaborador.');
Â  Â  }
Â  Â  
Â  Â  aguardandoRespostaVoz = false;
}

function converterNumerosPorExtenso(texto) {
Â  Â  const numerosPorExtenso = {
Â  Â  Â  Â  'zero': '0', 'um': '1', 'dois': '2', 'trÃªs': '3', 'quatro': '4',
Â  Â  Â  Â  'cinco': '5', 'seis': '6', 'sete': '7', 'oito': '8', 'nove': '9',
Â  Â  Â  Â  'dez': '10', 'onze': '11', 'doze': '12', 'treze': '13', 'catorze': '14',
Â  Â  Â  Â  'quinze': '15', 'dezesseis': '16', 'dezessete': '17', 'dezoito': '18',
Â  Â  Â  Â  'dezenove': '19', 'vinte': '20'
Â  Â  };
Â  Â  
Â  Â  let textoConvertido = texto.toLowerCase();
Â  Â  
Â  Â  for (const [extenso, numero] of Object.entries(numerosPorExtenso)) {
Â  Â  Â  Â  const regex = new RegExp('\\b' + extenso + '\\b', 'g');
Â  Â  Â  Â  textoConvertido = textoConvertido.replace(regex, numero);
Â  Â  }
Â  Â  
Â  Â  return textoConvertido;
}

function falarTexto(texto) {
Â  Â  if ('speechSynthesis' in window) {
Â  Â  Â  Â  const utterance = new SpeechSynthesisUtterance(texto);
Â  Â  Â  Â  utterance.lang = 'pt-BR';
Â  Â  Â  Â  utterance.rate = 1.0;
Â  Â  Â  Â  utterance.pitch = 1.0;
Â  Â  Â  Â  
Â  Â  Â  Â  window.speechSynthesis.speak(utterance);
Â  Â  }
}

function perguntarIdColaborador() {
Â  Â  if (vozAtiva) {
Â  Â  Â  Â  aguardandoRespostaVoz = true;
Â  Â  Â  Â  
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  falarTexto('Qual o ID do colaborador?');
Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  
Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  if (reconhecimentoVoz && aguardandoRespostaVoz) {
Â  Â  Â  Â  Â  Â  Â  Â  reconhecimentoVoz.start();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 1500);
Â  Â  }
}

function atualizarStatusVozInterface(ativa, ouvindo) {
Â  Â  const statusElement = document.getElementById('statusVoz');
Â  Â  const btnToggle = document.getElementById('btnToggleVoz');
Â  Â  const iconeVoz = document.getElementById('iconeVoz');
Â  Â  const voiceStatusElement = document.getElementById('voiceStatus');
Â  Â  
Â  Â  if (ativa) {
Â  Â  Â  Â  if (ouvindo) {
Â  Â  Â  Â  Â  Â  statusElement.textContent = 'Ouvindo...';
Â  Â  Â  Â  Â  Â  statusElement.className = 'badge bg-success';
Â  Â  Â  Â  Â  Â  btnToggle.innerHTML = '<i class="fa fa-microphone-slash"></i> Desativar Voz';
Â  Â  Â  Â  Â  Â  btnToggle.className = 'btn btn-warning btn-sm';
Â  Â  Â  Â  Â  Â  iconeVoz.className = 'fa fa-microphone text-success';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  voiceStatusElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  voiceStatusElement.className = 'voice-status voice-active';
Â  Â  Â  Â  Â  Â  voiceStatusElement.innerHTML = '<i class="fa fa-microphone"></i> Ouvindo... Fale agora';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  statusElement.textContent = 'Ativo';
Â  Â  Â  Â  Â  Â  statusElement.className = 'badge bg-info';
Â  Â  Â  Â  Â  Â  btnToggle.innerHTML = '<i class="fa fa-microphone-slash"></i> Desativar Voz';
Â  Â  Â  Â  Â  Â  btnToggle.className = 'btn btn-warning btn-sm';
Â  Â  Â  Â  Â  Â  iconeVoz.className = 'fa fa-microphone text-info';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  voiceStatusElement.style.display = 'block';
Â  Â  Â  Â  Â  Â  voiceStatusElement.className = 'voice-status voice-inactive';
Â  Â  Â  Â  Â  Â  voiceStatusElement.innerHTML = '<i class="fa fa-microphone"></i> Aguardando comando de voz...';
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  statusElement.textContent = 'Inativo';
Â  Â  Â  Â  statusElement.className = 'badge bg-danger';
Â  Â  Â  Â  btnToggle.innerHTML = '<i class="fa fa-microphone"></i> Ativar Voz';
Â  Â  Â  Â  btnToggle.className = 'btn btn-success btn-sm';
Â  Â  Â  Â  iconeVoz.className = 'fa fa-microphone text-muted';
Â  Â  Â  Â  
Â  Â  Â  Â  voiceStatusElement.style.display = 'none';
Â  Â  }
}

function testarVoz() {
Â  Â  if (!vozAtiva) {
Â  Â  Â  Â  alert('Ative o reconhecimento de voz primeiro!');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  falarTexto('Teste de voz funcionando. Diga o ID do colaborador quando solicitado.');
Â  Â  
Â  Â  // Simula uma pergunta de teste
Â  Â  setTimeout(() => {
Â  Â  Â  Â  if (vozAtiva) {
Â  Â  Â  Â  Â  Â  aguardandoRespostaVoz = true;
Â  Â  Â  Â  Â  Â  reconhecimentoVoz.start();
Â  Â  Â  Â  }
Â  Â  }, 2000);
}

// ====================================================================
// CONEXÃƒO COM LEITOR DE CÃ“DIGO DE BARRAS LB-W110BK (MODO TECLADO)
// ====================================================================

// FunÃ§Ã£o para inicializar o leitor no modo teclado
function inicializarLeitorTeclado() {
Â  Â  leitorConectado = true;
Â  Â  document.addEventListener('keydown', handleLeitorInput);
Â  Â  atualizarStatusLeitorInterface();
Â  Â  console.log('Leitor LB-W110BK inicializado no modo teclado');
}

// FunÃ§Ã£o para processar a entrada do leitor
function handleLeitorInput(event) {
Â  Â  // Ignora se nÃ£o for um caractere normal ou se for teclas especiais
Â  Â  if (event.key.length > 1 && !['Enter', 'Tab'].includes(event.key)) {
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Se for Enter, processa o cÃ³digo acumulado
Â  Â  if (event.key === 'Enter') {
Â  Â  Â  Â  event.preventDefault();
Â  Â  Â  Â  
Â  Â  Â  Â  if (codigoBuffer.trim()) {
Â  Â  Â  Â  Â  Â  processarCodigoBarras(codigoBuffer.trim());
Â  Â  Â  Â  Â  Â  codigoBuffer = '';
Â  Â  Â  Â  Â  Â  clearTimeout(timeoutBuffer);
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // Adiciona o caractere ao buffer
Â  Â  codigoBuffer += event.key;
Â  Â  
Â  Â  // Limpa o buffer apÃ³s um tempo (para casos onde nÃ£o hÃ¡ Enter)
Â  Â  clearTimeout(timeoutBuffer);
Â  Â  timeoutBuffer = setTimeout(() => {
Â  Â  Â  Â  if (codigoBuffer.length > 3) { // Assume que Ã© um cÃ³digo vÃ¡lido
Â  Â  Â  Â  Â  Â  processarCodigoBarras(codigoBuffer);
Â  Â  Â  Â  }
Â  Â  Â  Â  codigoBuffer = '';
Â  Â  }, 100);
}

// FunÃ§Ã£o para processar o cÃ³digo lido
function processarCodigoBarras(codigo) {
Â  Â  console.log('CÃ³digo lido:', codigo);
Â  Â  
Â  Â  // Remove possÃ­veis caracteres especiais do leitor
Â  Â  codigo = codigo.replace(/[^\w\-]/g, '');
Â  Â  
Â  Â  // Verifica se estÃ¡ na pÃ¡gina de QR Code
Â  Â  const paginaQR = document.getElementById('qr').style.display !== 'none';
Â  Â  
Â  Â  if (paginaQR) {
Â  Â  Â  Â  // Na pÃ¡gina QR, primeiro verifica se Ã© uma chave
Â  Â  Â  Â  if (codigo.startsWith('CH-')) {
Â  Â  Â  Â  Â  Â  onScanSuccess(codigo);
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  }
Â  Â  
Â  Â  // Se nÃ£o for chave ou nÃ£o estiver na pÃ¡gina QR, assume que Ã© ID de colaborador
Â  Â  if (/^\d+$/.test(codigo)) {
Â  Â  Â  Â  const inputColaborador = document.getElementById('idColRetirada');
Â  Â  Â  Â  if (inputColaborador) {
Â  Â  Â  Â  Â  Â  inputColaborador.value = codigo;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Foca no prÃ³ximo campo se estiver na Ã¡rea de confirmaÃ§Ã£o
Â  Â  Â  Â  Â  Â  if (document.getElementById('areaConfirmacao').style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btnRetirada = document.getElementById('btnConfirmarRetirada');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btnDevolucao = document.getElementById('btnDevolverChave');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (btnRetirada.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnRetirada.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (btnDevolucao.style.display !== 'none') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btnDevolucao.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  } else if (codigo.startsWith('CH-')) {
Â  Â  Â  Â  // Se for chave mas nÃ£o estÃ¡ na pÃ¡gina QR, muda para a pÃ¡gina QR
Â  Â  Â  Â  showPage('qr');
Â  Â  Â  Â  setTimeout(() => onScanSuccess(codigo), 500);
Â  Â  }
}

// FunÃ§Ã£o para conectar/desconectar o leitor
function toggleLeitor() {
Â  Â  if (leitorConectado) {
Â  Â  Â  Â  desconectarLeitor();
Â  Â  } else {
Â  Â  Â  Â  conectarLeitor();
Â  Â  }
}

// FunÃ§Ã£o para conectar o leitor
function conectarLeitor() {
Â  Â  if (!leitorConectado) {
Â  Â  Â  Â  inicializarLeitorTeclado();
Â  Â  Â  Â  alert('Leitor LB-W110BK conectado! Agora vocÃª pode usar o leitor para escanear QR Codes e cÃ³digos de barras.');
Â  Â  }
}

// FunÃ§Ã£o para desconectar o leitor
function desconectarLeitor() {
Â  Â  if (leitorConectado) {
Â  Â  Â  Â  document.removeEventListener('keydown', handleLeitorInput);
Â  Â  Â  Â  leitorConectado = false;
Â  Â  Â  Â  codigoBuffer = '';
Â  Â  Â  Â  clearTimeout(timeoutBuffer);
Â  Â  Â  Â  atualizarStatusLeitorInterface();
Â  Â  Â  Â  alert('Leitor desconectado.');
Â  Â  }
}

// FunÃ§Ã£o para atualizar a interface do leitor
function atualizarStatusLeitorInterface() {
Â  Â  const statusElement = document.getElementById('statusLeitor');
Â  Â  const btnToggle = document.getElementById('btnToggleLeitor');
Â  Â  const iconeLeitor = document.getElementById('iconeLeitor');
Â  Â  
Â  Â  if (leitorConectado) {
Â  Â  Â  Â  statusElement.textContent = 'Conectado';
Â  Â  Â  Â  statusElement.className = 'badge bg-success';
Â  Â  Â  Â  btnToggle.innerHTML = '<i class="fa fa-power-off"></i> Desconectar Leitor';
Â  Â  Â  Â  btnToggle.className = 'btn btn-warning btn-sm';
Â  Â  Â  Â  iconeLeitor.className = 'fa fa-barcode text-success';
Â  Â  } else {
Â  Â  Â  Â  statusElement.textContent = 'Desconectado';
Â  Â  Â  Â  statusElement.className = 'badge bg-danger';
Â  Â  Â  Â  btnToggle.innerHTML = '<i class="fa fa-plug"></i> Conectar Leitor';
Â  Â  Â  Â  btnToggle.className = 'btn btn-success btn-sm';
Â  Â  Â  Â  iconeLeitor.className = 'fa fa-barcode text-muted';
Â  Â  }
}

// FunÃ§Ã£o para testar o leitor
function testarLeitor() {
Â  Â  if (!leitorConectado) {
Â  Â  Â  Â  alert('Conecte o leitor primeiro!');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  const inputColaborador = document.getElementById('idColRetirada');
Â  Â  if (inputColaborador) {
Â  Â  Â  Â  inputColaborador.focus();
Â  Â  Â  Â  alert('Aponte o leitor para o cÃ³digo de barras do colaborador...');
Â  Â  } else {
Â  Â  Â  Â  alert('Aponte o leitor para um QR Code de chave...');
Â  Â  }
}

// FunÃ§Ã£o para focar automaticamente no campo de colaborador quando necessÃ¡rio
function focarCampoColaborador() {
Â  Â  setTimeout(() => {
Â  Â  Â  Â  const inputColaborador = document.getElementById('idColRetirada');
Â  Â  Â  Â  if (inputColaborador && document.getElementById('areaConfirmacao').style.display !== 'none') {
Â  Â  Â  Â  Â  Â  inputColaborador.focus();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Se a voz estiver ativa, pergunta qual o ID do colaborador
Â  Â  Â  Â  Â  Â  if (vozAtiva) {
Â  Â  Â  Â  Â  Â  Â  Â  perguntarIdColaborador();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }, 500);
}

// ====================================================================
// FUNÃ‡Ã•ES DE RELATÃ“RIOS CORRIGIDAS (UTF-8)
// ====================================================================

function gerarRelatorioChaves() {
Â  Â  // Cria o conteÃºdo CSV com BOM para UTF-8
Â  Â  let csvContent = "\uFEFF"; // BOM para UTF-8
Â  Â  csvContent += "ID da Chave,Nome da Chave,Status,Data de Cadastro\n";

Â  Â  chaves.forEach(chave => {
Â  Â  Â  Â  // Remove caracteres problemÃ¡ticos e formata corretamente
Â  Â  Â  Â  const nomeChave = limparTextoCSV(chave.nome);
Â  Â  Â  Â  const statusChave = limparTextoCSV(chave.status);
Â  Â  Â  Â  const dataCadastro = new Date().toLocaleDateString('pt-BR');
Â  Â  Â  Â  
Â  Â  Â  Â  let row = `${chave.id},"${nomeChave}","${statusChave}","${dataCadastro}"\n`;
Â  Â  Â  Â  csvContent += row;
Â  Â  });

Â  Â  criarDownloadCSV(csvContent, `relatorio_chaves_${formatarDataArquivo()}.csv`);
Â  Â  alert("RelatÃ³rio de chaves gerado com sucesso!");
}

function gerarRelatorioColaboradores() {
Â  Â  let csvContent = "\uFEFF"; // BOM para UTF-8
Â  Â  csvContent += "ID do Colaborador,Nome do Colaborador,Data de Cadastro\n";

Â  Â  colaboradores.forEach(colaborador => {
Â  Â  Â  Â  const nomeColaborador = limparTextoCSV(colaborador.nome);
Â  Â  Â  Â  const dataCadastro = new Date().toLocaleDateString('pt-BR');
Â  Â  Â  Â  
Â  Â  Â  Â  let row = `${colaborador.id},"${nomeColaborador}","${dataCadastro}"\n`;
Â  Â  Â  Â  csvContent += row;
Â  Â  });

Â  Â  criarDownloadCSV(csvContent, `relatorio_colaboradores_${formatarDataArquivo()}.csv`);
Â  Â  alert("RelatÃ³rio de colaboradores gerado com sucesso!");
}

function gerarRelatorioHistorico() {
Â  Â  let csvContent = "\uFEFF"; // BOM para UTF-8
Â  Â  csvContent += "ID da Chave,Nome do Colaborador,AÃ§Ã£o,Data,Status\n";

Â  Â  // Combina histÃ³rico online com pendentes
Â  Â  const todosRegistros = [...historico, ...historicoPendente];
Â  Â  todosRegistros.sort((a, b) => new Date(b.dataTimestamp) - new Date(a.dataTimestamp));

Â  Â  todosRegistros.forEach(registro => {
Â  Â  Â  Â  const nomeColaborador = limparTextoCSV(registro.colaborador);
Â  Â  Â  Â  const status = registro.sincronizado === false ? 'Pendente' : 'Sincronizado';
Â  Â  Â  Â  
Â  Â  Â  Â  let row = `${registro.chave},"${nomeColaborador}","${registro.acao}","${registro.data}","${status}"\n`;
Â  Â  Â  Â  csvContent += row;
Â  Â  });

Â  Â  criarDownloadCSV(csvContent, `relatorio_historico_${formatarDataArquivo()}.csv`);
Â  Â  alert("RelatÃ³rio de histÃ³rico gerado com sucesso!");
}

function gerarRelatorioCompleto() {
Â  Â  let csvContent = "\uFEFF"; // BOM para UTF-8
Â  Â  csvContent += "Tipo,ID,Nome,Status,Data\n";

Â  Â  // Adiciona chaves
Â  Â  chaves.forEach(chave => {
Â  Â  Â  Â  const nomeChave = limparTextoCSV(chave.nome);
Â  Â  Â  Â  const statusChave = limparTextoCSV(chave.status);
Â  Â  Â  Â  const dataCadastro = new Date().toLocaleDateString('pt-BR');
Â  Â  Â  Â  
Â  Â  Â  Â  let row = `Chave,${chave.id},"${nomeChave}","${statusChave}","${dataCadastro}"\n`;
Â  Â  Â  Â  csvContent += row;
Â  Â  });

Â  Â  // Adiciona colaboradores
Â  Â  colaboradores.forEach(colaborador => {
Â  Â  Â  Â  const nomeColaborador = limparTextoCSV(colaborador.nome);
Â  Â  Â  Â  const dataCadastro = new Date().toLocaleDateString('pt-BR');
Â  Â  Â  Â  
Â  Â  Â  Â  let row = `Colaborador,${colaborador.id},"${nomeColaborador}","Ativo","${dataCadastro}"\n`;
Â  Â  Â  Â  csvContent += row;
Â  Â  });

Â  Â  // Adiciona histÃ³rico
Â  Â  const todosRegistros = [...historico, ...historicoPendente];
Â  Â  todosRegistros.forEach(registro => {
Â  Â  Â  Â  const nomeColaborador = limparTextoCSV(registro.colaborador);
Â  Â  Â  Â  const status = registro.sincronizado === false ? 'Pendente' : 'Sincronizado';
Â  Â  Â  Â  
Â  Â  Â  Â  let row = `MovimentaÃ§Ã£o,${registro.chave},"${nomeColaborador}","${registro.acao}","${registro.data}"\n`;
Â  Â  Â  Â  csvContent += row;
Â  Â  });

Â  Â  criarDownloadCSV(csvContent, `relatorio_completo_${formatarDataArquivo()}.csv`);
Â  Â  alert("RelatÃ³rio completo gerado com sucesso!");
}

// FunÃ§Ãµes auxiliares para formataÃ§Ã£o correta do CSV
function limparTextoCSV(texto) {
Â  Â  if (!texto) return '';
Â  Â  
Â  Â  // Remove caracteres problemÃ¡ticos para CSV
Â  Â  return texto.toString()
Â  Â  Â  Â  .replace(/"/g, '""') // Escapa aspas duplas
Â  Â  Â  Â  .replace(/\n/g, ' ') // Remove quebras de linha
Â  Â  Â  Â  .replace(/\r/g, ' ') // Remove carriage return
Â  Â  Â  Â  .replace(/\t/g, ' ') // Remove tabs
Â  Â  Â  Â  .trim();
}

function formatarDataArquivo() {
Â  Â  const data = new Date();
Â  Â  return data.toISOString().split('T')[0]; // Formato YYYY-MM-DD
}

function criarDownloadCSV(csvContent, nomeArquivo) {
Â  Â  // Cria blob com encoding UTF-8
Â  Â  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
Â  Â  
Â  Â  // Cria link de download
Â  Â  const link = document.createElement("a");
Â  Â  const url = URL.createObjectURL(blob);
Â  Â  
Â  Â  link.setAttribute("href", url);
Â  Â  link.setAttribute("download", nomeArquivo);
Â  Â  link.style.visibility = 'hidden';
Â  Â  
Â  Â  document.body.appendChild(link);
Â  Â  link.click();
Â  Â  document.body.removeChild(link);
}

// ====================================================================
// NOVAS FUNCIONALIDADES: PÃGINA DE QR CODES
// ====================================================================

function gerarTodosQRCodes() {
Â  Â  const container = document.getElementById('qrCodesContainer');
Â  Â  container.innerHTML = '';

Â  Â  chaves.forEach(chave => {
Â  Â  Â  Â  const qrCard = document.createElement('div');
Â  Â  Â  Â  qrCard.className = 'qr-card';
Â  Â  Â  Â  
Â  Â  Â  Â  const qrDiv = document.createElement('div');
Â  Â  Â  Â  qrDiv.id = `qr-${chave.id}`;
Â  Â  Â  Â  
Â  Â  Â  Â  const qrInfo = document.createElement('div');
Â  Â  Â  Â  qrInfo.className = 'qr-info';
Â  Â  Â  Â  
Â  Â  Â  Â  const statusClass = chave.status.includes('DisponÃ­vel') ? 'status-disponivel-badge' : 'status-retirada-badge';
Â  Â  Â  Â  
Â  Â  Â  Â  qrInfo.innerHTML = `
Â  Â  Â  Â  Â  Â  <h5>${chave.id}</h5>
Â  Â  Â  Â  Â  Â  <p class="text-muted">${chave.nome}</p>
Â  Â  Â  Â  Â  Â  <span class="status ${statusClass}">${chave.status}</span>
Â  Â  Â  Â  Â  Â  <div class="mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-outline-light" onclick="baixarQRCodeIndividual('${chave.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-download"></i> Baixar
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  
Â  Â  Â  Â  qrCard.appendChild(qrDiv);
Â  Â  Â  Â  qrCard.appendChild(qrInfo);
Â  Â  Â  Â  container.appendChild(qrCard);
Â  Â  Â  Â  
Â  Â  Â  Â  // Gera o QR Code
Â  Â  Â  Â  new QRCode(qrDiv, {
Â  Â  Â  Â  Â  Â  text: chave.id,
Â  Â  Â  Â  Â  Â  width: 150,
Â  Â  Â  Â  Â  Â  height: 150,
Â  Â  Â  Â  Â  Â  colorDark: "#000000",
Â  Â  Â  Â  Â  Â  colorLight: "#ffffff",
Â  Â  Â  Â  Â  Â  correctLevel: QRCode.CorrectLevel.H
Â  Â  Â  Â  });
Â  Â  });
}

function baixarQRCodeIndividual(chaveId) {
Â  Â  const chave = chaves.find(c => c.id === chaveId);
Â  Â  if (!chave) return;
Â  Â  
Â  Â  const qrDiv = document.getElementById(`qr-${chaveId}`);
Â  Â  const canvas = qrDiv.querySelector('canvas');
Â  Â  
Â  Â  if (canvas) {
Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  link.download = `QRCode_${chaveId}_${chave.nome}.png`;
Â  Â  Â  Â  link.href = canvas.toDataURL('image/png');
Â  Â  Â  Â  link.click();
Â  Â  }
}

function baixarTodosQRCodes() {
Â  Â  alert("Funcionalidade de download em lote serÃ¡ implementada em breve!");
Â  Â  // Em uma implementaÃ§Ã£o real, vocÃª usaria uma biblioteca como JSZip
Â  Â  // para compactar todos os QR Codes e fazer download
}

function imprimirQRCodes() {
Â  Â  window.print();
}

// ====================================================================
// NOVAS FUNCIONALIDADES: EXCLUSÃƒO DE COLABORADORES
// ====================================================================

function solicitarExclusaoColaborador(index) {
Â  Â  const colaborador = colaboradores[index];
Â  Â  if (!colaborador) return;
Â  Â  
Â  Â  // Verifica se o colaborador tem movimentaÃ§Ãµes no histÃ³rico
Â  Â  const temMovimentacoes = historico.some(h => h.colaborador === colaborador.nome) || 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  historicoPendente.some(h => h.colaborador === colaborador.nome);
Â  Â  
Â  Â  if (temMovimentacoes) {
Â  Â  Â  Â  alert('NÃ£o Ã© possÃ­vel excluir este colaborador pois existem movimentaÃ§Ãµes associadas a ele no histÃ³rico.');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  colaboradorParaExcluir = index;
Â  Â  
Â  Â  document.getElementById('mensagemExclusao').textContent = 
Â  Â  Â  Â  `Tem certeza que deseja excluir o colaborador ${colaborador.id} - ${colaborador.nome}?`;
Â  Â  
Â  Â  const modal = new bootstrap.Modal(document.getElementById('modalConfirmarExclusao'));
Â  Â  modal.show();
}

function confirmarExclusaoColaborador() {
Â  Â  if (colaboradorParaExcluir === null) return;
Â  Â  
Â  Â  const colaborador = colaboradores[colaboradorParaExcluir];
Â  Â  
Â  Â  db.collection("colaboradores").doc(colaborador.idDoc).delete()
Â  Â  .then(() => {
Â  Â  Â  Â  alert(`Colaborador ${colaborador.id} - ${colaborador.nome} excluÃ­do com sucesso!`);
Â  Â  Â  Â  const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmarExclusao'));
Â  Â  Â  Â  modal.hide();
Â  Â  Â  Â  colaboradorParaExcluir = null;
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao excluir colaborador:", error);
Â  Â  Â  Â  alert("Erro ao excluir colaborador. Tente novamente.");
Â  Â  });
}

// ====================================================================
// FUNCIONALIDADE OFFLINE (MANTIDA)
// ====================================================================

function configurarDetecaoConexao() {
Â  Â  isOnline = navigator.onLine;
Â  Â  atualizarStatusConexao();

Â  Â  window.addEventListener('online', function() {
Â  Â  Â  Â  isOnline = true;
Â  Â  Â  Â  atualizarStatusConexao();
Â  Â  Â  Â  sincronizarDadosPendentes();
Â  Â  });

Â  Â  window.addEventListener('offline', function() {
Â  Â  Â  Â  isOnline = false;
Â  Â  Â  Â  atualizarStatusConexao();
Â  Â  });
}

function atualizarStatusConexao() {
Â  Â  const onlineIndicator = document.getElementById('onlineIndicator');
Â  Â  const offlineIndicator = document.getElementById('offlineIndicator');
Â  Â  const statusConexao = document.getElementById('statusConexao');

Â  Â  if (isOnline) {
Â  Â  Â  Â  onlineIndicator.style.display = 'block';
Â  Â  Â  Â  offlineIndicator.style.display = 'none';
Â  Â  Â  Â  statusConexao.textContent = 'Online';
Â  Â  Â  Â  statusConexao.className = 'badge bg-success';
Â  Â  } else {
Â  Â  Â  Â  onlineIndicator.style.display = 'none';
Â  Â  Â  Â  offlineIndicator.style.display = 'block';
Â  Â  Â  Â  statusConexao.textContent = 'Offline';
Â  Â  Â  Â  statusConexao.className = 'badge bg-danger';
Â  Â  }
}

function carregarDadosOffline() {
Â  Â  const pendentesSalvos = localStorage.getItem('historicoPendente');
Â  Â  if (pendentesSalvos) {
Â  Â  Â  Â  historicoPendente = JSON.parse(pendentesSalvos);
Â  Â  }

Â  Â  const ultimaSync = localStorage.getItem('ultimaSincronizacao');
Â  Â  if (ultimaSync) {
Â  Â  Â  Â  document.getElementById('ultimaSync').textContent = new Date(ultimaSync).toLocaleString('pt-BR');
Â  Â  }

Â  Â  atualizarContadoresOffline();
}

function salvarDadosOffline() {
Â  Â  localStorage.setItem('historicoPendente', JSON.stringify(historicoPendente));
Â  Â  atualizarContadoresOffline();
}

function atualizarContadoresOffline() {
Â  Â  document.getElementById('contadorPendentes').textContent = historicoPendente.length;
Â  Â  document.getElementById('pendentesSync').textContent = historicoPendente.length;
Â  Â  atualizarListaPendentes();
}

function adicionarMovimentacaoOffline(chave, colaborador, acao) {
Â  Â  const movimentacao = {
Â  Â  Â  Â  id: Date.now().toString(),
Â  Â  Â  Â  chave: chave.id,
Â  Â  Â  Â  nomeChave: chave.nome,
Â  Â  Â  Â  colaborador: colaborador.nome,
Â  Â  Â  Â  idColaborador: colaborador.id,
Â  Â  Â  Â  acao: acao,
Â  Â  Â  Â  data: new Date().toLocaleString('pt-BR'),
Â  Â  Â  Â  dataTimestamp: new Date().toISOString(),
Â  Â  Â  Â  sincronizado: false
Â  Â  };

Â  Â  historicoPendente.push(movimentacao);
Â  Â  salvarDadosOffline();

Â  Â  if (isOnline) {
Â  Â  Â  Â  sincronizarMovimentacao(movimentacao);
Â  Â  } else {
Â  Â  Â  Â  atualizarStatusChaveLocal(chave, colaborador, acao);
Â  Â  }

Â  Â  return movimentacao;
}

function atualizarStatusChaveLocal(chave, colaborador, acao) {
Â  Â  const chaveIndex = chaves.findIndex(c => c.id === chave.id);
Â  Â  if (chaveIndex !== -1) {
Â  Â  Â  Â  if (acao === "RETIRADA") {
Â  Â  Â  Â  Â  Â  chaves[chaveIndex].status = "Retirada por " + colaborador.nome + " (Offline)";
Â  Â  Â  Â  } else if (acao === "DEVOLUÃ‡ÃƒO") {
Â  Â  Â  Â  Â  Â  chaves[chaveIndex].status = "DisponÃ­vel (Offline)";
Â  Â  Â  Â  }
Â  Â  Â  Â  atualizarListas();
Â  Â  }
}

async function sincronizarDadosPendentes() {
Â  Â  if (!isOnline || historicoPendente.length === 0) return;

Â  Â  document.getElementById('syncStatus').style.display = 'block';
Â  Â  
Â  Â  let sucessos = 0;
Â  Â  let erros = 0;

Â  Â  for (let i = historicoPendente.length - 1; i >= 0; i--) {
Â  Â  Â  Â  const movimentacao = historicoPendente[i];
Â  Â  Â  Â  
Â  Â  Â  Â  if (await sincronizarMovimentacao(movimentacao)) {
Â  Â  Â  Â  Â  Â  sucessos++;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  erros++;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  document.getElementById('syncStatus').style.display = 'none';
Â  Â  
Â  Â  if (erros === 0) {
Â  Â  Â  Â  localStorage.setItem('ultimaSincronizacao', new Date().toISOString());
Â  Â  Â  Â  document.getElementById('ultimaSync').textContent = new Date().toLocaleString('pt-BR');
Â  Â  }
}

async function sincronizarMovimentacao(movimentacao) {
Â  Â  try {
Â  Â  Â  Â  await db.collection("historico").add({
Â  Â  Â  Â  Â  Â  chave: movimentacao.chave,
Â  Â  Â  Â  Â  Â  colaborador: movimentacao.colaborador,
Â  Â  Â  Â  Â  Â  acao: movimentacao.acao,
Â  Â  Â  Â  Â  Â  data: movimentacao.data,
Â  Â  Â  Â  Â  Â  dataTimestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  Â  });

Â  Â  Â  Â  const chave = chaves.find(c => c.id === movimentacao.chave);
Â  Â  Â  Â  if (chave) {
Â  Â  Â  Â  Â  Â  if (movimentacao.acao === "RETIRADA") {
Â  Â  Â  Â  Â  Â  Â  Â  await db.collection("chaves").doc(chave.idDoc).update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: "Retirada por " + movimentacao.colaborador
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else if (movimentacao.acao === "DEVOLUÃ‡ÃƒO") {
Â  Â  Â  Â  Â  Â  Â  Â  await db.collection("chaves").doc(chave.idDoc).update({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: "DisponÃ­vel"
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  historicoPendente = historicoPendente.filter(m => m.id !== movimentacao.id);
Â  Â  Â  Â  salvarDadosOffline();
Â  Â  Â  Â  
Â  Â  Â  Â  return true;
Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Erro ao sincronizar movimentaÃ§Ã£o:", error);
Â  Â  Â  Â  return false;
Â  Â  }
}

function atualizarListaPendentes() {
Â  Â  const lista = document.getElementById('listaPendentes');
Â  Â  lista.innerHTML = '';

Â  Â  historicoPendente.forEach(movimentacao => {
Â  Â  Â  Â  const acaoClass = movimentacao.acao.includes('RETIRADA') ? 'text-danger' : 'text-success';
Â  Â  Â  Â  lista.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${movimentacao.chave} - ${movimentacao.nomeChave}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${movimentacao.colaborador}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="${acaoClass}">${movimentacao.acao}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${movimentacao.data}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="pending-sync">Pendente</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-warning ms-2" onclick="tentarSincronizarUnico('${movimentacao.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-refresh"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });
}

async function tentarSincronizarUnico(id) {
Â  Â  const movimentacao = historicoPendente.find(m => m.id === id);
Â  Â  if (movimentacao && await sincronizarMovimentacao(movimentacao)) {
Â  Â  Â  Â  alert('MovimentaÃ§Ã£o sincronizada com sucesso!');
Â  Â  }
}

// ====================================================================
// FUNÃ‡Ã•ES DE LEITURA DO FIREBASE
// ====================================================================

function carregarChavesFirebase() {
Â  Â  db.collection("chaves").onSnapshot((snapshot) => {
Â  Â  Â  Â  chaves = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
Â  Â  Â  Â  
Â  Â  Â  Â  contadorChave = chaves.reduce((max, c) => {
Â  Â  Â  Â  Â  Â  const num = parseInt(c.id.split('-')[1]);
Â  Â  Â  Â  Â  Â  return num > max ? num : max;
Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  
Â  Â  Â  Â  atualizarListas();
Â  Â  Â  Â  atualizarEstatisticas();
Â  Â  }, error => {
Â  Â  Â  Â  console.error("Erro ao carregar chaves:", error);
Â  Â  });
}

function carregarColaboradoresFirebase() {
Â  Â  db.collection("colaboradores").onSnapshot((snapshot) => {
Â  Â  Â  Â  colaboradores = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));

Â  Â  Â  Â  contadorColaborador = colaboradores.reduce((max, c) => {
Â  Â  Â  Â  Â  Â  const num = parseInt(c.id);
Â  Â  Â  Â  Â  Â  return num > max ? num : max;
Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById("ultimoColID").innerText = contadorColaborador > 0 ? contadorColaborador.toString().padStart(2, "0") : "Nenhum";
Â  Â  Â  Â  atualizarListas();
Â  Â  Â  Â  atualizarEstatisticas();
Â  Â  }, error => {
Â  Â  Â  Â  console.error("Erro ao carregar colaboradores:", error);
Â  Â  });
}

function carregarHistoricoFirebase() {
Â  Â  db.collection("historico").orderBy("dataTimestamp", "desc").onSnapshot((snapshot) => {
Â  Â  Â  Â  historico = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
Â  Â  Â  Â  atualizarListas();
Â  Â  Â  Â  atualizarEstatisticas();
Â  Â  }, error => {
Â  Â  Â  Â  console.error("Erro ao carregar histÃ³rico:", error);
Â  Â  });
}

// ====================================================================
// FUNÃ‡Ã•ES DE ESCRITA E CRIAÃ‡ÃƒO
// ====================================================================

function salvarMovimentacao(chave, colaborador, acao) {
Â  Â  if (isOnline) {
Â  Â  Â  Â  db.collection("historico").add({
Â  Â  Â  Â  Â  Â  chave: chave.id,
Â  Â  Â  Â  Â  Â  colaborador: colaborador.nome,
Â  Â  Â  Â  Â  Â  acao: acao,
Â  Â  Â  Â  Â  Â  data: new Date().toLocaleString('pt-BR'),
Â  Â  Â  Â  Â  Â  dataTimestamp: firebase.firestore.FieldValue.serverTimestamp() 
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  console.error("Erro ao salvar histÃ³rico:", error);
Â  Â  Â  Â  Â  Â  adicionarMovimentacaoOffline(chave, colaborador, acao);
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  adicionarMovimentacaoOffline(chave, colaborador, acao);
Â  Â  }
}

function cadastrarChave() {
Â  Â  const nome = document.getElementById("nomeChave").value.trim();
Â  Â  if (!nome) return alert("Digite o nome da chave.");

Â  Â  const novoContador = contadorChave + 1;
Â  Â  const id = "CH-" + novoContador.toString().padStart(3, "0"); 

Â  Â  db.collection("chaves").add({
Â  Â  Â  Â  id, 
Â  Â  Â  Â  nome, 
Â  Â  Â  Â  status: "DisponÃ­vel" 
Â  Â  })
Â  Â  .then(() => {
Â  Â  Â  Â  document.getElementById("nomeChave").value = "";
Â  Â  Â  Â  gerarQRCode(id);
Â  Â  Â  Â  alert(`Chave ${id} cadastrada com sucesso!`);
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao cadastrar chave:", error);
Â  Â  Â  Â  alert("Erro ao cadastrar chave. Verifique o console.");
Â  Â  });
}

function cadastrarColaborador() {
Â  Â  const nome = document.getElementById("nomeColaborador").value.trim();
Â  Â  if (!nome) return alert("Digite o nome do colaborador.");

Â  Â  const novoContador = contadorColaborador + 1;
Â  Â  let id = novoContador.toString().padStart(2, "0");

Â  Â  db.collection("colaboradores").add({ 
Â  Â  Â  Â  id, 
Â  Â  Â  Â  nome 
Â  Â  })
Â  Â  .then(() => {
Â  Â  Â  Â  document.getElementById("nomeColaborador").value = "";
Â  Â  Â  Â  alert(`Colaborador ${id} - ${nome} cadastrado com sucesso!`);
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao cadastrar colaborador:", error);
Â  Â  Â  Â  alert("Erro ao cadastrar colaborador. Verifique o console.");
Â  Â  });
}

// ====================================================================
// FUNÃ‡Ã•ES DE RETIRADA E DEVOLUÃ‡ÃƒO
// ====================================================================

function validarIdColaborador(idCol) {
Â  Â  if (!idCol) return "Digite o ID do colaborador.";
Â  Â  if (!/^\d+$/.test(idCol)) return "ID do colaborador deve conter apenas nÃºmeros.";
Â  Â  if (colaboradores.find(c => c.id === idCol)) return null;
Â  Â  return "Colaborador nÃ£o encontrado.";
}

function confirmarRetirada() {
Â  Â  if (!chaveSelecionada) {
Â  Â  Â  Â  alert("Erro: Nenhuma chave foi escaneada.");
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  const idCol = document.getElementById("idColRetirada").value.trim();
Â  Â  const validacao = validarIdColaborador(idCol);
Â  Â  if (validacao) {
Â  Â  Â  Â  alert(validacao);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const colab = colaboradores.find(c => c.id === idCol);
Â  Â  const chave = chaves.find(c => c.id === chaveSelecionada);
Â  Â  
Â  Â  if (!chave) {
Â  Â  Â  Â  alert("Chave nÃ£o encontrada no sistema.");
Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (chave.status !== "DisponÃ­vel" && !chave.status.includes("Offline")) {
Â  Â  Â  Â  alert(`Erro: Esta chave jÃ¡ estÃ¡ ${chave.status}. Use a opÃ§Ã£o de DevoluÃ§Ã£o.`);
Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (isOnline) {
Â  Â  Â  Â  db.collection("chaves").doc(chave.idDoc).update({
Â  Â  Â  Â  Â  Â  status: "Retirada por " + colab.nome
Â  Â  Â  Â  })
Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  salvarMovimentacao(chave, colab, "RETIRADA");
Â  Â  Â  Â  Â  Â  alert(`Sucesso! Chave ${chave.id} retirada por ${colab.nome}.`);
Â  Â  Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  console.error("Erro ao retirar chave:", error);
Â  Â  Â  Â  Â  Â  const movimentacao = adicionarMovimentacaoOffline(chave, colab, "RETIRADA");
Â  Â  Â  Â  Â  Â  alert(`âœ… Retirada registrada offline! SerÃ¡ sincronizada automaticamente.`);
Â  Â  Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  const movimentacao = adicionarMovimentacaoOffline(chave, colab, "RETIRADA");
Â  Â  Â  Â  alert(`âœ… Retirada registrada offline! (ID: ${movimentacao.id})\nSerÃ¡ sincronizada quando a conexÃ£o voltar.`);
Â  Â  Â  Â  reiniciarScanner();
Â  Â  }
}

function confirmarDevolucao() {
Â  Â  if (!chaveSelecionada) {
Â  Â  Â  Â  alert("Erro: Nenhuma chave foi escaneada.");
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  const idCol = document.getElementById("idColRetirada").value.trim();
Â  Â  const validacao = validarIdColaborador(idCol);
Â  Â  if (validacao) {
Â  Â  Â  Â  alert(validacao);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const colab = colaboradores.find(c => c.id === idCol);
Â  Â  const chave = chaves.find(c => c.id === chaveSelecionada);
Â  Â  
Â  Â  if (!chave) {
Â  Â  Â  Â  alert("Chave nÃ£o encontrada no sistema.");
Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (chave.status === "DisponÃ­vel" || chave.status === "DisponÃ­vel (Offline)") {
Â  Â  Â  Â  alert("Erro: Esta chave jÃ¡ estÃ¡ disponÃ­vel.");
Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  const nomeQuemRetirou = chave.status.replace("Retirada por ", "").replace(" (Offline)", "");
Â  Â  if (!chave.status.includes(colab.nome) && nomeQuemRetirou !== colab.nome) {
Â  Â  Â  Â  if (!confirm(`AtenÃ§Ã£o: A chave foi retirada por ${nomeQuemRetirou}. Deseja confirmar a devoluÃ§Ã£o por ${colab.nome} mesmo assim?`)) {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  if (isOnline) {
Â  Â  Â  Â  db.collection("chaves").doc(chave.idDoc).update({
Â  Â  Â  Â  Â  Â  status: "DisponÃ­vel"
Â  Â  Â  Â  })
Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  Â  salvarMovimentacao(chave, colab, "DEVOLUÃ‡ÃƒO");
Â  Â  Â  Â  Â  Â  alert(`Sucesso! Chave ${chave.id} devolvida por ${colab.nome}.`);
Â  Â  Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  console.error("Erro ao devolver chave:", error);
Â  Â  Â  Â  Â  Â  const movimentacao = adicionarMovimentacaoOffline(chave, colab, "DEVOLUÃ‡ÃƒO");
Â  Â  Â  Â  Â  Â  alert(`âœ… DevoluÃ§Ã£o registrada offline! SerÃ¡ sincronizada automaticamente.`);
Â  Â  Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  Â  const movimentacao = adicionarMovimentacaoOffline(chave, colab, "DEVOLUÃ‡ÃƒO");
Â  Â  Â  Â  alert(`âœ… DevoluÃ§Ã£o registrada offline! (ID: ${movimentacao.id})\nSerÃ¡ sincronizada quando a conexÃ£o voltar.`);
Â  Â  Â  Â  reiniciarScanner();
Â  Â  }
}

function salvarEdicao() {
Â  Â  const novoNome = document.getElementById("modalInput").value.trim();
Â  Â  if (!novoNome) return alert("Digite um nome vÃ¡lido.");

Â  Â  let colecao, idDoc, tipo;
Â  Â  
Â  Â  if (tipoEdicao === "chave") {
Â  Â  Â  Â  const chaveEditada = chaves[itemEditando];
Â  Â  Â  Â  colecao = "chaves";
Â  Â  Â  Â  idDoc = chaveEditada.idDoc;
Â  Â  Â  Â  tipo = "Chave";
Â  Â  } else {
Â  Â  Â  Â  const colabEditado = colaboradores[itemEditando];
Â  Â  Â  Â  colecao = "colaboradores";
Â  Â  Â  Â  idDoc = colabEditado.idDoc;
Â  Â  Â  Â  tipo = "Colaborador";
Â  Â  }

Â  Â  db.collection(colecao).doc(idDoc).update({
Â  Â  Â  Â  nome: novoNome
Â  Â  })
Â  Â  .then(() => {
Â  Â  Â  Â  alert(`${tipo} atualizado para "${novoNome}".`);
Â  Â  Â  Â  const modalElement = document.getElementById("modalEditar");
Â  Â  Â  Â  const modalInstance = bootstrap.Modal.getInstance(modalElement);
Â  Â  Â  Â  if (modalInstance) modalInstance.hide();
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao salvar ediÃ§Ã£o:", error);
Â  Â  Â  Â  alert("Erro ao salvar ediÃ§Ã£o.");
Â  Â  });
}

// ====================================================================
// FUNÃ‡Ã•ES DO SCANNER
// ====================================================================

function showPage(page, event) {
Â  Â  if(event) event.preventDefault(); 

Â  Â  document.querySelectorAll("section").forEach(s => s.style.display = "none");
Â  Â  document.getElementById(page).style.display = "block";

Â  Â  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("activeMenu"));
Â  Â  if(event) event.currentTarget.classList.add("activeMenu");
Â  Â  else document.querySelector(`.sidebar a[onclick*="${page}"]`).classList.add("activeMenu");

Â  Â  if (page === 'qr') {
Â  Â  Â  Â  iniciarScanner();
Â  Â  } else {
Â  Â  Â  Â  pararScanner();
Â  Â  }

Â  Â  if (page === 'colaboradores') {
Â  Â  Â  Â  document.getElementById("ultimoColID").innerText = contadorColaborador > 0 ? contadorColaborador.toString().padStart(2, "0") : "Nenhum";
Â  Â  }

Â  Â  if (page === 'offline') {
Â  Â  Â  Â  atualizarListaPendentes();
Â  Â  }

Â  Â  if (page === 'qr-codes') {
Â  Â  Â  Â  gerarTodosQRCodes();
Â  Â  }

Â  Â  if (page === 'relatorios') {
Â  Â  Â  Â  atualizarEstatisticas();
Â  Â  }
}

function iniciarScanner() {
Â  Â  if (html5QrcodeScanner && scannerAtivo) {
Â  Â  Â  Â  retomarScanner();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (html5QrcodeScanner) {
Â  Â  Â  Â  html5QrcodeScanner.clear();
Â  Â  }

Â  Â  html5QrcodeScanner = new Html5QrcodeScanner(
Â  Â  Â  Â  "reader", 
Â  Â  Â  Â  { 
Â  Â  Â  Â  Â  Â  fps: 10, 
Â  Â  Â  Â  Â  Â  qrbox: 250, 
Â  Â  Â  Â  Â  Â  disableFlip: false,
Â  Â  Â  Â  Â  Â  facingMode: "environment",
Â  Â  Â  Â  Â  Â  videoConstraints: {
Â  Â  Â  Â  Â  Â  Â  Â  facingMode: { ideal: "environment" }, 
Â  Â  Â  Â  Â  Â  Â  Â  width: { max: 480 },
Â  Â  Â  Â  Â  Â  Â  Â  height: { max: 480 }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  );

Â  Â  html5QrcodeScanner.render(onScanSuccess, onScanError);
Â  Â  scannerAtivo = true;
Â  Â  scannerPausado = false;
Â  Â  
Â  Â  atualizarStatusScanner();
Â  Â  document.getElementById("btnToggleScanner").style.display = "block";
}

function pararScanner() {
Â  Â  if (html5QrcodeScanner && scannerAtivo) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  html5QrcodeScanner.clear();
Â  Â  Â  Â  Â  Â  scannerAtivo = false;
Â  Â  Â  Â  Â  Â  scannerPausado = false;
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.warn("Erro ao parar scanner:", error);
Â  Â  Â  Â  }
Â  Â  }
}

function pausarScanner() {
Â  Â  if (html5QrcodeScanner && scannerAtivo && !scannerPausado) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  html5QrcodeScanner.pause();
Â  Â  Â  Â  Â  Â  scannerPausado = true;
Â  Â  Â  Â  Â  Â  atualizarStatusScanner();
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.warn("Erro ao pausar scanner:", error);
Â  Â  Â  Â  }
Â  Â  }
}

function retomarScanner() {
Â  Â  if (html5QrcodeScanner && scannerAtivo && scannerPausado) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  html5QrcodeScanner.resume();
Â  Â  Â  Â  Â  Â  scannerPausado = false;
Â  Â  Â  Â  Â  Â  atualizarStatusScanner();
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.warn("Erro ao retomar scanner:", error);
Â  Â  Â  Â  }
Â  Â  }
}

function toggleScanner() {
Â  Â  if (scannerPausado) {
Â  Â  Â  Â  retomarScanner();
Â  Â  } else {
Â  Â  Â  Â  pausarScanner();
Â  Â  }
}

function atualizarStatusScanner() {
Â  Â  const statusElement = document.getElementById("scannerStatus");
Â  Â  const toggleButton = document.getElementById("btnToggleScanner");
Â  Â  
Â  Â  if (scannerAtivo) {
Â  Â  Â  Â  statusElement.style.display = "block";
Â  Â  Â  Â  if (scannerPausado) {
Â  Â  Â  Â  Â  Â  statusElement.className = "scanner-status scanner-paused";
Â  Â  Â  Â  Â  Â  statusElement.innerHTML = "<i class='fa fa-pause'></i> Scanner pausado";
Â  Â  Â  Â  Â  Â  toggleButton.innerHTML = "<i class='fa fa-play'></i> Retomar Scanner";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  statusElement.className = "scanner-status scanner-active";
Â  Â  Â  Â  Â  Â  statusElement.innerHTML = "<i class='fa fa-camera'></i> Scanner ativo";
Â  Â  Â  Â  Â  Â  toggleButton.innerHTML = "<i class='fa fa-pause'></i> Pausar Scanner";
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  statusElement.style.display = "none";
Â  Â  }
}

function onScanSuccess(decodedText) {
Â  Â  pausarScanner();
Â  Â  
Â  Â  const chave = chaves.find(c => c.id === decodedText);

Â  Â  if (!chave) {
Â  Â  Â  Â  document.getElementById("chaveDetectada").innerText = `ERRO: Chave '${decodedText}' nÃ£o encontrada.`;
Â  Â  Â  Â  document.getElementById("areaConfirmacao").style.display = "none";
Â  Â  Â  Â  alert("QR Code lido, mas nenhuma chave correspondente foi encontrada no sistema.");
Â  Â  Â  Â  
Â  Â  Â  Â  setTimeout(retomarScanner, 2000);
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  chaveSelecionada = decodedText;
Â  Â  document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
Â  Â  document.getElementById("areaConfirmacao").style.display = "block";

Â  Â  const isDisponivel = chave.status === "DisponÃ­vel" || chave.status === "DisponÃ­vel (Offline)";
Â  Â  
Â  Â  document.getElementById("btnConfirmarRetirada").style.display = isDisponivel ? "block" : "none";
Â  Â  document.getElementById("btnDevolverChave").style.display = isDisponivel ? "none" : "block";
Â  Â  document.getElementById("idColRetirada").placeholder = isDisponivel ? 
Â  Â  Â  Â  "ID do colaborador que vai RETIRAR" : 
Â  Â  Â  Â  "ID do colaborador que vai DEVOLVER";
Â  Â  
Â  Â  // Foca automaticamente no campo do colaborador
Â  Â  focarCampoColaborador();
}

function onScanError(errorMessage) {
Â  Â  // Erros sÃ£o esperados durante a operaÃ§Ã£o normal do scanner
}

function reiniciarScanner() {
Â  Â  document.getElementById("areaConfirmacao").style.display = "none";
Â  Â  document.getElementById("chaveDetectada").innerText = "Nenhuma";
Â  Â  document.getElementById("idColRetirada").value = "";
Â  Â  chaveSelecionada = null;

Â  Â  // Para o reconhecimento de voz se estiver ativo
Â  Â  aguardandoRespostaVoz = false;

Â  Â  retomarScanner();
}

// ====================================================================
// FUNÃ‡Ã•ES UTILS (RenderizaÃ§Ã£o, QR Code, UX)
// ====================================================================

function gerarQRCode(texto) {
Â  Â  let area = document.getElementById("qrCodeArea");
Â  Â  area.innerHTML = "";

Â  Â  const qrDiv = document.createElement('div');
Â  Â  qrDiv.id = 'qrcodeCanvas';
Â  Â  area.appendChild(qrDiv);

Â  Â  new QRCode(qrDiv, { 
Â  Â  Â  Â  text: texto, 
Â  Â  Â  Â  width: 200, 
Â  Â  Â  Â  height: 200, 
Â  Â  Â  Â  colorDark : "#fff", 
Â  Â  Â  Â  colorLight : "#1e1e1e", 
Â  Â  Â  Â  correctLevel : QRCode.CorrectLevel.H 
Â  Â  });

Â  Â  setTimeout(() => {
Â  Â  Â  Â  let canvas = qrDiv.querySelector("canvas");
Â  Â  Â  Â  if (canvas) {
Â  Â  Â  Â  Â  Â  let imgData = canvas.toDataURL("image/png");
Â  Â  Â  Â  Â  Â  let link = document.createElement("a");
Â  Â  Â  Â  Â  Â  link.href = imgData;
Â  Â  Â  Â  Â  Â  link.download = texto + "_QRCode.png";
Â  Â  Â  Â  Â  Â  link.innerText = "Baixar QR Code";
Â  Â  Â  Â  Â  Â  link.className = "btn btn-outline-light mt-3";
Â  Â  Â  Â  Â  Â  area.appendChild(link);
Â  Â  Â  Â  }
Â  Â  }, 100);
}

function filtrarChaves() {
Â  Â  let termo = document.getElementById("buscaChaves").value.toLowerCase();
Â  Â  
Â  Â  const chavesFiltradas = chaves
Â  Â  Â  Â  .filter(c => 
Â  Â  Â  Â  Â  Â  c.nome.toLowerCase().includes(termo) || 
Â  Â  Â  Â  Â  Â  c.id.toLowerCase().includes(termo) || 
Â  Â  Â  Â  Â  Â  c.status.toLowerCase().includes(termo)
Â  Â  Â  Â  );

Â  Â  renderizarChaves(chavesFiltradas);
}

function atualizarListas() {
Â  Â  const totalDisponiveis = chaves.filter(c => 
Â  Â  Â  Â  c.status === "DisponÃ­vel" || c.status === "DisponÃ­vel (Offline)"
Â  Â  ).length;
Â  Â  const totalRetiradas = chaves.length - totalDisponiveis;

Â  Â  document.getElementById("totalChaves").innerText = chaves.length;
Â  Â  document.getElementById("chavesDisponiveis").innerText = totalDisponiveis;
Â  Â  document.getElementById("chavesRetiradas").innerText = totalRetiradas;
Â  Â  document.getElementById("totalCol").innerText = colaboradores.length;
Â  Â  document.getElementById("totalHist").innerText = historico.length + historicoPendente.length;

Â  Â  renderizarChaves(chaves);

Â  Â  let colList = document.getElementById("listaColaboradores");
Â  Â  colList.innerHTML = "";
Â  Â  colaboradores.forEach((c, idx) => {
Â  Â  Â  Â  colList.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${c.id}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${c.nome}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-success me-1" onclick="abrirEdicao('colaborador', ${idx})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-edit"></i> Editar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-danger" onclick="solicitarExclusaoColaborador(${idx})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-trash"></i> Excluir
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });

Â  Â  let hist = document.getElementById("listaHistorico");
Â  Â  hist.innerHTML = "";
Â  Â  
Â  Â  const todosRegistros = [...historico, ...historicoPendente];
Â  Â  todosRegistros.sort((a, b) => new Date(b.dataTimestamp) - new Date(a.dataTimestamp));
Â  Â  
Â  Â  todosRegistros.forEach(h => {
Â  Â  Â  Â  const acaoClass = h.acao.includes('RETIRADA') ? 'text-danger' : 'text-success';
Â  Â  Â  Â  const status = h.sincronizado === false ? '<span class="pending-sync">Pendente</span>' : '<span class="badge bg-success">Sincronizado</span>';
Â  Â  Â  Â  
Â  Â  Â  Â  hist.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${h.chave}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${h.colaborador}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="${acaoClass}">${h.acao}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${h.data}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${status}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });
}

function atualizarEstatisticas() {
Â  Â  const totalDisponiveis = chaves.filter(c => 
Â  Â  Â  Â  c.status === "DisponÃ­vel" || c.status === "DisponÃ­vel (Offline)"
Â  Â  ).length;
Â  Â  const totalMovimentacoes = historico.length + historicoPendente.length;

Â  Â  document.getElementById('statChavesTotal').textContent = chaves.length;
Â  Â  document.getElementById('statChavesDisponiveis').textContent = totalDisponiveis;
Â  Â  document.getElementById('statColaboradoresTotal').textContent = colaboradores.length;
Â  Â  document.getElementById('statMovimentacoesTotal').textContent = totalMovimentacoes;
}

function renderizarChaves(chavesParaExibir) {
Â  Â  let lista = document.getElementById("listaChaves");
Â  Â  lista.innerHTML = "";
Â  Â  chavesParaExibir.forEach((c, idx) => {
Â  Â  Â  Â  const indexOriginal = chaves.findIndex(item => item.id === c.id); 

Â  Â  Â  Â  const isOffline = c.status.includes("Offline");
Â  Â  Â  Â  const statusClass = c.status.includes("DisponÃ­vel") ? 'status-disponivel' : 'status-retirada';
Â  Â  Â  Â  const statusBadgeClass = c.status.includes("DisponÃ­vel") ? 'badge text-bg-success' : 'badge text-bg-danger';

Â  Â  Â  Â  let acoesHtml = `
Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-warning me-2" onclick="abrirEdicao('chave', ${indexOriginal})">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-edit"></i>
Â  Â  Â  Â  Â  Â  </button>`;

Â  Â  Â  Â  if (c.status.includes("DisponÃ­vel")) {
Â  Â  Â  Â  Â  Â  acoesHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-info" onclick="iniciarRetiradaRapida('${c.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-arrow-right"></i> Retirar
Â  Â  Â  Â  Â  Â  Â  Â  </button>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  acoesHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-primary" onclick="iniciarDevolucaoRapida('${c.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-reply"></i> Devolver
Â  Â  Â  Â  Â  Â  Â  Â  </button>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  const offlineBadge = isOffline ? ' <span class="badge bg-warning">Offline</span>' : '';

Â  Â  Â  Â  lista.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${c.id}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${c.nome}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="${statusBadgeClass} ${statusClass}">${c.status}</span>${offlineBadge}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${acoesHtml}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });
}

function iniciarRetiradaRapida(chaveId) {
Â  Â  showPage('qr'); 
Â  Â  
Â  Â  const chave = chaves.find(c => c.id === chaveId);
Â  Â  
Â  Â  if (chave) {
Â  Â  Â  Â  chaveSelecionada = chaveId;
Â  Â  Â  Â  document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
Â  Â  Â  Â  document.getElementById("areaConfirmacao").style.display = "block";

Â  Â  Â  Â  document.getElementById("btnConfirmarRetirada").style.display = "block";
Â  Â  Â  Â  document.getElementById("btnDevolverChave").style.display = "none";
Â  Â  Â  Â  document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai RETIRAR";
Â  Â  Â  Â  
Â  Â  Â  Â  pausarScanner();
Â  Â  }
}

function iniciarDevolucaoRapida(chaveId) {
Â  Â  showPage('qr'); 
Â  Â  
Â  Â  const chave = chaves.find(c => c.id === chaveId);
Â  Â  
Â  Â  if (chave) {
Â  Â  Â  Â  chaveSelecionada = chaveId;
Â  Â  Â  Â  document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
Â  Â  Â  Â  document.getElementById("areaConfirmacao").style.display = "block";

Â  Â  Â  Â  document.getElementById("btnConfirmarRetirada").style.display = "none";
Â  Â  Â  Â  document.getElementById("btnDevolverChave").style.display = "block";
Â  Â  Â  Â  document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai DEVOLVER";
Â  Â  Â  Â  
Â  Â  Â  Â  pausarScanner();
Â  Â  }
}

function abrirEdicao(tipo, indexOriginal) {
Â  Â  tipoEdicao = tipo;
Â  Â  itemEditando = indexOriginal;
Â  Â  const item = tipo === 'chave' ? chaves[indexOriginal] : colaboradores[indexOriginal];
Â  Â  
Â  Â  document.getElementById("modalTitulo").innerText = `Editar ${tipo === 'chave' ? 'Chave' : 'Colaborador'} (ID: ${item.id})`;
Â  Â  document.getElementById("modalInput").value = item.nome;
Â  Â  
Â  Â  const modalInstance = new bootstrap.Modal(document.getElementById('modalEditar'));
Â  Â  modalInstance.show();
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>