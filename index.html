<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestÃ£o de Chaves â€” SENAIHUB</title>

    <link rel="manifest" href="/manifest.json">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        /* =======================================
            ESTILOS BASE (DARK MODE)
            ======================================= */
        body {
            background: #121212;
            color: #fff;
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            min-height: 100vh;
            flex-direction: column;
        }
        .content-wrapper {
            margin-left: 250px; /* Margem padrÃ£o para desktop */
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .content {
            padding: 20px;
            flex-grow: 1;
        }
        .card {
            background: #1e1e1e;
            border: 1px solid #333;
            color: #fff;
        }
        input, select, textarea {
            background: #222 !important;
            color: #fff !important;
            border: 1px solid #444 !important;
        }
        input::placeholder {
            color: #aaa !important;
        }
        .btn-custom {
            background: #0d6efd;
            border: none;
            color: #fff;
        }
        .btn-custom:hover {
            background: #0a58ca;
            color: #fff;
        }
        .qr-box canvas {
            display: block;
            margin: 15px auto 0;
            width: 200px !important;
            height: 200px !important;
        }
        .table > :not(caption) > * > * {
            background-color: #1e1e1e;
            color: #fff;
        }

        /* =======================================
            SIDEBAR (BARRA LATERAL)
            ======================================= */
        .sidebar {
            height: 100vh;
            background: #1f1f1f;
            padding-top: 20px;
            position: fixed;
            width: 250px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        .sidebar .logo-container {
            padding: 0 15px 20px;
            text-align: center;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        .sidebar .logo-container img {
            /* Usando o nome do arquivo da sua imagem retangular (192x59) */
            max-width: 100%;
            height: auto;
            max-height: 60px;
        }
        .sidebar a {
            color: #ccc;
            padding: 15px 20px;
            display: block;
            transition: 0.2s;
            font-size: 17px;
            text-decoration: none;
        }
        .sidebar a:hover, .activeMenu {
            background: #333;
            color: #fff !important;
        }

        /* =======================================
            FOOTER (RODAPÃ‰)
            ======================================= */
        .footer {
            background: #1f1f1f;
            color: #ccc;
            text-align: center;
            padding: 15px 20px;
            font-size: 0.9em;
            border-top: 1px solid #333;
            margin-top: auto;
        }


        /* =======================================
            RESPONSIVIDADE (SMARTPHONE/TABLET)
            ======================================= */
        @media (max-width: 768px) {
            /* SIDEBAR: Vira um cabeÃ§alho horizontal e rolÃ¡vel */
            .sidebar {
                width: 100%;
                height: auto;
                position: relative; 
                padding-top: 10px;
                flex-direction: row; 
                overflow-x: auto; 
                white-space: nowrap; 
                border-bottom: 1px solid #333;
            }

            /* Links do menu em linha */
            .sidebar a {
                display: inline-block;
                padding: 10px 15px;
                font-size: 15px;
            }

            /* Logo ocupa a largura total acima dos links */
            .sidebar .logo-container {
                display: block;
                text-align: center;
                width: 100%;
                border-bottom: none;
                margin-bottom: 5px;
            }

            /* CONTEÃšDO: Remove a margem fixa */
            .content-wrapper {
                margin-left: 0;
                padding-top: 10px;
            }
        }
    </style>
</head>

<body onload="iniciarSistema()">

<div class="sidebar">
    <div class="logo-container">
       <img src="logo.png" alt="SENAIHUB Logo">
    </div>
    <a href="#" onclick="showPage('home', event)" class="activeMenu"><i class="fa fa-home"></i> Home</a>
    <a href="#" onclick="showPage('chaves', event)"><i class="fa fa-key"></i> Chaves</a>
    <a href="#" onclick="showPage('colaboradores', event)"><i class="fa fa-users"></i> Colaboradores</a>
    <a href="#" onclick="showPage('historico', event)"><i class="fa fa-clock-rotate-left"></i> HistÃ³rico</a>
    <a href="#" onclick="showPage('qr', event)"><i class="fa fa-qrcode"></i> Retirar por QR Code</a>
</div>


<div class="content-wrapper"> 
    <div class="content">

        <section id="home">
            <h1 class="mb-4">ðŸ”‘ Sistema de GestÃ£o de Chaves</h1>
            <hr/>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-key text-info"></i> Chaves</h3>
                        <p class="mb-0">Total Registradas: <span id="totalChaves" class="fw-bold">0</span></p>
                        <p class="mb-0">DisponÃ­veis: <span id="chavesDisponiveis" class="fw-bold">0</span></p>
                        <p class="mb-0">Retiradas: <span id="chavesRetiradas" class="fw-bold">0</span></p>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-users text-warning"></i> Colaboradores</h3>
                        <p>Total: <span id="totalCol" class="fw-bold">0</span></p>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card p-4">
                        <h3><i class="fa fa-clock-rotate-left text-success"></i> HistÃ³rico</h3>
                        <p>Registros: <span id="totalHist" class="fw-bold">0</span></p>
                    </div>
                </div>
            </div>
        </section>


        <section id="chaves" style="display:none;">
            <h2><i class="fa fa-key text-info"></i> GestÃ£o de Chaves</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Cadastrar Chave</h4>
                <input id="nomeChave" placeholder="Nome da chave (Ex: Sala 101)" class="form-control mt-2">
                <button class="btn btn-custom mt-2" onclick="cadastrarChave()">
                    <i class="fa fa-plus"></i> Cadastrar e Gerar QR Code
                </button>

                <div id="qrCodeArea" class="qr-box text-center mt-3"></div>
            </div>

            <div class="card p-3 mt-4">
                <h4>Buscar Chaves</h4>
                <input id="buscaChaves" class="form-control" placeholder="Pesquisar por ID ou nome..." onkeyup="filtrarChaves()">
            </div>

            <div class="card mt-3 p-3">
                <h4>Lista de Chaves</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Status</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="listaChaves"></tbody>
                    </table>
                </div>
            </div>
        </section>


        <section id="colaboradores" style="display:none;">
            <h2><i class="fa fa-users text-warning"></i> GestÃ£o de Colaboradores</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Cadastrar Colaborador</h4>
                <input id="nomeColaborador" placeholder="Nome do colaborador" class="form-control mt-2">
                <button class="btn btn-custom mt-3" onclick="cadastrarColaborador()">
                    <i class="fa fa-user-plus"></i> Cadastrar
                </button>
                <p class="mt-3 mb-0"><b>Ãšltimo ID gerado:</b> <span id="ultimoColID" class="fw-bold">Nenhum</span></p>
            </div>

            <div class="card mt-4 p-4">
                <h4>Lista de Colaboradores</h4>
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody id="listaColaboradores"></tbody>
                    </table>
                </div>
            </div>
        </section>


        <section id="historico" style="display:none;">
            <h2><i class="fa fa-clock-rotate-left text-success"></i> HistÃ³rico de MovimentaÃ§Ãµes</h2>
            <hr/>

            <div class="card p-3 mb-4">
                <h4>RelatÃ³rios</h4>
                <button class="btn btn-success mt-2" onclick="gerarRelatorioHistorico()">
                    <i class="fa fa-download"></i> Baixar RelatÃ³rio Completo (CSV)
                </button>
            </div>

            <div class="card mt-3 p-3">
                <div class="table-responsive">
                    <table class="table table-dark table-striped mt-3">
                        <thead>
                            <tr>
                                <th>Chave (ID)</th>
                                <th>Colaborador</th>
                                <th>AÃ§Ã£o</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="listaHistorico"></tbody>
                    </table>
                </div>
            </div>
        </section>


        <section id="qr" style="display:none;">
            <h2><i class="fa fa-qrcode text-info"></i> Retirada por QR Code</h2>
            <hr/>

            <div class="card p-4 mt-3">
                <h4>Escanear QR Code da Chave</h4>
                <div id="reader" style="width:300px; margin: 0 auto;"></div>

                <p class="mt-3"><b>Chave detectada:</b> <span id="chaveDetectada" class="fw-bold text-info">Nenhuma</span></p>

                <div id="areaConfirmacao" style="display:none;">
                    <input id="idColRetirada" placeholder="ID do colaborador" class="form-control mt-2">

                    <button id="btnConfirmarRetirada" class="btn btn-success mt-2 w-100" onclick="confirmarRetirada()">
                        <i class="fa fa-check"></i> Confirmar Retirada
                    </button>
                    <button id="btnDevolverChave" class="btn btn-primary mt-2 w-100" onclick="confirmarDevolucao()">
                        <i class="fa fa-reply"></i> Confirmar DevoluÃ§Ã£o
                    </button>
                </div>
            </div>
        </section>

    </div> 

    <footer class="footer">
        <p>&copy; 2025 SENAIHUB. Todos os direitos reservados. Desenvolvido para GestÃ£o de Chaves. Autor: Joelson M. Mendes</p>
        <p>VersÃ£o 1.3.3 (PWA Ready + UX Table + Scanner Fix)</p>
    </footer>

</div> 

<div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <label for="modalInput" class="form-label text-white">Novo Nome:</label>
                <input id="modalInput" class="form-control" placeholder="Digite o novo nome">
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-primary" id="btnSalvarEdicao">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================
// Â  Â  Â  Â  Â  Â  Â  Â  Â  Â SCRIPT DO SISTEMA (com Firebase)
// ============================================================

// VariÃ¡veis Globais
let chaves = [];
let colaboradores = [];
let historico = [];
let contadorChave = 0; 
let contadorColaborador = 0;
let itemEditando = null;
let tipoEdicao = null;
let chaveSelecionada = null;
let html5QrcodeScanner = null;
let db = null; 
let scannerParadoPorSucesso = false; 

/* ==================================
Â  Â  CONFIGURAÃ‡ÃƒO DO FIREBASE (PASSO 6 - Use suas credenciais aqui)
================================== */
const firebaseConfig = {
Â  // SUAS CREDENCIAIS FORNECIDAS
Â  apiKey: "AIzaSyBxtaE405vs6mpuX5ufMu38s9wr3Hn0io8", 
Â  authDomain: "gestao-chaves-app.firebaseapp.com",
Â  projectId: "gestao-chaves-app", 
Â  storageBucket:"gestao-chaves-app.firebasestorage.app",
Â  messagingSenderId: "391255964652",
Â  appId: "1:391255964652:web:6d27bb36bc9ff520349ec9",
};

function iniciarSistema() {
Â  Â  // Inicializa o Firebase e o Firestore
Â  Â  const app = firebase.initializeApp(firebaseConfig);
Â  Â  db = firebase.firestore();

Â  Â  // Inicia os listeners (carregamento em tempo real do Firebase)
Â  Â  carregarChavesFirebase();
Â  Â  carregarColaboradoresFirebase();
Â  Â  carregarHistoricoFirebase();

Â  Â  document.getElementById("btnSalvarEdicao").addEventListener("click", salvarEdicao);
}

// ====================================================================
// 1. FUNÃ‡Ã•ES DE LEITURA
// ====================================================================

function carregarChavesFirebase() {
Â  Â  // onSnapshot: Escuta mudanÃ§as na coleÃ§Ã£o 'chaves' em tempo real
Â  Â  db.collection("chaves").onSnapshot((snapshot) => {
Â  Â  Â  Â  // Mapeia os documentos. O 'idDoc' Ã© o ID interno do Firestore, crucial para UPDATE
Â  Â  Â  Â  chaves = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
Â  Â  Â  Â  
Â  Â  Â  Â  // Recalcula o contador da chave baseando-se no ID mais alto
Â  Â  Â  Â  contadorChave = chaves.reduce((max, c) => {
Â  Â  Â  Â  Â  Â  const num = parseInt(c.id.split('-')[1]);
Â  Â  Â  Â  Â  Â  return num > max ? num : max;
Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  
Â  Â  Â  Â  atualizarListas(); 
Â  Â  }, error => {
Â  Â  Â  Â  console.error("Erro ao carregar chaves:", error);
Â  Â  });
}

function carregarColaboradoresFirebase() {
Â  Â  db.collection("colaboradores").onSnapshot((snapshot) => {
Â  Â  Â  Â  colaboradores = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));

Â  Â  Â  Â  // Recalcula o contador do colaborador baseando-se no ID mais alto
Â  Â  Â  Â  contadorColaborador = colaboradores.reduce((max, c) => {
Â  Â  Â  Â  Â  Â  const num = parseInt(c.id);
Â  Â  Â  Â  Â  Â  return num > max ? num : max;
Â  Â  Â  Â  }, 0);
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById("ultimoColID").innerText = contadorColaborador > 0 ? contadorColaborador.toString().padStart(2, "0") : "Nenhum";
Â  Â  Â  Â  atualizarListas();
Â  Â  }, error => {
Â  Â  Â  Â  console.error("Erro ao carregar colaboradores:", error);
Â  Â  });
}

function carregarHistoricoFirebase() {
Â  Â  // Ordena por dataTimestamp para garantir que o histÃ³rico mais novo apareÃ§a primeiro
Â  Â  db.collection("historico").orderBy("dataTimestamp", "desc").onSnapshot((snapshot) => {
Â  Â  Â  Â  historico = snapshot.docs.map(doc => ({ idDoc: doc.id, ...doc.data() }));
Â  Â  Â  Â  atualizarListas();
Â  Â  }, error => {
Â  Â  Â  Â  console.error("Erro ao carregar histÃ³rico:", error);
Â  Â  });
}

// ====================================================================
// 2. FUNÃ‡Ã•ES DE ESCRITA E CRIAÃ‡ÃƒO
// ====================================================================

function salvarMovimentacao(chave, colaborador, acao) {
Â  Â  db.collection("historico").add({
Â  Â  Â  Â  chave: chave.id,
Â  Â  Â  Â  colaborador: colaborador.nome,
Â  Â  Â  Â  acao: acao,
Â  Â  Â  Â  data: new Date().toLocaleString('pt-BR'),
Â  Â  Â  Â  dataTimestamp: firebase.firestore.FieldValue.serverTimestamp() 
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao salvar histÃ³rico:", error);
Â  Â  });
}

function cadastrarChave() {
Â  Â  const nome = document.getElementById("nomeChave").value.trim();
Â  Â  if (!nome) return alert("Digite o nome da chave.");

Â  Â  const novoContador = contadorChave + 1;
Â  Â  const id = "CH-" + novoContador.toString().padStart(3, "0"); 

Â  Â  // SALVA NO FIREBASE (add)
Â  Â  db.collection("chaves").add({
Â  Â  Â  Â  id, 
Â  Â  Â  Â  nome, 
Â  Â  Â  Â  status: "DisponÃ­vel" 
Â  Â  })
Â  Â  .then(() => {
Â  Â  Â  Â  document.getElementById("nomeChave").value = "";
Â  Â  Â  Â  gerarQRCode(id);
Â  Â  Â  Â  alert(`Chave ${id} cadastrada com sucesso!`);
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao cadastrar chave:", error);
Â  Â  Â  Â  alert("Erro ao cadastrar chave. Verifique o console.");
Â  Â  });
}

function cadastrarColaborador() {
Â  Â  const nome = document.getElementById("nomeColaborador").value.trim();
Â  Â  if (!nome) return alert("Digite o nome do colaborador.");

Â  Â  const novoContador = contadorColaborador + 1;
Â  Â  let id = novoContador.toString().padStart(2, "0");

Â  Â  // SALVA NO FIREBASE (add)
Â  Â  db.collection("colaboradores").add({ 
Â  Â  Â  Â  id, 
Â  Â  Â  Â  nome 
Â  Â  })
Â  Â  .then(() => {
Â  Â  Â  Â  document.getElementById("nomeColaborador").value = "";
Â  Â  Â  Â  alert(`Colaborador ${id} - ${nome} cadastrado com sucesso!`);
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao cadastrar colaborador:", error);
Â  Â  Â  Â  alert("Erro ao cadastrar colaborador. Verifique o console.");
Â  Â  });
}

// ====================================================================
// FUNÃ‡Ã•ES DE RETIRADA E DEVOLUÃ‡ÃƒO (Corrigidas e Funcionais)
// ====================================================================
function confirmarRetirada() {
Â  Â  if (!chaveSelecionada) return alert("Erro: Nenhuma chave foi escaneada.");
Â  Â  
Â  Â  const idCol = document.getElementById("idColRetirada").value.trim();
Â  Â  if (!idCol) return alert("Digite o ID do colaborador.");

Â  Â  const colab = colaboradores.find(c => c.id === idCol);
Â  Â  if (!colab) return alert("Colaborador nÃ£o encontrado.");

Â  Â  const chave = chaves.find(c => c.id === chaveSelecionada);
Â  Â  if (!chave) return alert("Chave nÃ£o encontrada no sistema.");

Â  Â  // Verifica se a chave estÃ¡ DISPONÃVEL antes de retirar
Â  Â  if (chave.status !== "DisponÃ­vel") {
Â  Â  Â  Â  alert(`Erro: Esta chave jÃ¡ estÃ¡ ${chave.status}. Use a DevoluÃ§Ã£o.`);
Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  // ATUALIZA NO FIREBASE (muda o status para Retirada por Nome do Colaborador)
Â  Â  db.collection("chaves").doc(chave.idDoc).update({
Â  Â  Â  Â  status: "Retirada por " + colab.nome
Â  Â  })
Â  Â  .then(() => {
Â  Â  Â  Â  salvarMovimentacao(chave, colab, "RETIRADA");
Â  Â  Â  Â  alert(`Sucesso! Chave ${chave.id} retirada por ${colab.nome}.`);
Â  Â  Â  Â  reiniciarScanner();
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao retirar chave:", error);
Â  Â  Â  Â  alert("Erro ao retirar chave. Tente novamente.");
Â  Â  });
}

function confirmarDevolucao() {
Â  Â  if (!chaveSelecionada) return alert("Erro: Nenhuma chave foi escaneada.");
Â  Â  
Â  Â  const idCol = document.getElementById("idColRetirada").value.trim();
Â  Â  if (!idCol) return alert("Digite o ID do colaborador que estÃ¡ devolvendo.");

Â  Â  const colab = colaboradores.find(c => c.id === idCol);
Â  Â  if (!colab) return alert("Colaborador nÃ£o encontrado.");

Â  Â  const chave = chaves.find(c => c.id === chaveSelecionada);
Â  Â  if (!chave) return alert("Chave nÃ£o encontrada no sistema.");

Â  Â  // Verifica se a chave estÃ¡ RETIRADA (o status Ã© diferente de DisponÃ­vel)
Â  Â  if (chave.status === "DisponÃ­vel") {
Â  Â  Â  Â  alert("Erro: Esta chave jÃ¡ estÃ¡ disponÃ­vel.");
Â  Â  Â  Â  reiniciarScanner();
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  // Alerta se quem estÃ¡ devolvendo nÃ£o Ã© quem retirou (opcional)
Â  Â  if (!chave.status.includes(colab.nome)) {
Â  Â  Â  Â  if (!confirm(`AtenÃ§Ã£o: A chave foi retirada por ${chave.status.split(' por ')[1]}. Deseja confirmar a devoluÃ§Ã£o por ${colab.nome} mesmo assim?`)) {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // ATUALIZA NO FIREBASE (muda o status de volta para DisponÃ­vel)
Â  Â  db.collection("chaves").doc(chave.idDoc).update({
Â  Â  Â  Â  status: "DisponÃ­vel"
Â  Â  })
Â  Â  .then(() => {
Â  Â  Â  Â  salvarMovimentacao(chave, colab, "DEVOLUÃ‡ÃƒO");
Â  Â  Â  Â  alert(`Sucesso! Chave ${chave.id} devolvida por ${colab.nome}.`);
Â  Â  Â  Â  reiniciarScanner();
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao devolver chave:", error);
Â  Â  Â  Â  alert("Erro ao devolver chave. Tente novamente.");
Â  Â  });
}
// ====================================================================
// FIM DAS FUNÃ‡Ã•ES DE RETIRADA E DEVOLUÃ‡ÃƒO
// ====================================================================

function salvarEdicao() {
Â  Â  const novoNome = document.getElementById("modalInput").value.trim();
Â  Â  if (!novoNome) return alert("Digite um nome vÃ¡lido.");

Â  Â  let colecao, idDoc, tipo;
Â  Â  
Â  Â  if (tipoEdicao === "chave") {
Â  Â  Â  Â  const chaveEditada = chaves[itemEditando];
Â  Â  Â  Â  colecao = "chaves";
Â  Â  Â  Â  idDoc = chaveEditada.idDoc;
Â  Â  Â  Â  tipo = "Chave";
Â  Â  } else {
Â  Â  Â  Â  const colabEditado = colaboradores[itemEditando];
Â  Â  Â  Â  colecao = "colaboradores";
Â  Â  Â  Â  idDoc = colabEditado.idDoc;
Â  Â  Â  Â  tipo = "Colaborador";
Â  Â  }

Â  Â  // ATUALIZA NO FIREBASE (doc().update)
Â  Â  db.collection(colecao).doc(idDoc).update({
Â  Â  Â  Â  nome: novoNome
Â  Â  })
Â  Â  .then(() => {
Â  Â  Â  Â  alert(`${tipo} atualizado para "${novoNome}".`);
Â  Â  Â  Â  const modalElement = document.getElementById("modalEditar");
Â  Â  Â  Â  const modalInstance = bootstrap.Modal.getInstance(modalElement);
Â  Â  Â  Â  if (modalInstance) modalInstance.hide();
Â  Â  })
Â  Â  .catch(error => {
Â  Â  Â  Â  console.error("Erro ao salvar ediÃ§Ã£o:", error);
Â  Â  Â  Â  alert("Erro ao salvar ediÃ§Ã£o.");
Â  Â  });
}

// ====================================================================
// 3. FUNÃ‡Ã•ES UTILS (RenderizaÃ§Ã£o, QR Code, Scanner, UX)
// ====================================================================

function showPage(page, event) {
Â  Â  if(event) event.preventDefault(); 

Â  Â  document.querySelectorAll("section").forEach(s => s.style.display = "none");
Â  Â  document.getElementById(page).style.display = "block";

Â  Â  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("activeMenu"));
Â  Â  if(event) event.currentTarget.classList.add("activeMenu");
Â  Â  else document.querySelector(`.sidebar a[onclick*="${page}"]`).classList.add("activeMenu");

Â  Â  // >>>>>>>>>> LÃ“GICA DO SCANNER ATUALIZADA (com OtimizaÃ§Ã£o de ResoluÃ§Ã£o) <<<<<<<<<<
Â  Â  if (page === 'qr') {
Â  Â  Â  Â  // Se o scanner nunca foi iniciado OU se foi parado completamente por sucesso
Â  Â  Â  Â  if (!html5QrcodeScanner || scannerParadoPorSucesso) {
Â  Â  Â  Â  Â  Â  Â html5QrcodeScanner = new Html5QrcodeScanner(
Â  Â  Â  Â  Â  Â  Â  Â  "reader", 
Â  Â  Â  Â  Â  Â  Â  Â  { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fps: 10, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  qrbox: 200, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  disableFlip: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  facingMode: "environment",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // >>>>> AJUSTE CRUCIAL: OtimizaÃ§Ã£o de ResoluÃ§Ã£o para Mobile <<<<<
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoConstraints: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  facingMode: { ideal: "environment" }, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  width: { max: 480 },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height: { max: 480 }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  html5QrcodeScanner.render(onScanSuccess, onScanError);
Â  Â  Â  Â  Â  Â  scannerParadoPorSucesso = false; // Reseta a flag
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â // Se o scanner estava apenas pausado, ele continua
Â  Â  Â  Â  Â  Â  Â html5QrcodeScanner.resume();
Â  Â  Â  Â  }
Â  Â  Â  Â  // Limpa os campos ao entrar na pÃ¡gina QR
Â  Â  Â  Â  document.getElementById("areaConfirmacao").style.display = "none";
Â  Â  Â  Â  document.getElementById("chaveDetectada").innerText = "Nenhuma";
        document.getElementById("idColRetirada").value = "";
Â  Â  } else if (html5QrcodeScanner) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Se estiver saindo da pÃ¡gina QR, pausa o scanner para economizar recursos
Â  Â  Â  Â  Â  Â  html5QrcodeScanner.pause();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.warn("Scanner nÃ£o conseguiu parar:", e);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  // >>>>>>>>>> FIM DA LÃ“GICA DO SCANNER ATUALIZADA <<<<<<<<<<

Â  Â  if (page === 'colaboradores') {
Â  Â  Â  Â  document.getElementById("ultimoColID").innerText = contadorColaborador > 0 ? contadorColaborador.toString().padStart(2, "0") : "Nenhum";
Â  Â  }
}

function gerarQRCode(texto) {
Â  Â  let area = document.getElementById("qrCodeArea");
Â  Â  area.innerHTML = "";

Â  Â  const qrDiv = document.createElement('div');
Â  Â  qrDiv.id = 'qrcodeCanvas';
Â  Â  area.appendChild(qrDiv);

Â  Â  new QRCode(qrDiv, { text: texto, width: 200, height: 200, colorDark : "#fff", colorLight : "#1e1e1e", correctLevel : QRCode.CorrectLevel.H });

Â  Â  setTimeout(() => {
Â  Â  Â  Â  let canvas = qrDiv.querySelector("canvas");
Â  Â  Â  Â  if (canvas) {
Â  Â  Â  Â  Â  Â  let imgData = canvas.toDataURL("image/png");
Â  Â  Â  Â  Â  Â  let link = document.createElement("a");
Â  Â  Â  Â  Â  Â  link.href = imgData;
Â  Â  Â  Â  Â  Â  link.download = texto + "_QRCode.png";
Â  Â  Â  Â  Â  Â  link.innerText = "Baixar QR Code";
Â  Â  Â  Â  Â  Â  link.className = "btn btn-outline-light mt-3";
Â  Â  Â  Â  Â  Â  area.appendChild(link);
Â  Â  Â  Â  }
Â  Â  }, 100);
}

function filtrarChaves() {
Â  Â  let termo = document.getElementById("buscaChaves").value.toLowerCase();
Â  Â  
Â  Â  const chavesFiltradas = chaves
Â  Â  Â  Â  .filter(c => 
Â  Â  Â  Â  Â  Â  c.nome.toLowerCase().includes(termo) || 
Â  Â  Â  Â  Â  Â  c.id.toLowerCase().includes(termo) || 
Â  Â  Â  Â  Â  Â  c.status.toLowerCase().includes(termo)
Â  Â  Â  Â  );

Â  Â  renderizarChaves(chavesFiltradas);
}

function atualizarListas() {
Â  Â  // EstatÃ­sticas do Dashboard
Â  Â  const totalDisponiveis = chaves.filter(c => c.status === "DisponÃ­vel").length;
Â  Â  const totalRetiradas = chaves.length - totalDisponiveis;

Â  Â  document.getElementById("totalChaves").innerText = chaves.length;
Â  Â  document.getElementById("chavesDisponiveis").innerText = totalDisponiveis;
Â  Â  document.getElementById("chavesRetiradas").innerText = totalRetiradas;
Â  Â  document.getElementById("totalCol").innerText = colaboradores.length;
Â  Â  document.getElementById("totalHist").innerText = historico.length;

Â  Â  // Lista de Chaves
Â  Â  renderizarChaves(chaves);

Â  Â  // Lista de Colaboradores
Â  Â  let colList = document.getElementById("listaColaboradores");
Â  Â  colList.innerHTML = "";
Â  Â  colaboradores.forEach((c, idx) => {
Â  Â  Â  Â  colList.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${c.id}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${c.nome}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-warning" onclick="abrirEdicao('colaborador', ${idx})">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-edit"></i> Editar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });

Â  Â  // Lista de HistÃ³rico
Â  Â  let hist = document.getElementById("listaHistorico");
Â  Â  hist.innerHTML = "";
Â  Â  // O histÃ³rico jÃ¡ vem ordenado por dataTimestamp, apenas o renderiza
Â  Â  historico.forEach(h => {
Â  Â  Â  Â  const acaoClass = h.acao.includes('RETIRADA') ? 'text-danger' : 'text-success';
Â  Â  Â  Â  hist.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${h.chave}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${h.colaborador}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td class="${acaoClass}">${h.acao}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${h.data}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });
}

function renderizarChaves(chavesParaExibir) {
Â  Â  let lista = document.getElementById("listaChaves");
Â  Â  lista.innerHTML = "";
Â  Â  chavesParaExibir.forEach((c, idx) => {
Â  Â  Â  Â  // Encontra o Ã­ndice original no array 'chaves' para a ediÃ§Ã£o
Â  Â  Â  Â  const indexOriginal = chaves.findIndex(item => item.id === c.id); 

Â  Â  Â  Â  let statusClass = c.status === "DisponÃ­vel" ? 'badge text-bg-success' : 'badge text-bg-danger';

Â  Â  Â  Â  let acoesHtml = `
Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-warning me-2" onclick="abrirEdicao('chave', ${indexOriginal})">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-edit"></i>
Â  Â  Â  Â  Â  Â  </button>`;

Â  Â  Â  Â  if (c.status === "DisponÃ­vel") {
Â  Â  Â  Â  Â  Â  // Mostra o botÃ£o RETIRAR se a chave estiver disponÃ­vel
Â  Â  Â  Â  Â  Â  acoesHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-info" onclick="iniciarRetiradaRapida('${c.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-arrow-right"></i> Retirar
Â  Â  Â  Â  Â  Â  Â  Â  </button>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // Mostra o botÃ£o DEVOLVER se a chave NÃƒO estiver disponÃ­vel (estiver retirada)
Â  Â  Â  Â  Â  Â  acoesHtml += `
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-sm btn-primary" onclick="iniciarDevolucaoRapida('${c.id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa fa-reply"></i> Devolver
Â  Â  Â  Â  Â  Â  Â  Â  </button>`;
Â  Â  Â  Â  }


Â  Â  Â  Â  lista.innerHTML += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${c.id}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${c.nome}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td><span class="${statusClass}">${c.status}</span></td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${acoesHtml}</td>
Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  });
}

// >>>>>>>>>> NOVAS FUNÃ‡Ã•ES DE UX (Retirada/DevoluÃ§Ã£o RÃ¡pida pela Tabela) <<<<<<<<<<
function iniciarRetiradaRapida(chaveId) {
    // 1. Muda para a pÃ¡gina de QR Code (sem interromper o histÃ³rico de navegaÃ§Ã£o)
    showPage('qr'); 
    
    // 2. Encontra a chave e preenche os campos do scanner
    const chave = chaves.find(c => c.id === chaveId);
    
    if (chave) {
        chaveSelecionada = chaveId;
        document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
        document.getElementById("areaConfirmacao").style.display = "block";

        // Prepara para Retirada
        document.getElementById("btnConfirmarRetirada").style.display = "block";
        document.getElementById("btnDevolverChave").style.display = "none";
        document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai RETIRAR";
    }
}

function iniciarDevolucaoRapida(chaveId) {
    // 1. Muda para a pÃ¡gina de QR Code (sem interromper o histÃ³rico de navegaÃ§Ã£o)
    showPage('qr'); 
    
    // 2. Encontra a chave e preenche os campos do scanner
    const chave = chaves.find(c => c.id === chaveId);
    
    if (chave) {
        chaveSelecionada = chaveId;
        document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
        document.getElementById("areaConfirmacao").style.display = "block";

        // Prepara para DevoluÃ§Ã£o
        document.getElementById("btnConfirmarRetirada").style.display = "none";
        document.getElementById("btnDevolverChave").style.display = "block";
        document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai DEVOLVER";
    }
}
// >>>>>>>>>> FIM DAS NOVAS FUNÃ‡Ã•ES DE UX <<<<<<<<<<


function onScanSuccess(decodedText) {
Â  Â  // 1. TENTATIVA DE PARAR O FLUXO DE VÃDEO COMPLETAMENTE
Â  Â  if (html5QrcodeScanner) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // ESSA LINHA Ã‰ CRUCIAL PARA DESLIGAR A CÃ‚MERA
Â  Â  Â  Â  Â  Â  html5QrcodeScanner.stop(); 
Â  Â  Â  Â  Â  Â  scannerParadoPorSucesso = true; // Define a flag como true
Â  Â  Â  Â  } catch (e) { 
Â  Â  Â  Â  Â  Â  console.warn("Scanner nÃ£o conseguiu parar:", e); 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  const chave = chaves.find(c => c.id === decodedText);

Â  Â  if (!chave) {
Â  Â  Â  Â  document.getElementById("chaveDetectada").innerText = `ERRO: Chave '${decodedText}' nÃ£o encontrada.`;
Â  Â  Â  Â  document.getElementById("areaConfirmacao").style.display = "none";
Â  Â  Â  Â  alert("QR Code lido, mas nenhuma chave correspondente foi encontrada no sistema.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  chaveSelecionada = decodedText;
Â  Â  document.getElementById("chaveDetectada").innerText = `${chave.id} - ${chave.nome} (${chave.status})`;
Â  Â  document.getElementById("areaConfirmacao").style.display = "block";

Â  Â  // LÃ³gica CORRIGIDA para mostrar Retirar ou Devolver
Â  Â  if (chave.status === "DisponÃ­vel") {
Â  Â  Â  Â  document.getElementById("btnConfirmarRetirada").style.display = "block";
Â  Â  Â  Â  document.getElementById("btnDevolverChave").style.display = "none";
Â  Â  Â  Â  document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai RETIRAR";
Â  Â  } else {
Â  Â  Â  Â  document.getElementById("btnConfirmarRetirada").style.display = "none";
Â  Â  Â  Â  document.getElementById("btnDevolverChave").style.display = "block";
Â  Â  Â  Â  document.getElementById("idColRetirada").placeholder = "ID do colaborador que vai DEVOLVER";
Â  Â  }
}

function onScanError(errorMessage) {
Â  Â  // console.log(errorMessage); // Comentado para nÃ£o poluir o console
}

function reiniciarScanner() {
Â  Â  // Se o scanner jÃ¡ estÃ¡ completamente parado (via stop()), 
Â  Â  // recarrega a pÃ¡gina 'qr' para iniciar do zero.
Â  Â  if (scannerParadoPorSucesso) {
Â  Â  Â  Â  showPage('qr'); 
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  
Â  Â  // Limpar campos e esconder botÃµes
Â  Â  document.getElementById("areaConfirmacao").style.display = "none";
Â  Â  document.getElementById("chaveDetectada").innerText = "Nenhuma";
Â  Â  document.getElementById("idColRetirada").value = "";
Â  Â  chaveSelecionada = null;

Â  Â  // Reinicia a leitura, se o scanner ainda estiver rodando (pause/resume)
Â  Â  if (html5QrcodeScanner) {
Â  Â  Â  Â  html5QrcodeScanner.resume();
Â  Â  }
}

function abrirEdicao(tipo, indexOriginal) {
    tipoEdicao = tipo;
    itemEditando = indexOriginal;
    const item = tipo === 'chave' ? chaves[indexOriginal] : colaboradores[indexOriginal];
    
    document.getElementById("modalTitulo").innerText = `Editar ${tipo === 'chave' ? 'Chave' : 'Colaborador'} (ID: ${item.id})`;
    document.getElementById("modalInput").value = item.nome;
    
    const modalInstance = new bootstrap.Modal(document.getElementById('modalEditar'));
    modalInstance.show();
}

// FunÃ§Ãµes do RelatÃ³rio (nÃ£o modificadas)
function gerarRelatorioHistorico() {
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Chave ID,Colaborador,Acao,Data\n";

    historico.forEach(h => {
        let row = `${h.chave},"${h.colaborador}",${h.acao},${h.data}\n`;
        csvContent += row;
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "historico_chaves.csv");
    document.body.appendChild(link); // Required for Firefox
    link.click();
    link.remove();
    alert("RelatÃ³rio CSV gerado com sucesso!");
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>